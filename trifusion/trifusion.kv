#:kivy 1.9.0
#:import Factory kivy.factory.Factory
#:import sep os.sep
#:import os os
#:import multiprocessing multiprocessing
#:import ObjectProperty kivy.properties.ObjectProperty
#:import ToggleButton kivy.uix.togglebutton.ToggleButton
#:import StringProperty kivy.properties.StringProperty
#:import AnchorLayout kivy.uix.anchorlayout.AnchorLayout
#:import ListProperty kivy.properties.ListProperty
#:import Clock kivy.clock.Clock

#:import load_group_files trifusion.data.resources.background_tasks.load_group_files
#:import orto_update_filters trifusion.data.resources.background_tasks.orto_update_filters
#:import TreeViewM trifusion.data.resources.custom_widgets.TreeViewM
#:import tm trifusion.data.resources.theme.default


<ShowcaseScreen>:
    BoxLayout:
        #do_scroll_x: False
        #do_scroll_y: False# if root.fullscreen else (content.height > root.height - dp(16))
        AnchorLayout:
            size_hint_y: None
            height: root.height# if root.fullscreen else max(root.height, content.height)
            GridLayout:
                id: content
                cols: 1

[FileListEntryM@FloatLayout+TreeViewNode]:
    locked: False
    entries: []
    path: ctx.path
    # FIXME: is_selected is actually a read_only treeview property. In this
    # case, however, we're doing this because treeview only has single-selection
    # hardcoded in it. The fix to this would be to update treeview to allow
    # multiple selection.
    selected: self.path in ctx.controller().selection
    multiselect: ctx.controller().multiselect

    orientation: 'horizontal'
    size_hint_y: None
    height: '48dp' if dp(1) > 1 else '24dp'
    # Don't allow expansion of the ../ node
    is_leaf: not ctx.isdir or ctx.name.endswith('..' + ctx.sep) or self.locked
    on_touch_down: self.collide_point(*args[1].pos) and ctx.controller().entry_touched(self, args[1])
    on_touch_up: self.collide_point(*args[1].pos) and ctx.controller().entry_released(self, args[1])
#    BoxLayout:
#        pos: root.pos
#        canvas.before:
#            Color:
#                rgba: (.4, .4, .4, .5) if root.selected and root.multiselect else (0,0,0,0)
#            Rectangle:
#                pos: self.pos
#                size: self.size
    Label:
        id: filename
        pos: root.pos
        width: (self.texture_size[0] + dp(4)) if self.texture_size else dp(10)
        halign: 'left'
        valign: "middle"
        text_size: self.size
        shorten: True
        text: ctx.name
        canvas.after:
            Color:
                rgba: (.4, .4, .4, .4) if root.selected and root.multiselect else (0,0,0,0)
            Rectangle:
                pos: self.pos
                size: self.size
#        Label:
#            text_size: self.width, None
#            size_hint_x: None
#            halign: 'right'
#            valign: "middle"
#            text_size: self.size
#            text: '{}'.format(ctx.get_nice_size())

<-ModalView>
    canvas.before:
        Color:
            rgba: root.background_color[:3] + [root.background_color[-1] * self._anim_alpha]
        Rectangle:
            size: self._window.size if self._window else (0, 0)

        Color:
            rgb: 1, 1, 1
        BorderImage:
            source: root.background
            border: root.border
            pos: self.pos
            size: self.size

<Popup>:
    _container: container
    canvas:
        Color:
            rgba: tm.c_popup_background
        Rectangle:
            pos: self.pos
            size: self.size
    GridLayout:
        padding: '12dp'
        cols: 1
        size_hint: None, None
        pos: root.pos
        size: root.size

        Label:
            text: root.title
            color: root.title_color
            size_hint_y: None
            height: self.texture_size[1] + dp(16)
            text_size: self.width - dp(16), None
            font_size: root.title_size
            font_name: root.title_font
            halign: root.title_align

        Widget:
            size_hint_y: None
            height: dp(4)
            canvas:
                Color:
                    rgba: root.separator_color
                Rectangle:
                    pos: self.x, self.y + root.separator_height / 2.
                    size: self.width, root.separator_height

        BoxLayout:
            id: container

<-FileChooserListLayout>:
    on_entry_added: treeview.add_node(args[1])
    on_entries_cleared: treeview.root.nodes = []
    on_subentry_to_entry: not args[2].locked and treeview.add_node(args[1], args[2])
    on_remove_subentry: args[2].nodes = []
    _ENTRY_TEMPLATE: "FileListEntryM"
    multiselect: False
    BoxLayout:
        pos: root.pos
        size: root.size
        size_hint: None, None
        orientation: 'vertical'
        BoxLayout:
            size_hint_y: None
            height: '30dp'
            orientation: 'horizontal'
            Widget:
                # Just for spacing
                width: '10dp'
                size_hint_x: None
            Label:
                text: 'Name'
                text_size: self.size
                halign: 'left'
                bold: True
            Widget:
                # Just for spacing
                width: '10dp'
                size_hint_x: None
        ScrollView:
            id: scrollview
            do_scroll_x: False
            bar_width: 10
            scroll_type: ["bars", "content"]
            on_scroll_y:
                root.controller.on_scroll_limit(self.scroll_y)
            Scatter:
                do_rotation: False
                do_scale: False
                do_translation: False
                size: treeview.size
                size_hint_y: None
                TreeViewM:
                    id: treeview
                    multiselect: root.multiselect
                    hide_root: True
                    size_hint_y: None
                    width: scrollview.width
                    height: self.minimum_height
                    #on_node_expand: root.controller.entry_subselect(args[1])
                    #on_node_collapse: root.controller.close_subselection(args[1]); root.controller.selection = [args[1].path]
                    on_node_expand: root.controller.open_entry(args[1])

<-CheckBox>:
    _checkbox_state_image:
        self.background_checkbox_down \
        if self.active else self.background_checkbox_normal
    _checkbox_disabled_image:
        self.background_checkbox_disabled_down \
        if self.active else self.background_checkbox_disabled_normal
    _radio_state_image:
        self.background_radio_down \
        if self.active else self.background_radio_normal
    _radio_disabled_image:
        self.background_radio_disabled_down \
        if self.active else self.background_radio_disabled_normal
    _checkbox_image:
        self._checkbox_disabled_image \
        if self.disabled else self._checkbox_state_image
    _radio_image:
        self._radio_disabled_image \
        if self.disabled else self._radio_state_image
    canvas.after:
        Color:
            rgba: 1, 1, 1
        Rectangle:
            source: self._radio_image if self.group else self._checkbox_image
            size: sp(32), sp(32)
            pos: int(self.center_x - sp(16)), int(self.center_y - sp(16))
    canvas.before:
        Color:
            rgba: 1, 1, 1, .7
        Line:
            width: .5
            cap: "none"
            close: True
            rectangle: self.center_x - sp(8), self.center_y - sp(8), sp(16) , sp(16)

#===============================================================================
# GENERAL USAGE
#===============================================================================

<TFSpinnerOpt@SpinnerOption>:
    bold: True
    background_normal: "data/backgrounds/spinner_opt.png"

<TFButtonOff>:
    bold: True
    halign: "center"
    valign: "middle"
    text_size: self.size
    background_normal: "data/backgrounds/bt_process_off.png"
    background_down: "data/backgrounds/bt_process.png"
    opacity: .3 if self.disabled else 1
    line_clr: (0.216, 0.67, 0.784, 1)
    StackLayout:
        canvas.after:
            Color:
                rgb: root.line_clr
            Line:
                width: 1.1
                rectangle: root.x,root.y,root.width,root.height

<TFButton>:
    bold: True
    halign: "center"
    valign: "middle"
    text_size: self.size
    shorten: True
    shorten_from: "right"
    background_normal: "data/backgrounds/bt_process.png"
    background_down: "data/backgrounds/bt_process_off.png"
    opacity: .3 if self.disabled else 1
    line_clr: (0.216, 0.67, 0.784, 1)
    StackLayout:
        size_hint_x: None
        width: 0
        canvas.after:
            Color:
                rgb: root.line_clr
            Line:
                joint: "miter"
                cap: "square"
                close: True
                width: 1.05
                rectangle: root.x+2,root.y+2,root.width-4,root.height-4

<TFStatsButton@ToggleButton>:
    size_hint_y: None
    height: 45
    bold: True
    background_normal: "data/backgrounds/bt_process.png"
    background_down: "data/backgrounds/bt_process.png"
    background_disabled_normal: "data/backgrounds/bt_process.png"
    background_disabled_down: "data/backgrounds/bt_process.png"
    disabled_color: 1,1,1,1

<TGToggleButton>:
    bold: True
    halign: "center"
    size_hint_y: None
    background_normal: "data/backgrounds/bt_process_off.png"
    background_down: "data/backgrounds/bt_process.png"
    StackLayout:
        canvas.after:
            Color:
                rgb: (0.216, 0.67, 0.784, 1)
            Line:
                joint: "miter"
                cap: "square"
                close: True
                width: .9
                rectangle: root.x+2,root.y+2,root.width-4,root.height-4

<ShortenButton>:
    background_normal: "data/backgrounds/bt_process.png"
    background_down: "data/backgrounds/bt_process_off.png"
    bold: True
    halign: "center"
    valign: "middle"
    text_size: self.size
    shorten: True
    shorten_from: "right"

<ShortenToggleButton>:
    background_normal: "data/backgrounds/bt_process.png"
    background_down: "data/backgrounds/bt_process_off.png"
    bold: True
    halign: "center"
    valign: "middle"
    text_size: self.size
    shorten: True
    shorten_from: "right"

<TGOKToggleButton@ToggleButton>:
    bold: True
    halign: "center"
    size_hint_y: None
    background_normal: "data/backgrounds/bt_process_off.png"
    background_down: "data/backgrounds/bt_process.png"
    StackLayout:
        canvas.after:
            Color:
                rgb: (0.216, 0.67, 0.784, 1)
            Line:
                width: 1.1
                cap: "round"
                joint: "round"
                rectangle: root.x,root.y,root.width,root.height

<TFOKButon@Button>:
    background_normal: "data/backgrounds/bt_process_off.png"
    background_down: "data/backgrounds/bt_process.png"
    bold: True
    StackLayout:
        canvas.after:
            Color:
                rgb: (0.216, 0.67, 0.784, 1)
            Line:
                width: 1.1
                cap: "round"
                joint: "round"
                rectangle: root.x,root.y,root.width,root.height

<FixButton>:
    bold: True
    text: "Fix it"
    background_normal: ""
    background_color: 0,0,0,0
    StackLayout:
        canvas.after:
            Color:
                rgb: (1,1,1,1)
            Line:
                cap: "none"
                joint: "round"
                close: True
                width: 1.2
                rectangle: root.x,root.y, root.width, root.height

<DialogMCLFix>:
    orientation: "vertical"
    padding: 10
    spacing: 10
    Label:
        halign: "justify"
        valign: "middle"
        text_size: self.size
        markup: True
        text: "The MCL software is either not installed or reachable by TriFusion. Please ensure that you have downloaded and installed the MCL software from the website:\n\n[ref=http://micans.org/mcl/][b][color=#37abc8ff]http://micans.org/mcl/[/b][/color][/ref]\n\nWhen MCL is installed, provide the executable file via the button bellow."
        on_ref_press:
            import webbrowser
            webbrowser.open(args[1])
    AnchorLayout:
        size_hint_y: None
        height: 40
        TFButton:
            size_hint: None, None
            size: 200, 40
            text: "Search MCL executable"
            on_release:
                app.dialog_filechooser("mcl_fix", 2)
                root.cancel()

<DialogUSEARCHFix>:
    orientation: "vertical"
    padding: 10
    spacing: 10
    Label:
        halign: "justify"
        valign: "middle"
        text_size: self.size
        markup: True
        text: "The USEARCH software is either not installed or reachable by TriFusion. Please ensure that you have downloaded and installed the USEARCH software from the website:\n\n[ref=http://www.drive5.com/usearch/download.html][b][color=#37abc8ff]http://www.drive5.com/usearch/download.html[/b][/color][/ref]\n\nIf USEARCH is already installed, provide the executable file via the button bellow."
        on_ref_press:
            import webbrowser
            webbrowser.open(args[1])
    AnchorLayout:
        size_hint_y: None
        height: 40
        TFButton:
            size_hint: None, None
            size: 220, 40
            text: "Search USEARCH executable"
            on_release:
                app.dialog_filechooser("usearch_fix", 2)
                root.cancel()

<ProjectOrtoBt>:
    size_hint: None, None
    size: 35, 35
    text: "O"
    bold: True
    disabled: True
    disabled_color: 1,1,1,1
    background_disabled_normal: "data/backgrounds/check_ok.png"

<ProjectProcBt>:
    size_hint: None, None
    size: 35, 35
    text: "P"
    bold: True
    disabled: True
    disabled_color: 1,1,1,1
    background_disabled_normal: "data/backgrounds/bt_process.png"


<CrunchData>:
    orientation: "vertical"
    spacing: 10
    AnchorLayout:
        anchor_x: "center"
        anchor_y: "center"
        size_hint_y: None
        height: 50
        ScatterLayout:
            do_translation: False
            do_scale: False
            do_rotation: False
            id: img
            size_hint: None, None
            size: 50, 50
            Image:
                source: "data/backgrounds/spinner2.png"
    BoxLayout:
        orientation: "vertical"
        size_hint_y: None
        height: 50
        Label:
            id: msg
            size_hint_y: None
            height: 30
            text: "Crunching data..."
            bold: True
            halign: "center"
            valign: "middle"
            text_size: self.size
            color: (0.216, 0.67, 0.784, 1)

        Label:
            id: msg2
            size_hint_y: None
            height: 20
            text: ""
            bold: True
            font_size: 12
            halign: "center"
            valign: "top"
            text_size: self.size
            color: (0.216, 0.67, 0.784, 1)

    AnchorLayout:
        size_hint_y: None
        height: 30
        anchor_x: "center"
        anchor_y: "center"
        id: cancel_anc
        TFButton:
            size_hint_x: None
            width: 150
            text: "Cancel"
            bold: True
            id: cancel_bt
    Widget:
        size_hint_y: None
        height: 10

<FileOverwriteDialog>:
    orientation: "vertical"
    padding: 10
    spacing: 20

    ScrollView:
        Label:
            id: dlg_text
            bold: True
            halign: "center"
            valign: "middle"
            text_size: self.size

    BoxLayout:
        size_hint_y: None
        height: 30
        spacing: 10
        CheckBox:
            size_hint_x: None
            width: 30
            id: dlg_chk
        Label:
            text: "Apply this option to all files"
            halign: "left"
            valign: "middle"
            text_size: self.size

    BoxLayout:
        size_hint_y: None
        height: 30
        spacing: 10
        TFOKButon:
            id: ok_bt
            text: "Overwrite"
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            on_release:
                setattr(app, "file_overwrite", "overwrite")
                app.file_apply_all = True if dlg_chk.active else False
                root.cancel()

        TFOKButon:
            text: "Skip"
            id: cancel_bt
            on_release:
                setattr(app, "file_overwrite", "skip")
                app.file_apply_all = True if dlg_chk.active else False
                root.cancel()

        TFOKButon:
            text: "Cancel"
            id: apply_bt
            on_release:
                setattr(app, "terminate_process_exec", True)
                root.cancel()

<InputTextDialog>:
    orientation: "vertical"
    padding: 10
    spacing: 10
    TFTextInput:
        id: txt_dlg
        focus: True
        multiline: False
    BoxLayout:
        size_hint_y: None
        height: 30
        orientation: "horizontal"
        spacing: 10
        TFOKButon:
            id: ok_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Ok"
            on_release:
                root.action(txt_dlg.text)
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release:
                root.cancel()

# This is a simple modification of the default TextInput widget that changes
# the application's arrow_block attribute controlling arrow keybindings
<TFTextInput>:
    multiline: False
    on_focus:
        app.arrow_block = self.focus


<ExtSpinner>:
    id: ext
    size_hint_x: None
    width: 80
    text: ".png"
    values: [".png", ".svg", ".pdf", ".eps", ".ps", ".jpeg", ".tiff"] if app.os_platform != "darwin" else [".png", ".svg", ".pdf", ".eps", ".ps"]

<ExtLabel>:
    size_hint_x: None
    width: 80
    color: (.7,.7,.7,1)
    halign: "left"
    valign: "middle"
    text_size: self.size
    bold: True

<BWCheck>:
    size_hint_x: None
    width: 110
    id: bw_box
    CheckBox:
        id: bw
        size_hint_x: None
        width: 30
    Label:
        id: lbl
        text: "Grayscale"
        bold: True

<InputType>:
    orientation: "vertical"
    padding: [10, 0, 10, 0]
    spacing: 10
    files: []
    Label:
        size_hint_y: None
        height: 30
        bold: True
        text: "Input data type:"
    BoxLayout:
        spacing: 10
        TFButton:
            text: "Alignment"
            on_release:
                root.cancel()
                app.load_files_subproc(root.files)
        TFButton:
            text: "Proteome"
            on_release:
                root.cancel()
                app.load_proteomes(root.files)
        TFButton:
            text: "Group"
            on_release:
                root.cancel()
                app.root.ids.h_ortho.dispatch("on_release"); app.root.ids.h_ortho.state = "down"
                app.screen.ids.explore.dispatch("on_release"); app.screen.ids.explore.dispatch("on_press"); app.screen.ids.explore.state = "down"
                app.run_in_background(load_group_files, app.load_groups, [root.files, app.temp_dir, "use_ns"], None, False, "Loading group files...")
    Label:
        size_hint_y: None
        height: 30
        color: .6,.6,.6,1
        bold: True
        text: "Loading %s(s) file(s)" % len(root.files)

#===============================================================================
# SIDE PANEL
#===============================================================================

<AboutDialog>:
    padding: 10
    orientation: "vertical"
    version: ""
    build: ""
    spacing: 10
    BoxLayout:
        orientation: "vertical"
        size_hint_y: None
        height: 120
        spacing: 5
        Label:
            size_hint_y: None
            height: 30
            font_size: 12
            color: .7, .7, .7, .8
            text: "Version {} (build {})".format(root.version, root.build)
        Label:
            size_hint_y: None
            height: 30
            font_size: 26
            text: "TriFusion"
            color: [47 / 255., 167 / 255., 212 / 255., 1.]
            bold: True
        BoxLayout:
            size_hint_y: None
            height: 128
            Image:
                source: "data/backgrounds/trifusion-icon-128.png"
        Label:
            size_hint_y: None
            height: 30
            markup: True
            halign: "left"
            valign: "middle"
            text_size: self.size
            text: "[b]Author:[/b] Diogo N. Silva"
        Label:
            size_hint_y: None
            height: 30
            markup: True
            halign: "left"
            valign: "middle"
            text_size: self.size
            text: "[b]Development team:[/b] Diogo N. Silva, Fernando Alves"
        Label:
            size_hint_y: None
            height: 30
            markup: True
            halign: "left"
            valign: "middle"
            text_size: self.size
            text: "[b]Testing team:[/b] Diogo N. Silva, Tiago F. Jesus"
    BoxLayout:
        size_hint_y: None
        height: 20
        Label:
            text: "[ref=http://odiogosilva.github.io/TriFusion/]Website[/ref]"
            markup: True
            bold: True
            color: (55./255., 171./255., 200./255., 1)
            on_ref_press:
                import webbrowser
                webbrowser.open(args[1])
        Label:
            text: "[ref=https://github.com/ODiogoSilva/TriFusion]GitHub page[/ref]"
            markup: True
            bold: True
            color: (55./255., 171./255., 200./255., 1)
            on_ref_press:
                import webbrowser
                webbrowser.open(args[1])
        Label:
            text: "[ref=https://github.com/ODiogoSilva/TriFusion/issues/]New features/Bugs[/ref]"
            markup: True
            bold: True
            color: (55./255., 171./255., 200./255., 1)
            on_ref_press:
                import webbrowser
                webbrowser.open(args[1])

<FancyDropDown>:
    orientation: "vertical"
    ds_type: ""
    size_hint: None, None

    canvas.before:
        Color:
            rgba: tm.c_dropdown_background
        Rectangle:
            pos: self.pos
            size: self.size

    StackLayout:
        size_hint_y: None
        height: 0
        canvas.after:
            Color:
                rgb: (0.216, 0.67, 0.784, 1)
            Line:
                width: 1.1
                rectangle: root.x, root.y, root.width, root.height

    ScrollView:
        bar_width: 8
        scroll_type: ["bars"]
        GridLayout:
            id: grid_wgt
            cols: 1
            padding: 12
            spacing: 5
            size_hint_y: None
            height: self.minimum_height

<SP_MoreOpts_Dialog>:
    id: sd_moreopts_format_dlg
    orientation: "vertical"
    ds_type: ""
    size_hint: None, None
    height: 310
    width: 270

    canvas.before:
        Color:
            rgba: tm.c_dropdown_background
        Rectangle:
            pos: self.pos
            size: self.size

    StackLayout:
        size_hint_y: None
        height: 0
        canvas.after:
            Color:
                rgb: (0.216, 0.67, 0.784, 1)
            Line:
                width: 1.1
                rectangle: root.x, root.y, root.width, root.height

    ScrollView:
        GridLayout:
            id: grid_wgt
            cols: 1
            padding: 10
            spacing: 5
            size_hint_y: None
            height: 250
            Label:
                size_hint_y: None
                height: 25
                halign: "center"
                valign: "middle"
                text_size: self.size
                text: "Remove options"
                bold: True
                color: (0.216, 0.67, 0.784, 1)

            TFButton:
                text_size: self.size
                halign: "center"
                valign: "middle"
                size_hint_y: None
                height: 30
                text: "Remove file names from .txt" if root.ds_type == "Files" else "Remove taxa names from .txt"
                bold: True
                on_release:
                    app.sidepanel_remove_moreopts()
                    app.dialog_remove_from_file()

            TFButton:
                text_size: self.size
                halign: "center"
                valign: "middle"
                size_hint_y: None
                height: 30
                text: "Remove selected files" if root.ds_type == "Files" else "Remove selected taxa"
                bold: True
                on_release:
                    app.sidepanel_remove_moreopts()
                    app.remove_bt_from_selection(root.ds_type)

            Label:
                size_hint_y: None
                height: 25
                halign: "center"
                valign: "middle"
                text_size: self.size
                text: "Select options"
                bold: True
                color: (0.216, 0.67, 0.784, 1)

            TFButton:
                text_size: self.size
                halign: "center"
                valign: "middle"
                size_hint_y: None
                height: 30
                text: "Invert selection"
                bold: True
                on_release:
                    app.sidepanel_invert_selection(root.ds_type)

            TFButton:
                text_size: self.size
                halign: "center"
                valign: "middle"
                size_hint_y: None
                height: 30
                text: "Select file names from .txt" if root.ds_type == "Files" else "Select taxa names from .txt"
                bold: True
                on_release:
                    app.sidepanel_remove_moreopts()
                    app.dialog_select_from_file()

            Label:
                size_hint_y: None
                height: 25
                halign: "center"
                valign: "middle"
                text_size: self.size
                text: "Export options"
                bold: True
                color: (0.216, 0.67, 0.784, 1)

            TFButton:
                text_size: self.size
                halign: "center"
                valign: "middle"
                size_hint_y: None
                height: 30
                text: "Export all file names to .txt" if root.ds_type == "Files" else "Export all taxa names to .txt"
                bold: True
                on_release:
                    app.sidepanel_remove_moreopts()
                    app.dialog_filechooser("export")
                    if root.ds_type == "Files": \
                    app.export_mode = ("files", "all")
                    else:\
                    app.export_mode = ("taxa", "all")

            TFButton:
                text_size: self.size
                halign: "center"
                valign: "middle"
                size_hint_y: None
                height: 30
                text: "Export selected file names to .txt" if root.ds_type == "Files" else "Export selected taxa names to .txt"
                bold: True
                on_release:
                    app.sidepanel_remove_moreopts()
                    app.dialog_filechooser("export")
                    if root.ds_type == "Files":\
                    app.export_mode = ("files", "selected")
                    else:\
                    app.export_mode = ("taxa", "selected")


#===============================================================================
# ROOT WINDOW
#===============================================================================

<WarningFloat>:
    root_pos: [0, 0]
    size_hint: None, None
    padding: (10, 15)
    halign: "left"
    valign: "middle"
    width: len(self.text) * 9 if len(self.text) * 9 < 400 else 400
    text_size: (self.size[0], None)
    height: self.texture_size[1]
    pos: self.root_pos[0] - self.size[0] - 20, self.root_pos[1] - self.size[1] - 60
    line_cl: (1, 0.3, 0.3, 1)
    background_src: ""
    bold: True
    canvas.before:
        Color:
            rgba: (1,1,1,1)
        Rectangle:
            source: self.background_src
            pos: (root.pos[0] - 30, root.pos[1])
            size: (root.size[0] + 30, root.size[1])
    StackLayout:
        canvas.after:
            Color:
                rgb: (0.7, 0.7, 0.7, .9)
            Line:
                width: 1.1
                cap: "round"
                joint: "round"
                rectangle: root.x - 30,root.y,root.width+30,root.height

<RemoveFloat>:
    size_hint: None, None
    background_normal: "data/backgrounds/round_remove.png"
    background_down: "data/backgrounds/round_remove.png"
    size: 25, 25

<IconFloat>:
    size_hint: None, None
    size: 20, 20
    icon_src: ""
    canvas.after:
        Rectangle:
            source: self.icon_src
            pos: self.pos
            size: self.size


<CloseFloat>:
    pos: ((app.root.width / 2) + (app._popup.width / 2) - 15, (app.root.height / 2) + (app._popup.height / 2) - 15)

#===============================================================================
# FILECHOOSER
#===============================================================================

<PathLabel>:
    size_hint_x: .93
    text_size: (self.size[0] - 20, self.size[1])
    shorten: True
    text: app.home_path
    shorten_from: "left"
    halign: "left"
    valign: "middle"
    markup: True
    bold: True
    canvas.before:
        Color:
            rgba: tm.c_filechooser_headers
        Rectangle:
            pos: self.pos
            size: self.size
    on_ref_press:
        app._update_path(args[1])

<PathText>:
    size_hint_x: .93
    multiline: False
    text: app.home_path
    on_focus:
        app.arrow_block = self.focus

<FileTypeBt@ToggleButton>:
    bold: True
    background_normal: "data/backgrounds/bt_process_off.png"
    background_down: "data/backgrounds/bt_process.png"
    background_disabled_down: "data/backgrounds/bt_process.png"
    disabled_color: (1,1,1,1)
    size_hint_y: None
    height: 30
    group: "file_type"
    on_release:
        app.toggle_groups(self)
    StackLayout:
        canvas.after:
            Color:
                rgb: (0.216, 0.67, 0.784, 1)
            Line:
                joint: "miter"
                cap: "square"
                close: True
                width: 1.05
                rectangle: root.x,root.y,root.width,root.height

<LoadProgressDialog>:
    padding: 20
    orientation: "vertical"

    Label:
        id: msg
        bold: True
        halign: "center"
        valign: "middle"
        text_size: self.size
        #shorten: True

    ProgressBar:
        max: 10
        id: pb

    AnchorLayout:
        anchor_x: "center"
        anchor_y: "center"
        size_hint_y: None
        height: 30
        TFOKButon:
            size_hint_x: None
            width: 150
            id: close_bt
            text: "Cancel"
            background_normal: "data/backgrounds/bt_process.png"


#===============================================================================
# MOUSE OVER
#===============================================================================

<FancyButton>:
    size_hint: None, None
    background_disabled_normal: "data/backgrounds/fancy_mo_background.png"
    disabled: True
    disabled_color: (1,1,1,1)
    bold: True
    line_clr: (1,1,1,1)
    StackLayout:
        canvas.after:
            Color:
                rgb: root.line_clr
            Line:
                width: 0.8
                cap: "round"
                joint: "round"
                rectangle: root.x,root.y,root.width,root.height

<FancyMarker>:
    size_hint: None, None
    border: 0,0,0,0

<FancyMarkerPersist>:
    size_hint: None, None
    border: 0,0,0,0

<MouseOverLabel>:
    text_size: self.size
    halign: "center"
    valign: "middle"
    background_down: "atlas://data/images/defaulttheme/button"

<SideLabel>:
    canvas.before:
        Color:
            rgba: (1,1,1,1)
        Rectangle:
            source: "data/backgrounds/side_label.png"
            pos: self.pos
            size: self.size

#===============================================================================
# PLOT SCREEN
#===============================================================================

<MySlider>:
    FancyMarker:
        pos: (root.value_pos[0] - 6, root.center_y + 15)
        background_normal: "data/backgrounds/box_arrow_down.png"
        size: 12, 7
        background_color: (0.216, 0.67, 0.784, 1)
        opacity: 1 if root.collide_point(app.mouse_position[0], app.mouse_position[1]) else 0
    FancyButton:
        text: str(root.value).split(".")[0]
        size: 30, 20
        pos: (root.value_pos[0] - 15, root.center_y + 22.5)
        background_color: (0.216, 0.67, 0.784, 1)
        line_clr: (0.216, 0.67, 0.784, 1)
        opacity: 1 if root.collide_point(app.mouse_position[0], app.mouse_position[1]) else 0

<BackButton>:
    size_hint: None, None
    size: 80,30
    pos: 0, app.root.height - 100
    text: "  Back"
    bold: True
    opacity: .2
    background_normal: "data/backgrounds/go_back_bt.png"
    on_release:
        app.go_previous_screen()

<OrtoPlotToolbar>:
    orientation: "vertical"
    size_hint: None, None
    size: 50, 285
    pos: app.root.width - 50, (app.root.height / 2) - (self.height / 2)
    opacity: .2
    canvas.before:
        Color:
            rgba: (.2,.2,.2,1)
        Rectangle:
            pos: self.pos
            size: self.size

    AnchorLayout:
        anchor_x: "center"
        anchor_y: "center"
        BoxLayout:
            orientation: "vertical"
            size_hint: None, None
            size: 40, 265
            spacing: 5
            id: content
            Button
                size_hint: None, None
                size: 40, 40
                border: 0,0,0,0
                background_normal: "data/backgrounds/zoom_in.png"
                background_down: "data/backgrounds/zoom_in_down.png"
                on_release:
                    app.screen.ids.plot_content.scale += .1
            Button
                size_hint: None, None
                size: 40, 40
                border: 0,0,0,0
                background_normal: "data/backgrounds/zoom_out.png"
                background_down: "data/backgrounds/zoom_out_down.png"
                on_release:
                    app.screen.ids.plot_content.scale -= .1 if app.screen.ids.plot_content.scale > 0.5 else 0
            Button:
                size_hint: None, None
                size: 40, 40
                border: 0,0,0,0
                background_normal: "data/backgrounds/fit_plot.png"
                background_down: "data/backgrounds/fit_plot_down.png"
                on_release:
                    app.screen.ids.plot_content.scale = 1
                    app.screen.ids.plot_content.pos = (0, 0)
            Button:
                size_hint: None, None
                size: 40, 40
                id: export_group
                border: 0,0,0,0
                background_normal: "data/backgrounds/export_group.png"
                background_down: "data/backgrounds/export_group_down.png"
                background_disabled_normal: "data/backgrounds/export_group_disabled.png"
                disabled: True if app.screen.name == "group_compare" else False
                on_release:
                    app.dialog_export_groups()
            Button:
                size_hint: None, None
                size: 40, 40
                id: export_fig
                border: 0,0,0,0
                background_normal: "data/backgrounds/export_fig.png"
                background_down: "data/backgrounds/export_fig_down.png"
                background_disabled_normal: "data/backgrounds/export_fig_disabled.png"
                on_release:
                    app.dialog_filechooser("export_graphic")
            Button:
                size_hint: None, None
                size: 40, 40
                border: 0,0,0,0
                id: export_table
                background_normal: "data/backgrounds/export_table.png"
                background_down: "data/backgrounds/export_table_down.png"
                background_disabled_normal: "data/backgrounds/export_table_disabled.png"
                on_release:
                    app.dialog_filechooser("export_table")

<ExportGroupDialog>:
    orientation: "vertical"
    padding: 10
    spacing: 10
    BoxLayout:
        orientation: "vertical"
        size_hint_y: None
        height: 50
        BoxLayout:
            spacing: 10
            FileTypeBt:
                state: "down"
                disabled: True
                id: group_fmt
                text: "Groups file"
            FileTypeBt:
                id: prot_fmt
                text: "Protein sequences"
            FileTypeBt:
                id: nuc_fmt
                text: "Nucleotide sequences"

    Hseparator:
        thickness: 1.5

    DarkBox:
        height: 70
        Label:
            opacity: .2 if group_fmt.state == "down" else 1
            size_hint_x: .7
            markup: True
            text: "[size=18][b]Protein database[/b][/size]\n[size=13]Provide the path to the Fasta file containing the proteins used as a database for the Search operation. [/size]"
            halign: "left"
            valign: "middle"
            text_size: self.size
        ProcessBt:
            disabled: True if group_fmt.state == "down" else False
            text: app.protein_db.split(sep)[-1] if app.protein_db else "Select..."
            background_normal: "data/backgrounds/bt_process.png" if app.protein_db else "data/backgrounds/bt_process_off.png"
            on_release:
                app.dialog_filechooser("protein_db")

    Hseparator:
        thickness: 1

    DarkBox:
        height: 70
        Label:
            opacity: .2 if group_fmt.state == "down" or prot_fmt.state == "down" else 1
            size_hint_x: .7
            markup: True
            text: "[size=18][b]CDS database[/b][/size]\n[size=13]Provide the path to the Fasta file containing the nucleotide CDS files that correspond to the searched proteins[/size]"
            halign: "left"
            valign: "middle"
            text_size: self.size
        ProcessBt:
            disabled: True if group_fmt.state == "down" or prot_fmt.state == "down" else False
            text: "{} selected".format(len(app.cds_db)) if app.cds_db else "Select..."
            background_normal: "data/backgrounds/bt_process.png" if app.cds_db else "data/backgrounds/bt_process_off.png"
            on_release:
                app.dialog_filechooser("cds_db")

    Hseparator:
        thickness: 1.5

    BoxLayout:
        size_hint_y: None
        height: 30
        AnchorLayout:
            anchor_x: "center"
            anchor_y: "center"
            BoxLayout:
                size_hint_x: None
                width: 220
                spacing: 20
                TFOKButon:
                    background_normal: "data/backgrounds/bt_process.png"
                    background_down: "data/backgrounds/bt_process_off.png"
                    text: "Export"
                    id: ok_bt
                    size_hint_x: None
                    width: 100
                    on_release:
                        if prot_fmt.state == "down" and not app.protein_db: \
                        app.dialog_floatcheck("Please provide a protein database", t="error")
                        elif nuc_fmt.state == "down" and not app.protein_db and not app.cds_db: \
                        app.dialog_floatcheck("Please provide a protein and/or CDS database(s)", t="error")
                        elif prot_fmt.state == "down": \
                        app.dialog_export_groups_filechooser("protein")
                        elif group_fmt.state == "down": \
                        app.dialog_export_groups_filechooser("group")
                        elif nuc_fmt.state == "down": \
                        app.dialog_export_groups_filechooser("nucleotide")

                TFOKButon:
                    id: cancel_bt
                    text: "Cancel"
                    size_hint_x: None
                    width: 100
                    on_release: root.cancel()

#===============================================================================
# GENERAL INFORMATIVE POPUP
#===============================================================================

<InfoPopup>:
    orientation: "vertical"
    padding: 10
    spacing: 10
    ScrollView:
        bar_width: 8
        scroll_type: ["bars", "content"]
        GridLayout:
            cols: 1
            padding: 10
            size_hint_y: None
            height: self.minimum_height

            Label:
                id: content
                size_hint: (1, None)
                text_size: self.width, None
                size: self.parent.width, self.texture_size[1]
                markup: True
                font_size: 15
                line_height: 1
                halign: "justify"
                on_ref_press:
                    import webbrowser
                    webbrowser.open(args[1])

<InfoBt@Button>:
    size_hint: (None, None)
    border: 0,0,0,0
    background_normal: "data/backgrounds/more_info.png"
    background_down: "data/backgrounds/more_info_down.png"

#===============================================================================
# TAXA/FILE INFORMATIVE POPUPS
#===============================================================================

<PopupLabel@Label>:
    bold: True
    halign: "left"
    valign: "middle"
    text_size: self.size
    size_hint_x: .6

<PopupText@TextInput>:
    multiline: False
    readonly: True
    size_hint_x: .4

<PopupBox@BoxLayout>:
    size_hint_y: None
    height: 30
    spacing: 10

<ProteomePopup>
    orientation: "vertical"
    padding: 10
    spacing: 5
    BoxLayout:
        orientation: "vertical"
        spacing: 10
        PopupBox:
            PopupLabel:
                text: "Number of sequences:"
            PopupText:
                id: n_seq
        PopupBox:
            PopupLabel:
                text: "Sequence size:"
            PopupText:
                id: n_res

        Widget
    BoxLayout:
        size_hint_y: None
        height: 30
        padding: (100, 0, 100, 0)
        TFOKButon:
            id: close_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Close"
            on_release:
                root.cancel()

<FilePopup>
    orientation: "vertical"
    padding: 10
    spacing: 5
    BoxLayout:
        orientation: "vertical"
        spacing: 10
        PopupBox:
            PopupLabel:
                text: "Input format:"
            PopupText:
                id: in_format
        PopupBox:
            PopupLabel:
                text: "Sequence type:"
            PopupText:
                id: seq_type
        PopupBox:
            PopupLabel:
                text: "Sequence size:"
            PopupText:
                id: seq_size
        PopupBox:
            PopupLabel:
                text: "Number of taxa:"
            PopupText:
                id: n_taxa
        Widget
    BoxLayout:
        size_hint_y: None
        height: 30
        padding: (100, 0, 100, 0)
        TFOKButon:
            id: close_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Close"
            on_release:
                root.cancel()

<TaxaEdit>:
    orientation: "vertical"
    padding: 15
    TFButton:
        text: "Change taxon name"
        on_touch_down:
            app.change_taxa_name()

<TaxaPopup>
    orientation: "vertical"
    size_hint_y: None
    padding: 15
    spacing: 5
    PopupLabel:
        background_color: (.7, .7, .7)
        id: dataset_label
        halign: "center"
        size_hint_x: 1
        size_hint_y: None
        height: 30
        canvas.before:
            Color:
                rgba: .35, .35, .35, 1
            Rectangle:
                pos: self.pos
                size: self.size
    PopupBox:
        PopupLabel:
            #size_hint_x: .45
            text: "Sequence length:"
        PopupText:
            #size_hint_x: .55
            id: seq_len
    PopupBox:
        PopupLabel:
            #size_hint_x: .45
            text: "Number of indels:"
        PopupText:
            #size_hint_x: .55
            id: indels
    PopupBox:
        PopupLabel:
            #size_hint_x: .65
            text: "Number of missing data:"
        PopupText:
            #size_hint_x: .35
            id: missing
    PopupBox:
        PopupLabel:
            #size_hint_x: .7
            text: "Effective sequence length:"
        PopupText:
            #size_hint_x: .3
            id: ef_seq_len
    PopupBox:
        PopupLabel:
            #size_hint_x: .35
            text: "File coverage"
        PopupText:
            #size_hint_x: .65
            id: file_cov

<CloseBox>:
    size_hint_y: None
    height: 30
    padding: (100, 0, 100, 0)
    TFOKButon:
        id: close_bt
        background_normal: "data/backgrounds/bt_process.png"
        background_down: "data/backgrounds/bt_process_off.png"
        bold: True
        text: "Close"
        on_release:
            root.cancel()

#===============================================================================
# CHECK ACTIONS
#===============================================================================

<CheckBt@Button>:
    background_normal: "data/backgrounds/check_ok.png"
    background_down: "data/backgrounds/check_cancel.png"
    bold: True
    shorten: True
    shorten_from: "right"
    text_size: self.size
    halign: "center"
    valign: "middle"
    StackLayout:
        canvas.after:
            Color:
                rgba: app._red
            Line:
                width: 1.1
                cap: "round"
                joint: "round"
                rectangle: root.x,root.y,root.width,root.height

<CheckDialog>:
    orientation: "vertical"
    id: check
    text: None
    BoxLayout:
        padding: 10
        Label:
            valign: "middle"
            halign: "center"
            text_size: (self.size[0] - 5, self.size[1])
            id: check_text
    BoxLayout:
        size_hint_y: None
        height: 50
        spacing: 10
        padding: 10
        CheckBt:
            text: "Yes"
            id: check_ok
            on_release:
                root.cancel()
        CheckBt:
            id: check_cancel
            background_normal: "data/backgrounds/check_cancel.png"
            background_down: "data/backgrounds/check_ok.png"
            text: "No"
            on_release:
                root.cancel()

<CheckProject>:
    orientation: "vertical"
    id: project_check
    BoxLayout:
        padding: 10
        spacing: 5
        orientation: "vertical"
        Widget:
            size_hint_y: None
            height: 5
        Label:
            size_hint_y: None
            height: 20
            valign: "middle"
            halign: "left"
            text_size: (self.size[0] - 5, self.size[1])
            id: proj_name
            markup: True
        Label:
            size_hint_y: None
            height: 20
            valign: "middle"
            halign: "left"
            text_size: (self.size[0] - 5, self.size[1])
            id: file_num
            markup: True
        Widget:
            size_hint_y: None
            height: 5
        Label:
            valign: "middle"
            halign: "center"
            text_size: (self.size[0] - 5, self.size[1])
            text: "(Any previously loaded data will be removed)"
    BoxLayout:
        size_hint_y: None
        height: 50
        spacing: 10
        padding: 10
        TFOKButon:
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Open"
            id: check_ok
            on_press:
                root.cancel()

        TFOKButon:
            id: check_cancel
            text: "Cancel"
            on_press:
                root.cancel()


#===============================================================================
# WARNINGS
#===============================================================================

<WarningDialog>:
    padding: 10
    orientation: "vertical"
    spacing: 10
    ScrollView:
        bar_width: 10
        scroll_type: ["bars", "content"]
        GridLayout:
            cols: 1
            padding: 10
            size_hint_y: None
            height: self.minimum_height

            Label:
                id: warning_l
                halign: "center"
                valign: "middle"
                size_hint: (1, None)
                text_size: self.width, None
                size: self.parent.width, self.texture_size[1]
                markup: True
                on_ref_press:
                    import webbrowser
                    webbrowser.open(args[1])


    BoxLayout:
        size_hint_y: None
        height: 30
        padding: (150, 0, 150, 0)
        Button:
            background_normal: "data/backgrounds/check_ok.png"
            background_down: "data/backgrounds/check_cancel.png"
            text: "Close"
            id: close_bt
            bold: True
            on_release:
                root.cancel()

#===============================================================================
# ORTHOLOGY SCREEN
#===============================================================================

#===============================================================================
# ORTHOLOGY RESULT DESCRIPTION
#===============================================================================

<ExploreOpsBt@ToggleButton>:
    padding: 5,5
    border: 0,0,0,0
    group: "explore_bts"
    size_hint_x: None
    valign: "middle"
    text_size: self.size
    width: 100
    on_release:
        app.toggle_groups(self)

<DescriptionBox>:
    orientation: "vertical"
    size_hint_y: 1
    #height: 520
    spacing: 10
    # Setting custom attributes
    prot_txt: ""
    taxa_txt: ""
    ortholog_txt: ""
    group_name: ""
    BoxLayout:
        orientation: "vertical"
        id: bx1
        size_hint_y: None
        height: 110
        padding: 10
        canvas.before:
            Color:
                rgba: (.1,.1,.1, 1)
            Rectangle:
                pos: self.pos
                size: self.size
        StackLayout:
            canvas.after:
                Color:
                    rgb: (0.216, 0.67, 0.784, 1)
                Line:
                    width: 0.8
                    cap: "round"
                    joint: "round"
                    rectangle: bx1.x,bx1.y,bx1.width,bx1.height
        BoxLayout:
            size_hint_y: None
            height: 30
            Label:
                text: "General information"
                halign: "left"
                valign: "middle"
                text_size: self.size
                bold: True
            Label:
                text: root.group_name
                halign: "right"
                valign: "middle"
                text_size: self.size
                bold: True
                font_size: 20
                color: (0.216, 0.67, 0.784, 1)

        BoxLayout:
            size_hint_y: None
            height: 60
            BoxLayout:
                spacing: 10
                Vseparator:
                    thickness: 2
                BoxLayout:
                    orientation: "vertical"
                    DescriptionLabelLarge:
                        text: root.prot_txt
                    DescriptionLabelSmall:
                        text: "Proteins"
            BoxLayout:
                spacing: 10
                Vseparator:
                    thickness: 2
                BoxLayout:
                    orientation: "vertical"
                    DescriptionLabelLarge:
                        text: root.taxa_txt
                    DescriptionLabelSmall:
                        text: "Taxa"
            BoxLayout:
                spacing: 10
                Vseparator:
                    thickness: 2
                BoxLayout:
                    orientation: "vertical"
                    DescriptionLabelLarge:
                        text: root.ortholog_txt
                    DescriptionLabelSmall:
                        text: "Total orthologs"

    BoxLayout:
        id: filt_bx
        orientation: "vertical"
        #size_hint_y: None
        #cols: 1
        #height: 320
        padding: 10
        canvas.before:
            Color:
                rgba: (.1,.1,.1, 1)
            Rectangle:
                pos: self.pos
                size: self.size
        StackLayout:
            size_hint_y: None
            height: 0
            canvas.after:
                Color:
                    rgb: (0.216, 0.67, 0.784, 1)
                Line:
                    width: 0.8
                    cap: "round"
                    joint: "round"
                    rectangle: filt_bx.x,filt_bx.y,filt_bx.width,filt_bx.height
        BoxLayout:
            size_hint_y: None
            height: 30
            Label:
                text: "Filtered orthologs"
                halign: "left"
                valign: "middle"
                text_size: self.size
                bold: True
            Widget
            TFButton:
                text: "Export as..."
                size_hint_x: None
                width: 100
                on_release:
                    app.dialog_export_groups()

        BoxLayout:
            #size_hint_y: None
            #height: 180
            id: gauge_bx
            #GaugePlot:
            #    proportion: 0.7
            #    ortholog_num: "47236"

        Widget:
            size_hint_y: None
            height: 10

        AnchorLayout:
            anchor_x: "center"
            anchor_y: "center"
            size_hint_y: None
            height: 60

            TFButton:
                size_hint: (None, None)
                size: 120, 30
                text: "Change filters"
                on_release:
                    app.dialog_orto_setfilter(root.group_name)

        BoxLayout:
            size_hint_y: None
            height: 20

            Label:
                color: .7, .7, .7, 1
                font_size: 12
                text: "Maximum gene copies: %s" % app.ortho_groups.filters[app.active_group_name][0] if app.ortho_groups else "None"
                bold: True
                halign: "left"
                valign: "middle"
                text_size: self.size
            Label:
                color: .7, .7, .7, 1
                font_size: 12
                text: "Minimum taxa representation: %s" % app.ortho_groups.filters[app.active_group_name][1] if app.ortho_groups else "None"
                bold: True
                halign: "center"
                valign: "middle"
                text_size: self.size
            Label:
                color: .7, .7, .7, 1
                font_size: 12
                text: "Excluded taxa: %s" % len(app.ortho_groups.excluded_taxa[app.active_group_name]) if app.ortho_groups else "None"
                bold: True
                halign: "right"
                valign: "middle"
                text_size: self.size

<DescriptionLabelLarge@Label>:
    bold: True
    halign: "left"
    valign: "bottom"
    text_size: self.size
    font_size: 22
    size_hint_y: None
    height: 40
    color: (0.216, 0.67, 0.784, 1)
    on_text:
        try:\
        self.text = "{0:,}".format(int(self.text))
        except ValueError:\
        pass

<DescriptionLabelSmall@Label>:
    bold: True
    halign: "left"
    valign: "top"
    text_size: self.size
    font_size: 12
    size_hint_y: None
    height: 20
    color: .7,.7,.7,1

<GaugePlot>:
    orientation: "vertical"
    padding: 10
    spacing: 10
    txt: "After gene filter"
    proportion: 0
    ortholog_num: ""
    inner_color: {"After species filter": (0.16,0.16,0.16,1), "After gene filter": (0.14,0.14,0.14,1), "Final orthologs": (0.12,0.12,0.12,1)}
    Label:
        id: gauge_txt
        text: root.txt
        size_hint_y: None
        height: 30
        bold: True
        color: app._blue if root.txt == "Final orthologs" else (1, 1, 1, 1)
        font_size: 17 if root.txt == "Final orthologs" else 15
    AnchorLayout:
        anchor_y: "center"
        anchor_x: "center"
        BoxLayout:
            size_hint: (None, None)
            size: root.width if root.width < root.height else root.width - (root.width - root.height), root.height if root.height < root.width else root.height - (root.height - root.width)
            canvas.before:
                Color:
                    rgba: (.3, .3, .3, .5)
                Ellipse:
                    size: self.size[0] * .8, self.size[1] *.8
                    pos: self.pos[0] + self.size[0] * .1, self.pos[1] + self.size[1] * .1
                Color:
                    rgba: (0.216, 0.67, 0.784, 1) if gauge_txt.text == "Final orthologs" else (.7,.7,.7,1)
                Ellipse:
                    size: self.size[0] * .8, self.size[1] *.8
                    pos: self.pos[0] + self.size[0] * .1, self.pos[1] + self.size[1] * .1
                    angle_start: 360 + (root.proportion * 360)
                Color:
                    #rgba: root.inner_color[gauge_txt.text] if gauge_txt.text in root.inner_color else (0,0,0,0)
                    rgba: (.1,.1,.1, 1)
                Ellipse:
                    size: self.size[0] * .6, self.size[1] * .6
                    pos: self.center_x - (self.size[0] * .5) + (self.size[0] * .2), self.center_y - (self.size[1] * .5) + (self.size[1] * .2)
            BoxLayout:
                orientation: "vertical"
                Label:
                    bold: True
                    text: root.ortholog_num
                    color: (0.216, 0.67, 0.784, 1) if gauge_txt.text == "Final orthologs" else (.7,.7,.7,1)
                    font_size: 22
                    halign: "center"
                    valign: "bottom"
                    text_size: self.size
                    size_hint_y: .55
                Label:
                    bold: True
                    text: str(round(root.proportion * 100, 1)) + "%"
                    color: (0.216, 0.67, 0.784, 1) if gauge_txt.text == "Final orthologs" else (.7,.7,.7,1)
                    halign: "center"
                    valign: "top"
                    text_size: self.size
                    size_hint_y: .45


<MainSideBt@ToggleButton>:
    size_hint_y: None
    height: 80
    halign: "center"
    valign: "middle"
    text_size: self.size
    bold: True
    group: "orto_main"
    #background_color: (1,1,1,.7) if self.state == "normal" else (1,1,1,1)
    disabled_color: (0.216, 0.67, 0.784, 1)
    background_normal: "data/backgrounds/transparent.png"
    background_down: "data/backgrounds/orto_sidebt_down.png"
    background_disabled_down: "data/backgrounds/orto_sidebt_down.png"
    on_press:
        app.toggle_groups(self)

<PlotChangeFilters>:
    orientation: "vertical"
    padding: 10
    spacing: 10
    prev_filt: None
    prev_tx: None
    cur_filt: None
    cur_tx: None

    BoxLayout:
        orientation: "vertical"
        spacing: 10
        padding: 10

        BoxLayout:
            Label:
                size_hint_y: None
                height: 20
                color: app._blue
                text: "Cluster filters"
                bold: True
                halign: "left"
                valign: "middle"
                text_size: self.size

            Label:
                text: "Previous"
                bold: True
                color: app._blue
                size_hint_x: None
                width: 100

            Label:
                text: "Current"
                bold: True
                color: app._blue
                size_hint_x: None
                width: 100

        Hseparator:
            c: app._blue

        BoxLayout:
            size_hint_y: None
            height: 30
            spacing: 5
            Label:
                text: "Maximum number of gene copies:"
                halign: "left"
                valign: "middle"
                text_size: self.size
            Label:
                id: prev_gn
                size_hint_x: None
                width: 100
                bold: True
            Label:
                id: cur_gn
                size_hint_x: None
                width: 100
                bold: True

        BoxLayout:
            size_hint_y: None
            height: 30
            spacing: 5
            Label:
                text: "Minimum number of taxa:"
                halign: "left"
                valign: "middle"
                text_size: self.size
            Label:
                id: prev_min_tx
                size_hint_x: None
                width: 100
                bold: True
            Label:
                id: cur_min_tx
                size_hint_x: None
                width: 100
                bold: True

        Label:
            size_hint_y: None
            height: 20
            color: app._blue
            text: "Taxa filters"
            bold: True
            halign: "left"
            valign: "middle"
            text_size: self.size

        Hseparator:
            c: app._blue

        BoxLayout:
            size_hint_y: None
            height: 30
            spacing: 5
            Label:
                text: "Excluded taxa:"
                halign: "left"
                valign: "middle"
                text_size: self.size
            Label:
                id: prev_ex_tx
                size_hint_x: None
                width: 100
                bold: True
            Label:
                id: cur_ex_tx
                size_hint_x: None
                width: 100
                bold: True
    BoxLayout:
        size_hint_y: None
        height: 30
        Label:
            bold: True
            text: "Do you want to keep the current filters?"
            color: app._blue
            text_size: self.size
            halign: "left"
            valign: "middle"

        BoxLayout:
            size_hint_x: None
            width: 180
            spacing: 10
            Label:
                text: "Apply to all groups"
                size_hint_x: .9
                text_size: self.size
                halign: "right"
                valign: "middle"
            CheckBox:
                id: apply_all
                size_hint_x: .1
                active: True

    Widget:
        size_hint_y: None
        height: 1

    AnchorLayout:
        size_hint_y: None
        height: 30
        BoxLayout:
            orientation: "horizontal"
            spacing: 10
            size_hint_x: None
            width: 200
            TFOKButon:
                id: ok_bt
                background_normal: "data/backgrounds/bt_process.png"
                background_down: "data/backgrounds/bt_process_off.png"
                text: "Yes"
                on_release:
                    app.dismiss_popup()
                    app.run_in_background(orto_update_filters, app.orthology_card, [app.ortho_groups, int(root.cur_filt[0]), int(root.cur_filt[1]), list(root.cur_tx), [str(app.active_group_name)] if not apply_all.active else None, False], None, False, msg="Applying filters", cancel=False)
                    app.go_previous_screen()

            TFOKButon:
                id: cancel_bt
                text: "No"
                on_release:
                    app.dismiss_popup()
                    #app.run_in_background(orto_update_filters, app.orthology_card, [app.ortho_groups, int(root.prev_filt[0]), int(root.prev_filt[1]), list(root.prev_tx), [str(app.active_group_name)] if not apply_all.active else None, False], None, False, msg="Applying filters", cancel=False)
                    app.go_previous_screen()


<OrtoSetFiltersDialog>:
    orientation: "vertical"
    spacing: 20
    padding: 10
    group_name: ""
    excluded_tx: None
    BoxLayout:
        orientation: "vertical"
        spacing: 10
        AnchorLayout:
            size_hint_y: None
            height: 40
            anchor_x: "center"
            anchor_y: "center"
            BoxLayout:
                size_hint: None, None
                size: 250, 30
                Label:
                    text: "Apply filters to all group files"
                    size_hint_x: .9
                CheckBox:
                    id: apply_chk
                    active: True
                    size_hint_x: .1

        Label:
            size_hint_y: None
            height: 20
            color: app._blue
            text: "Cluster filters"
            bold: True
            halign: "left"
            valign: "middle"
            text_size: self.size

        Hseparator:
            c: app._blue

        BoxLayout:
            size_hint_y: None
            height: 30
            spacing: 5
            Label:
                size_hint_x: .7
                text: "Maximum number of gene copies:"
                halign: "left"
                valign: "middle"
                text_size: self.size
            TFTextInput:
                id: gene_txt
                size_hint_x: .3
                text: str(app.ortho_groups.filters[app.active_group_name][0])
        BoxLayout:
            size_hint_y: None
            height: 30
            spacing: 5
            Label:
                size_hint_x: .7
                text: "Minimum number of taxa:"
                halign: "left"
                valign: "middle"
                text_size: self.size
            TFTextInput:
                id: sp_txt
                size_hint_x: .3
                text: str(app.ortho_groups.filters[app.active_group_name][1])

        Label:
            size_hint_y: None
            height: 20
            color: app._blue
            text: "Taxa filters"
            bold: True
            halign: "left"
            valign: "middle"
            text_size: self.size

        Hseparator:
            c: app._blue

        BoxLayout:
            size_hint_y: None
            height: 30
            spacing: 5
            Label:
                text: "Set which taxa to include:"
                size_hint_x: .7
                halign: "left"
                valign: "middle"
                text_size: self.size
            TFButton:
                id: exclude_bt
                size_hint_x: .3
                on_release:
                    app.dialog_set_exclude_orto_taxa()

        Widget:
            size_hint_y: None
            height: 1

    BoxLayout:
        size_hint_y: None
        height: 30
        orientation: "horizontal"
        spacing: 10
        TFOKButon:
            id: ok_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Ok"
            on_release:
                filt = app.save_ortho_filters(str(gene_txt.text), str(sp_txt.text))
                if type(filt) is tuple and len(filt) == 2:\
                app.run_in_background(orto_update_filters, app.orthology_card, [app.ortho_groups, app.orto_max_gene, app.orto_min_sp, list(root.excluded_tx) if root.excluded_tx else [],  [str(app.active_group_name)] if not apply_chk.active else None, False], None, False, msg="Applying filters", cancel=False)
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release:
                root.cancel()

<PlotOpt@SpinnerOption>:
    bold: True
    size_hint_y: None
    height: 30
    background_normal: "data/backgrounds/spinner_opt.png"

<PlotSpinner@Spinner>:
    bold: True
    border: 0,0,0,0
    background_normal: "data/backgrounds/plot_spinner.png"
    background_down: "data/backgrounds/plot_spinner_down.png"
    size_hint: None, None
    size: 180, 33
#===============================================================================
# ORTHOLOGY EXECUTION DIALOG
#===============================================================================

<OrtoExecutionDialog>:
    padding: 10
    orientation: "vertical"
    spacing: 10
    BoxLayout:
        orientation: "vertical"
        padding: 10
        ExecLabel:
            id: gene_filter
        ExecLabel:
            id: sp_filter
        ExecLabel:
            id: eval
        ExecLabel:
            id: inflation
        ExecLabel:
            id: threads

    Label:
        size_hint_y:None
        height: 30
        bold: True
        text: "[color=37abc8ff]Do you want to proceed?[/color]"
        markup: True
    BoxLayout:
        size_hint_y: None
        height: 40
        padding: (50, 0, 50, 0)
        spacing: 20
        TFOKButon:
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Execute"
            id: ok_bt
            on_release:
                root.cancel()
                app.orthology_search_exec()

        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release:
                root.cancel()


<OrtoProgressDialog>:
    padding: 10
    spacing: 10
    orientation: "vertical"

    Widget:
        size_hint_y: None
        height: 10

    GridLayout:
        cols: 1
        spacing: 10
        id: main_grid

        ProgressBox:
            id: schema

        ProgressBox:
            id: adjust

        ProgressBox:
            id: filter

        ProgressBox:
            id: usearch


        ProgressBox:
            id: parse

        ProgressBox:
            id: pairs

        ProgressBox:
            id: mcl

        ProgressBox:
            id: dump

        ProgressBox:
            id: filter_groups

    BoxLayout:
        size_hint_y: None
        height: 30
        AnchorLayout:
            anchor_x: "center"
            anchor_y: "center"
            TFOKButon:
                id: close_bt
                size_hint_x: None
                width: 150
                background_normal: "data/backgrounds/bt_process.png"
                background_down: "data/backgrounds/bt_process_off.png"
                text: "Cancel"
                on_release:
                    app.terminate_orto_search = True

<OrthoGraphicReport>:
    padding: 10
    spacing: 10
    orientation: "vertical"
    inf: None
    BoxLayout:
        size_hint_y: None
        height: 50
        spacing: 5
        orientation: "vertical"
        Label:
            bold: True
            text: "Total orthologs"
            halign: "left"
            valign: "middle"
            text_size: self.size
            color: (.7,.7,.7,1)
        BoxLayout:
            canvas.before:
                Color:
                    rgba: (.7,.7,.7,1)
                Rectangle:
                    pos: self.pos
                    size: self.size
            Label:
                bold: True
                id: total_ort

    BoxLayout:
        size_hint_y: None
        height: 50
        spacing: 5
        orientation: "vertical"
        Label:
            bold: True
            text: "After gene filter"
            halign: "left"
            valign: "middle"
            text_size: self.size
            color: (.7,.7,.7,1)
        BoxLayout:
            BoxLayout:
                id: gf_box
                canvas.before:
                    Color:
                        rgba: (.7,.7,.7,1)
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Label:
                    id: gf_txt
                    bold: True

            BoxLayout
                size_hint_x: 1 - gf_box.size_hint_x
                canvas.before:
                    Color:
                        rgba: (.4, .4, .4, 1)
                    Rectangle:
                        pos: self.pos
                        size: self.size

    BoxLayout:
        size_hint_y: None
        height: 50
        spacing: 5
        orientation: "vertical"
        Label:
            bold: True
            text: "After species filter"
            halign: "left"
            valign: "middle"
            text_size: self.size
            color: (.7,.7,.7,1)
        BoxLayout
            BoxLayout:
                id: sf_box
                canvas.before:
                    Color:
                        rgba: (.7,.7,.7,1)
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Label:
                    bold: True
                    id: sf_txt
            BoxLayout
                size_hint_x: 1 - sf_box.size_hint_x
                canvas.before:
                    Color:
                        rgba: (.4, .4, .4, 1)
                    Rectangle:
                        pos: self.pos
                        size: self.size

    BoxLayout:
        size_hint_y: None
        height: 80
        spacing: 5
        orientation: "vertical"
        Label:
            bold: True
            text: "Final Orthologs"
            halign: "center"
            valign: "middle"
            text_size: self.size
            color: (.44, .78, .22, 1)
        BoxLayout:
            BoxLayout:
                id: final_box
                canvas.before:
                    Color:
                        rgba: (.44, .78, .22, 1)
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Label:
                    bold: True
                    id: final_txt
            BoxLayout
                size_hint_x: 1 - final_box.size_hint_x
                canvas.before:
                    Color:
                        rgba: (.4, .4, .4, 1)
                    Rectangle:
                        pos: self.pos
                        size: self.size

<OrthoReportDialog>:
    padding: 10
    orientation: "vertical"
    spacing: 10
    BoxLayout:
        size_hint_y: None
        height: 50
        AnchorLayout:
            padding: 5
            anchor_x: "left"
            anchor_y: "center"
            size_hint_x: None
            width: 50
            Button:
                border: 0,0,0,0
                background_normal: "data/backgrounds/prev_car.png"
                background_down: "data/backgrounds/prev_car_down.png"
                on_release:
                    report_car.load_previous()
        AnchorLayout:
            anchor_x: "center"
            anchor_y: "center"
            Label:
                bold: True
                text: "Inflation value %s" % report_car.current_slide.inf if report_car.current_slide else "Waaaa?"
        AnchorLayout:
            padding: 5
            anchor_x: "right"
            anchor_y: "center"
            size_hint_x: None
            width: 50
            Button:
                border: 0,0,0,0
                background_normal: "data/backgrounds/next_car.png"
                background_down: "data/backgrounds/next_car_down.png"
                on_release:
                    report_car.load_next()

    BoxLayout:
        padding: 10
        Carousel:
            id: report_car

    BoxLayout:
        size_hint_y: None
        height: 30
        orientation: "horizontal"
        spacing: 10
        TFOKButon:
            id: ok_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Go to Results"
            on_release:
                app.screen.ids.explore.dispatch("on_release")
                app.screen.ids.explore.state = "down"
        TFOKButon:
            id: cancel_bt
            text: "Close"
            on_release:
                root.cancel()

<OrtoReportBox@BoxLayout>:
    orientation: "vertical"
    ExecLabel:
        id: total_orts
    ExecLabel:
        id: genet_orts
    ExecLabel:
        id: spt_orts
    ExecLabel:
        id: twot_orts

<OrtoFilterDialog>:
    orientation: "vertical"
    spacing: 20
    padding: 10
    BoxLayout:
        orientation: "vertical"
        spacing: 10
        BoxLayout:
            size_hint_y: None
            height: 30
            spacing: 5
            Label:
                size_hint_x: .8
                text: "Maximum number of gene copies:"
                halign: "left"
                valign: "middle"
                text_size: self.size
            TFTextInput:
                id: gene_txt
                size_hint_x: .2
                text: str(app.orto_max_gene)
        BoxLayout:
            size_hint_y: None
            height: 30
            spacing: 5
            Label:
                size_hint_x: .8
                text: "Minimum number of taxa:"
                halign: "left"
                valign: "middle"
                text_size: self.size
            TFTextInput:
                id: sp_txt
                size_hint_x: .2
                text: str(app.orto_min_sp)

    BoxLayout:
        size_hint_y: None
        height: 30
        orientation: "horizontal"
        spacing: 10
        TFOKButon:
            id: ok_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Ok"
            on_release:
                app.save_ortho_filters(gene_txt.text, sp_txt.text)
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release:
                root.cancel()

<InflationDialog>:
    orientation: "vertical"
    spacing: 10
    padding: 10
    BoxLayout:
        size_hint_y: None
        height: 30
        spacing: 10
        Label:
            size_hint_x: .6
            text: "Select one or more inflation values:"
            halign: "left"
            valign: "middle"
            text_size: self.size

    BoxLayout:
        id: inflation_bx
        size_hint_y: None
        height: 30
        ToggleButton:
            text: "1.5"
        ToggleButton:
            text: "2"
        ToggleButton:
            state: "down"
            text: "3"
        ToggleButton:
            text: "4"
        ToggleButton:
            text: "5"

    Widget:
        size_hint_y: None
        height: 10

    BoxLayout:
        size_hint_y: None
        height: 30
        orientation: "horizontal"
        spacing: 10
        TFOKButon:
            id: ok_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Ok"
            on_release:
                app.save_inflation(inflation_bx)
                root.cancel()
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release: root.cancel()

<MySQLDialog>:
    orientation: "vertical"
    padding: 10
    spacing: 10
    TFTextInput:
        id: txt_dlg
        password: True
        focus: True
    BoxLayout:
        size_hint_y: None
        height: 30
        orientation: "horizontal"
        spacing: 10
        TFOKButon:
            id: ok_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Ok"
            on_release:
                app.save_mysql_pass(txt_dlg.text)
                root.cancel()
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release: root.cancel()

<ProteinFilterDialog>:
    padding: 10
    spacing: 10
    orientation: "vertical"
    BoxLayout:
        size_hint_y: None
        height: 30
        Label:
            size_hint_x: .7
            text: "Minimum sequence length:"
        TFTextInput:
            size_hint_x: .3
            id: txt_len
            text: str(app.protein_min_len)
    BoxLayout:
        size_hint_y: None
        height: 30
        Label:
            size_hint_x: .7
            text: "Maximum codon stops (%):"
        TFTextInput:
            size_hint_x: .3
            id: txt_stop
            text: str(app.protein_max_stop)
    BoxLayout:
        size_hint_y: None
        height: 30
        orientation: "horizontal"
        spacing: 10
        TFOKButon:
            id: ok_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Ok"
            on_release:
                app.save_protein_filters(txt_len.text, txt_stop.text)
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release: root.cancel()

<OrthologySearchGrid>:
    do_default_tab: False
    tab_pos: "top_left"
    bt_wdt: 250
    background_color: (0,0,0,0)
    opacity: 0

    TabbedPanelItem:
        id: main_tab
        text: "Filtering"

        GridLayout:
            id: protein_filter
            cols: 1
            padding: 5
            spacing: 5

            LightBox:
                Label:
                    markup: True
                    text: "[size=15][b]Sequence quality control[/b][/size]"
                    halign: "left"
                    valign: "middle"
                    color: [.85, .85, .85, 1]
                    text_size: self.size

            DarkBox:
                Label:
                    markup: True
                    text: "[size=18][b]Filter protein sequences[/b][/size]\n[size=13]Set filters to remove poor quality sequences based on sequence length and stop codon percentage.[/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size

                BoxLayout:
                    #padding: (0, 7.5, 0, 7.5)
                    size_hint_x: None
                    width: root.bt_wdt
                    ProcessBt:
                        text: "Set filters"
                        on_release:
                            app.dialog_protein_filter()

    TabbedPanelItem:
        id: partition_tab
        text: "USEARCH"

        GridLayout:
            id: usearch_tab
            cols: 1
            padding: 5
            spacing: 5
            opacity: 1

            DarkBox:
                BoxLayout:
                    id: usearch_check
                    padding: 10, 0
                    spacing: 10
                    background_src: "data/backgrounds/green_noise.png"
                    canvas.before:
                        Color:
                            rgba: 1,1,1,1
                        Rectangle:
                            source: self.background_src
                            pos: self.pos
                            size: self.size
                    BoxLayout:
                        id: usearch_check_ico
                        size_hint_x: None
                        width: 20
                        icon_src: "data/backgrounds/check_icon.png"
                        icon_size: (20, 16)
                        canvas:
                            Rectangle:
                                source: self.icon_src
                                size: self.icon_size
                                pos: (self.pos[0], self.pos[1] + 15)

                    Label:
                        id: usearch_check_lbl
                        bold: True
                        text: "USEARCH is installed and reachable"
                        halign: "left"
                        valign: "middle"
                        text_size: self.size
                    BoxLayout:
                        padding: 7.5
                        size_hint_x: None
                        width: 150
                        id: usearch_fix

            LightBox:
                Label:
                    markup: True
                    text: "[size=15][b]USEARCH options[/b][/size]"
                    halign: "left"
                    valign: "middle"
                    color: [.85, .85, .85, 1]
                    text_size: self.size

            DarkBox:
                Label:
                    markup: True
                    text: "[size=18][b]Database name[/b][/size]\n[size=13]Name of the database against which USEARCH will run.[/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                InfoBt:
                    width: 50
                    height: 50
                    on_release:
                        app.dialog_general_info("database_name")
                ProcessBt:
                    size_hint_x: None
                    width: root.bt_wdt
                    text: app.usearch_db
                    id: db_bt
                    on_release:
                        app.dialog_text("USEARCH database", "usearch_db")

            Hseparator

            DarkBox:
                Label:
                    markup: True
                    text: "[size=18][b]USEARCH output file[/b][/size]\n[size=13]Name of the file containing the search results of USEARCH.[/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size

                ProcessBt:
                    size_hint_x: None
                    width: root.bt_wdt
                    text: app.usearch_output
                    id: out_bt
                    on_release:
                        app.dialog_text("USEARCH output file", "usearch_out")

            Hseparator

            DarkBox:
                Label:
                    markup: True
                    text: "[size=18][b]E-value cutoff[/b][/size]\n[size=13]Set minimum necessary e-value cutoff to retain USEARCH hits.[/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size

                ProcessBt:
                    size_hint_x: None
                    width: root.bt_wdt
                    text: app.usearch_evalue
                    id: eval
                    on_release:
                        app.dialog_text("E-value cutoff value", "evalue")

    TabbedPanelItem:
        id: mcl_tab
        text: "MCL"

        GridLayout:
            id: mcl_grid
            cols: 1
            padding: 5
            spacing: 5
            opacity: 1

            DarkBox:
                BoxLayout:
                    id: mcl_check
                    padding: 10, 0
                    spacing: 10
                    background_src: "data/backgrounds/green_noise.png"
                    canvas.before:
                        Color:
                            rgba: 1,1,1,1
                        Rectangle:
                            source: self.background_src
                            pos: self.pos
                            size: self.size
                    BoxLayout:
                        id: mcl_check_ico
                        size_hint_x: None
                        width: 20
                        icon_src: "data/backgrounds/check_icon.png"
                        icon_size: (20, 16)
                        canvas:
                            Rectangle:
                                source: self.icon_src
                                size: self.icon_size
                                pos: (self.pos[0], self.pos[1] + 15)

                    Label:
                        id: mcl_check_lbl
                        bold: True
                        text: "MCL is installed and reachable"
                        halign: "left"
                        valign: "middle"
                        text_size: self.size
                    BoxLayout:
                        padding: 7.5
                        size_hint_x: None
                        width: 150
                        id: mcl_fix_box

            LightBox:
                Label:
                    markup: True
                    text: "[size=15][b]MCL options[/b][/size]"
                    halign: "left"
                    valign: "middle"
                    color: [.85, .85, .85, 1]
                    text_size: self.size

            DarkBox:
                Label:
                    markup: True
                    text: "[size=18][b]Inflation[/b][/size]\n[size=13]Set one or more inflation values for MCL run.[/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                InfoBt:
                    width: 50
                    height: 50
                    on_release:
                        app.dialog_general_info("inflation")
                ProcessBt:
                    size_hint_x: None
                    width: root.bt_wdt
                    id: inflation_bt
                    text: "['3']"
                    on_release:
                        app.dialog_inflation()

            Hseparator

            DarkBox:
                Label:
                    markup: True
                    text: "[size=18][b]Ortholog group prefix[/b][/size]\n[size=13]Set a prefix name for the ortholog groups detected by OrthoMCL.[/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size

                ProcessBt:
                    size_hint_x: None
                    width: root.bt_wdt
                    text: app.ortholog_prefix
                    id: orto_group
                    on_release:
                        app.dialog_text("Prefix for ortholog groups", "orto_group")

            Hseparator

            DarkBox:
                height: 70
                Label:
                    markup: True
                    text: "[size=18][b]Groups file[/b][/size]\n[size=13]Set the name for the final output of OrthoMCL containing the ortholog groups. If more than one inflation values were specified, this name will be used as a prefix[/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size

                BoxLayout:
                    size_hint_x: None
                    width: root.bt_wdt
                    padding: (0, 7.5, 0, 7.5)
                    ProcessBt:
                        text: app.group_prefix
                        id: group_prefix
                        on_release:
                            app.dialog_text("Groups file name", "groups")

<LoadMultipleDialog>:
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        spacing: 10
        padding: 10

        BoxLayout:
            size_hint_y: None
            height: 30
            spacing: 5
            ToggleButton:
                id: path_toggle
                border: (0,0,0,0)
                background_normal: "data/backgrounds/path_off.png"
                background_down: "data/backgrounds/path_on.png"
                size_hint_x: None
                width: 30
                on_release:
                    if self.state == "down": app.switch_path_wgt("text", path_bx, sd_filechooser)
                    if self.state == "normal": app.switch_path_wgt("label", path_bx, sd_filechooser)
            BoxLayout:
                id: path_bx
                PathLabel:
                    text: sd_filechooser.path
            Button:
                size_hint_x: None
                width: 30
                border: 0,0,0,0
                background_normal: "data/backgrounds/refresh2.png"
                background_down: "data/backgrounds/refresh2_down.png"
                on_release:
                    sd_filechooser._update_files(path=sd_filechooser.path)
            Button:
                size_hint_x: None
                width: 30
                border: 0,0,0,0
                background_normal: "data/backgrounds/prev_dir.png"
                background_down: "data/backgrounds/prev_dir_down.png"
                on_release:
                    if sd_filechooser.previous_dir:\
                    sd_filechooser.path = sd_filechooser.previous_dir[-1]; sd_filechooser.previous_dir.pop(-1)
            Button:
                size_hint_x: None
                width: 30
                border: 0,0,0,0
                background_normal: "data/backgrounds/up_dir_bt.png"
                background_down: "data/backgrounds/up_dir_bt_down.png"
                on_release:
                    sd_filechooser.path = os.path.abspath(os.path.join(sd_filechooser.path, os.path.pardir))
            Button:
                bold: True
                size_hint_x: None
                width: 30
                border: 0,0,0,0
                background_normal: "data/backgrounds/create_dir.png"
                background_down: "data/backgrounds/create_dir_down.png"
                on_release:
                    app.dialog_text("New folder", "new_folder")

        BoxLayout:
            spacing: 10
            BoxLayout:
                orientation: "vertical"
                spacing: 10
                size_hint_x: None
                width: 200

                BoxLayout:
                    size_hint_y: None
                    height: 40
                    canvas.before:
                        Color:
                            rgba: tm.c_filechooser_headers
                        Rectangle:
                            pos: self.pos
                            size: self.size
                    Label:
                        text: " My Computer"
                        bold: True
                        halign: "center"
                        valign: "middle"
                        text_size: self.size
                        font_size: 18

                ScrollView:
                    size_hint_y: None
                    height: sum([x.height + 10 for x in sv_mycomp.children]) if sum([x.height + 10 for x in sv_mycomp.children]) < 200 else 200
                    GridLayout:
                        size_hint_y: None
                        height: sum([x.height + 10 for x in self.children])
                        cols: 1
                        id: sv_mycomp
                        orientation: "vertical"
                        padding: 5
                        spacing: [10, 10]

                BoxLayout:
                    size_hint_y: None
                    height: 40
                    canvas.before:
                        Color:
                            rgba: tm.c_filechooser_headers
                        Rectangle:
                            pos: self.pos
                            size: self.size
                    Label:
                        text: " Bookmarks"
                        bold: True
                        halign: "center"
                        valign: "middle"
                        text_size: self.size
                        font_size: 18

                    AnchorLayout:
                        size_hint: None, None
                        size: 40, 40
                        Button:
                            size_hint: None, None
                            size: 30, 30
                            border: 0,0,0,0
                            background_normal: "data/backgrounds/add_bt30.png"
                            background_down: "data/backgrounds/add_bt30_down.png"
                            on_release:
                                app.save_bookmark(sd_filechooser.path, bookmark_gl, sd_filechooser)

                ScrollView:
                    bar_width: 10
                    scroll_type: ["bars"]
                    GridLayout:
                        size_hint_y: None
                        height: sum([x.height + 10 for x in self.children]) / 2
                        cols: 2
                        orientation: "vertical"
                        spacing: [5, 10]
                        id: bookmark_gl

            BoxLayout:
                orientation: "vertical"
                spacing: 5

                FileChooserM:
                    id: sd_filechooser
                    previous_dir: []
                    text: "master"
                    dirselect: True
                    multiselect: True
                    path: app.home_path
                    f: sd_filechooser.path + "*"
                    filters: [self.f]
                    filter_dirs: False
                    on_double_click:
                        ok_bt.dispatch("on_release")
                    on_dir_entry:
                        text_filter.text = ""
                        self.previous_dir.append(self.path)

                BoxLayout:
                    size_hint_y: None
                    height: 30
                    spacing: 5

                    Label:
                        canvas.before:
                            Color:
                                rgba: (.2,.2,.2,1)
                            Rectangle:
                                pos: self.pos
                                size: self.size
                        size_hint_x: None
                        width: 100
                        text: "Find:"
                        bold: True
                    ToggleButton:
                        id: case_bt
                        text: "Aa"
                        bold:True
                        size_hint_x: None
                        width: 40
                        state: "down"

                    TFTextInput:
                        id: text_filter
                        multiline: False
                        on_text:
                            if case_bt.state == "normal": sd_filechooser.f = sd_filechooser.path + "*"+"".join(["["+x.upper()+x.lower()+"]" for x in self.text])+"*"; sd_filechooser.filter_dirs = True
                            if case_bt.state == "down": sd_filechooser.f = sd_filechooser.path + "*"+self.text+"*"; sd_filechooser.filter_dirs = True
                            if self.text == "": sd_filechooser.filter_dirs = False

                        on_text_validate:
                            focus = True

        AnchorLayout:
            size_hint_y: None
            height: 30
            BoxLayout:
                spacing: 20
                size_hint_x: None
                width: 420

                TFOKButon:
                    background_normal: "data/backgrounds/bt_process.png"
                    background_down: "data/backgrounds/bt_process_off.png"
                    text: "Load"
                    id: ok_bt
                    on_release:
                        if sd_filechooser.selection:\
                        app.run_in_background(load_group_files, app.load_groups, [list(sd_filechooser.selection), app.temp_dir, "use_ns"], None, False, "Loading group files...")
                        #root.cancel()

                TFOKButon:
                    id: cancel_bt
                    text: "Cancel"
                    on_release: root.cancel()

#===============================================================================
# PROCESS EXECUTION SUMMARY
#===============================================================================

<ExecLabel@Label>:
    halign: "left"
    valign: "middle"
    text_size: self.size
    markup: True
    font_size: 16

<LoadSpinner>:
    AnchorLayout:
        pos_hint: {"x": -.1, "y": -.1}
        ScatterLayout:
            do_translation: False
            do_scale: False
            do_rotation: False
            id: img
            Image:
                mipmap: True
                source: "data/backgrounds/loading_40px.png"

<ProgressWaiting>:
    size_hint: None, None
    size: 35, 27
    source: "data/backgrounds/waiting.png"

<LoadCounter>:
    text: "0%"
    size_hint: None, None
    size: 26, 26
    font_size: 12

<ProgressFinished>:
    size_hint: None, None
    size: 35, 27
    source: "data/backgrounds/check_green.png"

<ProgressBox>:
    orientation: "vertical"
    size_hint_y: None
    height: 40
    spacing: 10

    FloatLayout:
        size_hint: None, None
        size: 40, 40
        AnchorLayout:
            pos_hint: {"x": 0.35, "y": -1.2}
            size_hint: None, None
            size: 40, 40
            anchor_x: "center"
            anchor_y: "center"
            id: load_box
            ProgressWaiting

    BoxLayout:
        size_hint_y: None
        height: 45
        orientation: "vertical"
        padding: [70, 0, 0, 0]
        Label:
            id: main_lbl
            text: ""
            bold: True
            size_hint_y: None
            height: 30
            text_size: self.size
            halign: "left"
            valign: "middle"
            color: .7, .7, .7, 1
        Label:
            id: secondary_lbl
            text: ""
            bold: True
            size_hint_y: None
            height: 15
            text_size: self.size
            halign: "left"
            valign: "middle"
            font_size: 12
            shorten: True
            shorten_from: "right"
            color: .7, .7, .7, 1

<ProcessExecutionProgress>:
    padding: 10
    orientation: "vertical"

    BoxLayout:
        BoxLayout:
            orientation: "vertical"
            Label:
                text: "Main output"
                bold: True
                size_hint_y: None
                height: 30
                text_size: self.size
                halign: "center"
                valign: "middle"
                font_size: 18
                color: app._blue

            Widget:
                size_hint_y: None
                height: 10

            GridLayout:
                orientation: "vertical"
                spacing: 10
                cols: 1
                id: main_box


        BoxLayout:
            id: additional_outputs
            orientation: "vertical"
            Label:
                text: "Additional outputs"
                bold: True
                size_hint_y: None
                height: 30
                text_size: self.size
                halign: "center"
                valign: "middle"
                font_size: 18
                color: app._blue

            Widget:
                size_hint_y: None
                height: 10

            GridLayout:
                orientation: "vertical"
                spacing: 10
                cols: 1
                id: ad_box


    BoxLayout:
        size_hint_y: None
        height: 30
        AnchorLayout:
            TFOKButon:
                size_hint_x: None
                width: 150
                id: cancel_bt
                text: "Cancel"
                on_release:

<ExecutionDialog>:
    padding: 10
    orientation: "vertical"
    spacing: 10
    BoxLayout:
        padding: 10
        orientation: "vertical"
        ExecLabel:
            id: main_op
        ExecLabel:
            id: sec_op
        ExecLabel:
            id: out_form
        ExecLabel:
            id: out_files
    Label:
        size_hint_y:None
        height: 30
        bold: True
        text: "[color=37abc8ff]Do you want to proceed?[/color]"
        markup: True
    BoxLayout:
        size_hint_y: None
        height: 40
        padding: (50, 0, 50, 0)
        spacing: 20
        TFOKButon:
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Execute"
            id: ok_bt
            on_release:
                app.process_exec()
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release:
                root.cancel()

<DoneDialog@BoxLayout>:
    orientation: "vertical"
    id: check
    text: None
    BoxLayout:
        padding: 10
        Label:
            canvas.before:
                Color:
                    rgba: (.2, .2, .2, 1)
                Rectangle:
                    pos: self.pos
                    size: self.size
            valign: "middle"
            halign: "center"
            text_size: (self.size[0] - 5, self.size[1])
            text: "All done!"
    BoxLayout:
        size_hint_y: None
        height: 30
        padding: (30, 0, 30, 0)
        TFOKButon:
            id: close_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Close"
            on_release:
                root.cancel()

#===============================================================================
# TAXA GROUP CREATION
#===============================================================================

<DataSetTriageDialog>:
    orientation: "vertical"
    padding: 10
    spacing: 20
    ds_type: ""
    popup_level: 1
    BoxLayout:
        spacing: 20
        TFOKButon:
            halign: "center"
            valign: "middle"
            shorten: True
            shorten_from: "left"
            text_size: self.size
            text: "Set from file"
            size_hint_y: None
            height: 60
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            on_release:
                root.cancel()
                app.dialog_create_group_from_file(root.ds_type)
        TFOKButon:
            halign: "center"
            valign: "middle"
            shorten: True
            shorten_from: "left"
            text_size: self.size
            text: "Set manually"
            size_hint_y: None
            height: 60
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            on_release:
                root.cancel()
                app.dialog_taxagroup(root.ds_type, root.popup_level)
    BoxLayout:
        size_hint_y: None
        height: 30
        padding: (30, 0, 30, 0)
        TFOKButon:
            id: close_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Close"
            on_release:
                root.cancel()

<TaxaGroupDialog>:
    orientation: "vertical"
    padding: 10
    spacing: 10
    ds_type: ""
    BoxLayout:
        orientation: "vertical"
        spacing: 10

        BoxLayout:
            size_hint_y: None
            height: 30
            BoxLayout:
                spacing: 10
                Label:
                    text: "Set group name:"
                    bold: True
                    size_hint_x: None
                    width: 120
                    text_size: self.size
                    halign: "left"
                    valign: "middle"
                TFTextInput:
                    size_hint_x: .8
                    id: group_name
                    text: "untitled_1"
                    multiline: False

        BoxLayout:
            spacing: 10

            BoxLayout:
                size_hint_x: None
                width: 200
                orientation: "vertical"
                spacing: 2.5
                BoxLayout:
                    size_hint_y: None
                    height: 40
                    canvas.before:
                        Color:
                            rgba: (0.3, 0.3, 0.3, .8)
                        Rectangle:
                            pos: self.pos
                            size: self.size
                    Label:
                        text: " Created groups"
                        bold: True
                        halign: "center"
                        valign: "middle"
                        text_size: self.size
                        font_size: 14
                Hseparator

                ScrollView:
                    bar_width: 10
                    scroll_type: ["bars"]
                    GridLayout:
                        id: group_list
                        ds: root.ds_type
                        cols: 2
                        padding: [5, 5, 12, 5]
                        spacing: [5, 5]
                        height: self.minimum_height
                        size_hint_y: None
                        Button:
                            disabled: True
                            text: "No groups created"
                            bold: True
                            size_hint_y: None
                            height: 35

            Vseparator

            BoxLayout:
                orientation: "vertical"
                spacing: 10

                BoxLayout:
                    BoxLayout:
                        spacing: 2.5
                        orientation: "vertical"
                        Label:
                            canvas.before:
                                Color:
                                    rgba: .2, .2, .2, 1
                                Rectangle:
                                    pos: self.pos
                                    size: self.size
                            text: "Selected taxa" if root.ds_type == "taxa" else "Selected files"
                            size_hint_y: None
                            height: 40
                            bold: True
                        Hseparator
                        ScrollView:
                            bar_width: 10
                            scroll_type: ["bars", "content"]
                            canvas.before:
                                Color:
                                    rgba: .3, .3, .3, .5
                                Rectangle:
                                    pos: self.pos
                                    size: self.size
                            GridLayout:
                                id: select_grid
                                text: "select"
                                cols:1
                                size_hint_y: None
                                height: 0
                        Widget:
                            size_hint_y: None
                            height: 7.5
                        Label:
                            size_hint_y: None
                            height: 20
                            id: select_lbl
                            bold: True
                            color: (.4, .4, .4, 1)
                            text: "0 of {} selected".format(len(select_grid.children))
                        Widget:
                            size_hint_y: None
                            height: 7.5

                    BoxLayout:
                        orientation: "vertical"
                        size_hint_x: .30
                        spacing: 10
                        BoxLayout:
                            padding: 20
                            spacing: 20
                            orientation: "vertical"
                            Button:
                                background_down: "data/backgrounds/tg_addall.png"
                                background_normal: "data/backgrounds/tg_addall_down.png"
                                size_hint: (None, None)
                                size: (47,50)
                                border: (0,0,0,0)
                                on_release:
                                    app.taxagroup_move_taxa(root.ids.all_grid, root.ids.select_grid, True, root.ds_type)
                            Button:
                                background_down: "data/backgrounds/tg_add.png"
                                background_normal: "data/backgrounds/tg_add_down.png"
                                size_hint: (None, None)
                                size: (47,50)
                                on_release:
                                    app.taxagroup_move_taxa(root.ids.all_grid, root.ids.select_grid, False, root.ds_type)
                            Button:
                                background_down: "data/backgrounds/tg_remove.png"
                                background_normal: "data/backgrounds/tg_remove_down.png"
                                size_hint: (None, None)
                                size: (47,50)
                                on_release:
                                    app.taxagroup_move_taxa(root.ids.select_grid, root.ids.all_grid, False, root.ds_type)
                            Button:
                                background_down: "data/backgrounds/tg_removeall.png"
                                background_normal: "data/backgrounds/tg_removeall_down.png"
                                size_hint: (None, None)
                                size: (47,50)
                                on_release:
                                    app.taxagroup_move_taxa(root.ids.select_grid, root.ids.all_grid, True, root.ds_type)
                        Widget:
                            size_hint_y: .05
                    BoxLayout:
                        orientation: "vertical"
                        spacing: 2.5
                        Label:
                            canvas.before:
                                Color:
                                    rgba: .2, .2, .2, 1
                                Rectangle:
                                    pos: self.pos
                                    size: self.size
                            text: "All taxa" if root.ds_type == "taxa" else "All files"
                            size_hint_y: None
                            height: 40
                            bold: True
                        Hseparator
                        ScrollView:
                            bar_width: 10
                            scroll_type: ["bars", "content"]
                            canvas.before:
                                Color:
                                    rgba: .3, .3, .3, .5
                                Rectangle:
                                    pos: self.pos
                                    size: self.size
                            GridLayout:
                                id: all_grid
                                text: "all"
                                cols:1
                                size_hint_y: None
                                height: 0
                        Widget:
                            size_hint_y: None
                            height: 5
                        Label:
                            size_hint_y: None
                            id: all_lbl
                            height: 20
                            bold: True
                            text: "0 of {} selected".format(len(all_grid.children))
                            color: (.5, .5, .5, 1)
                        Widget:
                            size_hint_y: None
                            height: 5

        BoxLayout:
            size_hint_y: None
            height: 30
            spacing: 20
            TFOKButon:
                background_normal: "data/backgrounds/bt_process.png"
                background_down: "data/backgrounds/bt_process_off.png"
                id: ok_bt
                font_size: 16
                text: "Ok"
                on_release:
                    # Check for empty selected group
                    if not select_grid.children: \
                    root.cancel()
                    # Check for duplicate group name for taxa and file dialogs
                    elif root.ds_type == "taxa" and root.ids.group_name.text in app.taxa_groups: \
                    #app.dialog_floatcheck("Cannot create a data set group with a duplicate name. Please use a different name.", t="error")
                    app.check_action(text="The group '{}' already exists. Do you wish to modify it?".format(root.ids.group_name.text), func=app.save_dataset_group, args=[root.ids.select_grid, root.ids.group_name.text, root.ds_type], popup_level=2); root.cancel()
                    elif root.ds_type == "files" and root.ids.group_name.text in app.file_groups: \
                    app.check_action(text="The group '{}' already exists. Do you wish to modify it?".format(root.ids.group_name.text), func=app.save_dataset_group, args=[root.ids.select_grid, root.ids.group_name.text, root.ds_type], popup_level=2); root.cancel()
                    # Save group and quit dialog
                    elif root.ds_type == "taxa" and select_grid.children: \
                    root.cancel(); app.save_dataset_group(root.ids.select_grid, root.ids.group_name.text, root.ds_type)
                    elif root.ds_type == "files" and select_grid.children: \
                    root.cancel(); app.save_dataset_group(root.ids.select_grid, root.ids.group_name.text, root.ds_type)

            TFOKButon:
                id: apply_bt
                font_size: 16
                text: "Apply"
                on_release:
                    # Check for empty selected group
                    if not select_grid.children: \
                    app.dialog_floatcheck("Cannot create an empty data set group", t="error")
                    # Check for duplicate group name for taxa and file dialogs
                    elif root.ds_type == "taxa" and root.ids.group_name.text in app.taxa_groups: \
                    app.check_action(text="The group '{}' already exists. Do you wish to modify it?".format(root.ids.group_name.text), func=app.save_dataset_group, args=[root.ids.select_grid, root.ids.group_name.text, root.ds_type], popup_level=2)
                    elif root.ds_type == "files" and root.ids.group_name.text in app.file_groups: \
                    app.check_action(text="The group '{}' already exists. Do you wish to modify it?".format(root.ids.group_name.text), func=app.save_dataset_group, args=[root.ids.select_grid, root.ids.group_name.text, root.ds_type], popup_level=2)
                    ## Save group
                    elif root.ds_type == "taxa" and select_grid.children: \
                    app.save_dataset_group(root.ids.select_grid, root.ids.group_name.text, root.ds_type)
                    elif root.ds_type == "files" and select_grid.children: \
                    app.save_dataset_group(root.ids.select_grid, root.ids.group_name.text, root.ds_type)
            TFOKButon:
                id: cancel_bt
                font_size: 16
                text: "Cancel"
                on_release:
                    root.cancel()

#===============================================================================
# GENERAL SAVE FILE
#===============================================================================

<SaveDialog>:
    # Tracks the load dialogs. Id's on this list will change the default Save
    # button to Load
    load_dlgs: ["import_partitions", "partition_file", "select_from_file", "remove_from_file"]
    no_auto_close: ["protein", "nucleotide", "group", "taxa", "files", "main_output", "export", "export_table", "group", "export_graphic"]
    file_required: ["protein_db", "import_partitions", "partition_file", "select_from_file", "remove_from_file", "files", "mcl_fix", "usearch_fix"]
    bw: False
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        spacing: 10
        padding: 10

        BoxLayout:
            size_hint_y: None
            height: 30
            spacing: 5
            ToggleButton:
                id: path_toggle
                border: (0,0,0,0)
                background_normal: "data/backgrounds/path_off.png"
                background_down: "data/backgrounds/path_on.png"
                size_hint_x: None
                width: 30
                on_release:
                    if self.state == "down": app.switch_path_wgt("text", path_bx, sd_filechooser)
                    if self.state == "normal": app.switch_path_wgt("label", path_bx, sd_filechooser)
            BoxLayout:
                id: path_bx
                PathLabel:
                    text: sd_filechooser.path
            Button:
                size_hint_x: None
                width: 30
                border: 0,0,0,0
                background_normal: "data/backgrounds/refresh2.png"
                background_down: "data/backgrounds/refresh2_down.png"
                on_release:
                    sd_filechooser._update_files(path=sd_filechooser.path)
            Button:
                size_hint_x: None
                width: 30
                border: 0,0,0,0
                background_normal: "data/backgrounds/prev_dir.png"
                background_down: "data/backgrounds/prev_dir_down.png"
                on_release:
                    if sd_filechooser.previous_dir:\
                    sd_filechooser.path = sd_filechooser.previous_dir[-1]; sd_filechooser.previous_dir.pop(-1)
            Button:
                size_hint_x: None
                width: 30
                border: 0,0,0,0
                background_normal: "data/backgrounds/up_dir_bt.png"
                background_down: "data/backgrounds/up_dir_bt_down.png"
                on_release:
                    sd_filechooser.path = os.path.abspath(os.path.join(sd_filechooser.path, os.path.pardir))
            Button:
                bold: True
                size_hint_x: None
                width: 30
                border: 0,0,0,0
                background_normal: "data/backgrounds/create_dir.png"
                background_down: "data/backgrounds/create_dir_down.png"
                on_release:
                    app.dialog_text("New folder", "new_folder")

        BoxLayout:
            spacing: 10
            BoxLayout:
                orientation: "vertical"
                spacing: 10
                size_hint_x: None
                width: 200

                BoxLayout:
                    size_hint_y: None
                    height: 40
                    canvas.before:
                        Color:
                            rgba: tm.c_filechooser_headers
                        Rectangle:
                            pos: self.pos
                            size: self.size
                    Label:
                        text: " My Computer"
                        bold: True
                        halign: "center"
                        valign: "middle"
                        text_size: self.size
                        font_size: 18

                ScrollView:
                    size_hint_y: None
                    height: sum([x.height + 10 for x in sv_mycomp.children]) if sum([x.height + 10 for x in sv_mycomp.children]) < 200 else 200
                    GridLayout:
                        size_hint_y: None
                        height: sum([x.height + 10 for x in self.children])
                        cols: 1
                        id: sv_mycomp
                        orientation: "vertical"
                        padding: 5
                        spacing: [10, 10]

                BoxLayout:
                    size_hint_y: None
                    height: 40
                    canvas.before:
                        Color:
                            rgba: tm.c_filechooser_headers
                        Rectangle:
                            pos: self.pos
                            size: self.size
                    Label:
                        text: " Bookmarks"
                        bold: True
                        halign: "center"
                        valign: "middle"
                        text_size: self.size
                        font_size: 18

                    AnchorLayout:
                        size_hint: None, None
                        size: 40, 40
                        Button:
                            size_hint: None, None
                            size: 30, 30
                            border: 0,0,0,0
                            background_normal: "data/backgrounds/add_bt30.png"
                            background_down: "data/backgrounds/add_bt30_down.png"
                            on_release:
                                app.save_bookmark(sd_filechooser.path, bookmark_gl, sd_filechooser, popup_level=2)

                ScrollView:
                    bar_width: 10
                    scroll_type: ["bars"]
                    GridLayout:
                        size_hint_y: None
                        height: sum([x.height + 10 for x in self.children]) / 2
                        cols: 2
                        orientation: "vertical"
                        spacing: [10, 10]
                        id: bookmark_gl

            BoxLayout:
                spacing: 10
                orientation: "vertical"
                FileChooserM:
                    id: sd_filechooser
                    previous_dir: []
                    text: "master"
                    dirselect: True
                    f: sd_filechooser.path + "*"
                    filters: [self.f]
                    filter_dirs: False
                    path: app.output_dir if app.output_dir else app._common_path() if app._common_path() else app.home_path

                    on_selection:
                        if txt_box.height == 30 and self.selection and not os.path.isdir(self.selection[0]): \
                        text_input.text = self.selection[0].split(os.sep)[-1]

                    on_double_click:
                        if self.text in root.load_dlgs and self.text != "main_output": \
                        ok_bt.dispatch("on_release")

                    on_dir_entry:
                        self.previous_dir.append(self.path)

                ScrollView:
                    size_hint_y: None
                    id: find_bx
                    height: 0
                    BoxLayout:
                        spacing: 5

                        Label:
                            size_hint_x: None
                            width: 50
                            text: "Find:"
                            bold: True
                        TGToggleButton:
                            id: case_bt
                            text: "Aa"
                            bold:True
                            size_hint_x: None
                            size: 40, 30
                            state: "down"

                        TFTextInput:
                            id: text_filter
                            multiline: False
                            on_text:
                                if case_bt.state == "normal": sd_filechooser.f = sd_filechooser.path + "*"+"".join(["["+x.upper()+x.lower()+"]" for x in self.text])+"*"; sd_filechooser.filter_dirs = True
                                if case_bt.state == "down": sd_filechooser.f = sd_filechooser.path + "*"+self.text+"*"; sd_filechooser.filter_dirs = True
                                if self.text == "": sd_filechooser.filter_dirs = False
                            on_text_validate:
                                focus = True

                        Button:
                            size_hint_x: None
                            width: 30
                            border: 0,0,0,0
                            background_normal: "data/backgrounds/clear_bt.png"
                            background_down: "data/backgrounds/clear_bt.png"
                            on_release:
                                find_bx.height = 0;
                                sd_filechooser.f = "*"
                                text_filter.text = ""
                                text_filter.focus = False
        BoxLayout:
            id: txt_box
            orientation: "horizontal"
            size_hint_y: None
            height: 30
            spacing: 5
            Label:
                id: txt_label
                size_hint_x: None
                width: 100
                bold: True
                text: "File name:"
            TFTextInput:
                id: text_input
                multiline: False

        AnchorLayout:
            size_hint_y: None
            height: 30
            BoxLayout:
                size_hint_x: None
                width: 420
                spacing: 20

                TFOKButon:
                    background_normal: "data/backgrounds/bt_process.png"
                    background_down: "data/backgrounds/bt_process_off.png"
                    text: "Load" if sd_filechooser.text in root.load_dlgs else "Save"
                    id: ok_bt
                    text_io: text_input.text if not None else ""
                    on_release:
                        # If an extension spinner is present in the dialog, append it to the text_input
                        if sd_filechooser.text == "export_graphic": \
                        filename = text_input.text + txt_box.ids.ext.text;
                        elif txt_box.height == 30 and txt_label.text == "File name:": \
                        filename = text_input.text
                        # For save dialogs requiring file name, make this check
                        if self.text_io == "" and txt_box.height == 30 and txt_label.text == "File name:": \
                        app.dialog_floatcheck(text="Please provide a file name", t="error")
                        elif txt_box.height != 0 and "bw" in txt_box.ids: \
                        app.check_file(sd_filechooser.path, filename, sd_filechooser.text, txt_box.ids.bw.children[-1].active)
                        # When converting
                        elif txt_box.height != 0 and txt_label.text == "Suffix:" and sd_filechooser.text == "main_output":\
                        app.save_file(sd_filechooser.path, suffix = text_input.text, idx = sd_filechooser.text); root.cancel()
                        elif txt_box.height != 0:\
                        app.check_file(sd_filechooser.path, filename, sd_filechooser.text)

                        # For save dialogs that do not require file names but require a file to be selected
                        elif sd_filechooser.text in root.file_required and not sd_filechooser.selection: \
                        app.dialog_floatcheck(text="Please select a file", t="error");

                        # For save dialogs that do not require file names
                        elif (sd_filechooser.text == "mcl_fix" or sd_filechooser.text == "usearch_fix") and txt_box.height == 0:\
                        app.save_file(sd_filechooser.selection[0], idx = sd_filechooser.text, auto_close=False)
                        elif sd_filechooser.text == "zorro_dir" and txt_box.height == 0:\
                        app.save_file(sd_filechooser.path, idx = sd_filechooser.text, auto_close=False); root.cancel()
                        elif sd_filechooser.text == "ima2_popfile" and txt_box.height == 0:\
                        app.save_file(sd_filechooser.selection[0], idx=sd_filechooser.text, auto_close=False); root.cancel()
                        elif sd_filechooser.text == "orto_report" and txt_box.height == 0:\
                        app.run_in_background(app.orto_generate_report, None, [sd_filechooser.path, "use_ns"], None, False, "Generating full report...")
                        elif sd_filechooser.text == "ortho_dir" and txt_box.height == 0: \
                        app.save_file(sd_filechooser.path, idx = sd_filechooser.text)
                        elif sd_filechooser.text == "protein_db" and txt_box.height == 0: \
                        app.save_file(sd_filechooser.selection, idx=sd_filechooser.text)
                        elif sd_filechooser.text == "cds_db" and txt_box.height == 0: \
                        app.save_file(sd_filechooser.selection, idx=sd_filechooser.text)
                        elif sd_filechooser.text == "orto_export_dir" and txt_box.height == 0: \
                        app.save_file(sd_filechooser.path, idx=sd_filechooser.text)
                        elif sd_filechooser.text == "protein" or sd_filechooser.text == "nucleotide": \
                        app.orto_export_groups(sd_filechooser.text, output_dir=sd_filechooser.path)
                        elif sd_filechooser.text == "import_partitions" and txt_box.height == 0: \
                        app.partitions_import_scheme(sd_filechooser.selection[0])
                        elif sd_filechooser.text == "partition_file" and txt_box.height == 0: \
                        app.save_reverseconc_partfile(sd_filechooser.selection[0])
                        elif sd_filechooser.text == "select_from_file" and txt_box.height == 0: \
                        app.select_bt_from_file(app.root.ids.main_tp.current_tab.text, sd_filechooser.selection[0])
                        elif sd_filechooser.text == "remove_from_file" and txt_box.height == 0: \
                        app.remove_bt_from_selection(app.root.ids.main_tp.current_tab.text, txt_file=sd_filechooser.selection[0])
                        elif sd_filechooser.text == "files" or sd_filechooser.text == "taxa" and txt_box.height == 0: \
                        root.cancel(); app.dataset_file = sd_filechooser.selection[0]; app.dialog_text("Name of the data set group", sd_filechooser.text)
                        # Close dialog
#                       if self.text_io != "" or txt_box.height == 0 and sd_filechooser.text not in root.no_auto_close: \
#                       root.cancel()

                TFOKButon:
                    id: cancel_bt
                    text: "Cancel"
                    on_release: root.cancel()

#===============================================================================
# ACTION BAR HEADERS
#===============================================================================

# Redefinition of ActionToggleButton to avoid black labels on binary versions
<ActionButton,-ActionToggleButton>:
    size_hint_x: None if not root.inside_group else 1
    width: [dp(48) if (root.icon and not root.inside_group) else max(dp(48), (self.texture_size[0] + dp(32))), self.size_hint_x][0]
    #color: self.color[:3] + [0 if (root.icon and not root.inside_group) else 1]

#    Image:
#        allow_stretch: True
#        opacity: 1 if (root.icon and not root.inside_group) else 0
#        source: root.icon
#        mipmap: root.mipmap
#        pos: root.x + dp(4), root.y + dp(4)
#        size: root.width - dp(8), root.height - sp(8)

<MainHeader@ActionToggleButton>:
    size_hint_x: 1
    font_size: 20
    bold: True
    mipmap: False
    disabled_color: (1, 1, 1, 1)

#===============================================================================
# SIDE PANEL WIDGETS
#===============================================================================

<SideButton@ToggleButton>:
    group: "side_buttons"
    size_hint_y: .1
    font_size: 30
    bold: True
    disabled_color: (1,1,1,1)
    border: (0,0,0,0)

<LoadMoreBt>:
    anchor_x: "left"
    size_hint_y:None
    height: 30
    TFOKButon:
        text: "Load next 20"
        size_hint_x: None
        width: 295
        on_release:
            app.sidepanel_load_more_bts(tab=root.tab)

<LoadMoreSearch>:
    anchor_x: "left"
    size_hint_y:None
    height: 30
    TFOKButon:
        text: "Next 20 results"
        size_hint_x: None
        width: 295
        on_release:
            app.sidepanel_load_more_search(tab=root.tab)

#===============================================================================
#                               PROCESS SCREEN
#===============================================================================

<ExecutionBt@Button>
    background_normal: "data/backgrounds/process_exec.png"
    background_down: "data/backgrounds/process_exec_down.png"
    border: 0,0,0,0
    bold: True
    halign: "center"
    valign: "middle"
    text_size: self.size
    font_size: 18
    color: (1,1,1,1)
    size_hint_y: None
    height: 45

#===============================================================================
# PARTITIONS
#===============================================================================

<DetailLabel@Label>:
    size_hint_y: None
    height: 30
    halign: "left"
    valign: "middle"
    text_size: self.size
    markup: True

<FieldLabel@Label>:
    size_hint_y: None
    height: 30
    bold: True
    halign: "left"
    valign: "top"
    text_size: self.size
    color: (0.216, 0.67, 0.784, 1)

<CodonSpinner@SpinnerOption>:
    markup: True
    bold: True
    on_release:
        app.set_codon_model(self.text)

<ModelSpinner>:
    bold: True
    text: "No model"
    values: ("No model", "JC", "F81", "K2P", "HKY", "SYM", "GTR")
    #background_normal: "data/backgrounds/model_bt1.png"

<PartitionsDialog>:
    id: partition_wgt
    padding: [30, 10, 10, 10]
    orientation: "vertical"
    spacing: 10
    original_name: ""

    canvas.before:
        Color:
            rgba: (1,1,1,1)
        Rectangle:
            source: "data/backgrounds/codon_background.png"
            pos: self.pos
            size: self.size

    BoxLayout:
        size_hint_y: None
        height: 60
        orientation: "vertical"
        FieldLabel:
            text: "Details"
        BoxLayout:
            spacing: 10
            TFTextInput:
                id: partition_name
                multiline: False
                size_hint_x: .7
                on_text_validate:
                    if root.original_name != self.text: \
                    app.partitions_change_name(root.original_name, self.text)
                    root.original_name = self.text
            Label:
                id: partition_lenght
                halign: "center"
                valign: "middle"
                text_size: self.size
                size_hint_x: .3
                bold: True

    BoxLayout:
        size_hint_y: None
        height: 60
        orientation: "vertical"
        FieldLabel:
            text: "Codon partitions"
        Spinner:
            id: codon_spin
            text: "No partition"
            markup: True
            bold: True
            option_cls: Factory.get("CodonSpinner")
            values: ("No partitions", "[color=ff5555ff]1[/color] + [color=37abc8ff]2[/color] + [color=71c837ff]3[/color]", "[color=ff5555ff](1 + 2)[/color] + [color=37abc8ff]3[/color]", "[color=ff5555ff]1[/color] + [color=37abc8ff](2 + 3)[/color]", "[color=ff5555ff](1 + 3)[/color] + [color=37abc8ff]2[/color]")

    BoxLayout:
        size_hint_y: None
        height: 60
        orientation: "vertical"
        id: model_bx
        FieldLabel:
            text: "Substitution model"
        BoxLayout:
            spacing: 5
            id: model_bx
            ModelSpinner:
                id: model_spin
    Widget:
        size_hint_y: None
        height: 1
    BoxLayout:
        size_hint_y: None
        height: 30
        spacing: 10
        AnchorLayout:
            BoxLayout:
                spacing: 10
                size_hint_x: None
                width: 190
                TFOKButon:
                    size_hint_x: None
                    width: 90
                    text: "Apply"
                    background_normal: "data/backgrounds/bt_process.png"
                    background_down: "data/backgrounds/bt_process_off.png"
                    on_release:
                        app.save_model(root.original_name, root)
                TFOKButon:
                    size_hint_x: None
                    width: 90
                    text: "Apply All"
                    on_release:
                        app.save_model(root.original_name, root, True)
    Widget:
        size_hint_y: None
        height: 1

<SplitPartitions>:
    orientation: "vertical"
    padding: 10
    spacing: 10
    BoxLayout:
        orientation: "vertical"
        size_hint_y: None
        height: 80
        spacing: 5
        FieldLabel:
            text: "Automatic split"
        AnchorLayout:
            size_hint_y: None
            height: 40
            Button:
                id: auto_split_bt
                size_hint_x: None
                width: 150
                text: "Split by files"
                bold: True
                background_normal: "data/backgrounds/bt_process.png"
                on_release:
                    app.partitions_split()

    BoxLayout:
        size_hint_y: None
        height: 115
        orientation: "vertical"
        FieldLabel:
            text: "Manual split"
        BoxLayout:
            spacing: 5
            size_hint_y: None
            height: 30
            Label:
                size_hint_x: None
                width: 30
                font_size: 12
                text: str(int(manual_slider.min))
            MySlider:
                id: manual_slider
            Label:
                size_hint_x: None
                width: 30
                font_size: 12
                text: str(int(manual_slider.max))
            TFTextInput:
                size_hint_x: None
                width: 50
                text: str(int(manual_slider.value))
                on_text_validate:
                    if app.check_partition_split(self.text, (manual_slider.min, manual_slider.max)): val = app.check_partition_split(self.text, (manual_slider.min, manual_slider.max))[1]; manual_slider.value = val; self.text = str(val)

        Widget:
            size_hint_y: None
            height: 10

        BoxLayout:
            size_hint_y: None
            height: 30
            spacing: 10
            TFTextInput:
                hint_text: "Partition 1 name"
                multiline: False
                id: part1
            TFTextInput:
                hint_text: "Partition 2 name"
                multiline: False
                id: part2

        Widget:
            size_hint_y: None
            height: 10

    AnchorLayout:
        anchor_x: "center"
        anchor_y: "center"
        size_hint_y: None
        height: 30
        BoxLayout:
            size_hint_x: None
            width: 220
            spacing: 20
            TFOKButon:
                background_normal: "data/backgrounds/bt_process.png"
                background_down: "data/backgrounds/bt_process_off.png"
                text: "Split"
                id: ok_bt
                size_hint_x: None
                width: 100
                on_release:
                    # Check if both partition names were provided
                    if not part1.text or not part2.text: \
                    app.dialog_floatcheck("Please provide the name for both manual partitions", t="error")

                    # Check whether the split position is not in the extremes
                    elif manual_slider.value == manual_slider.min or manual_slider.value == manual_slider.max: \
                    app.dialog_floatcheck("Split position cannot be the minimum or maximum value of the current partition", t="error")

                    # Check if partition names are different
                    elif part1.text == part2.text: \
                    app.dialog_floatcheck("Partition names must be different", t="error")

                    else: \
                    app.partitions_split([(int(manual_slider.min) - 1, int(manual_slider.value - 1)), (int(manual_slider.value), int(manual_slider.max))], [part1.text, part2.text])
            TFOKButon:
                text: "Cancel"
                id: cancel_bt
                size_hint_x: None
                width: 100
                on_release:
                    root.cancel()


<PartitionActiveDialog>:
    orientation: "vertical"
    spacing: 10
    padding: 10
    BoxLayout:
        size_hint_y: None
        height: 40
        spacing: 10
        TFOKButon:
            bold: True
            text: "Selected partitions"
            background_normal: "data/backgrounds/bt_process.png"
            on_release:
                app.dialog_filechooser("import_act_part")
        TFOKButon:
            bold: True
            text: "All partitions"
            background_normal: "data/backgrounds/bt_process.png"
            on_release:
                app.dialog_filechooser("import_all_part")


#===============================================================================
# PROCESS OUTPUT FORMAT
#===============================================================================

<SettingsBt@Button>:
    size_hint_x: None
    width: 40
    disabled: True
    border: 0,0,0,0
    background_normal: "data/backgrounds/settings.png"
    background_down: "data/backgrounds/settings_down.png"
    background_disabled_normal: "data/backgrounds/settings_disabled.png"


<InvalidFormatsWarning>:
    padding: 10
    orientation: "vertical"
    spacing: 10
    BoxLayout:
        orientation: "vertical"
        padding: 10
        Label:
            id: msg
            size_hint_y: None
            height: 30
            text_size: self.size
            halign: "justify"
            valign: "center"
        Label:
            id: fmts
            flist: None
            markup: True
            text: "\n".join(self.flist) if self.flist else ""
        Label:
            size_hint_y: None
            height: 30
            text_size: self.size
            halign: "justify"
            valign: "center"
            markup: True
            text: "Do you wish to [b]Ignore[/b] these formats and proceed?"

    AnchorLayout:
        size_hint_y: None
        height: 30
        BoxLayout:
            orientation: "horizontal"
            spacing: 10
            size_hint_x: None
            width: 200
            CheckBt:
                text: "Ignore"
                id: check_ok
                background_normal: "data/backgrounds/check_ok.png"
                background_down: "data/backgrounds/check_cancel.png"
                on_release:
                    root.cancel()
                    app.output_formats = [x for x in app.output_formats if x not in fmts.flist]
                    app.dialog_execution()

            CheckBt:
                text: "Cancel"
                background_normal: "data/backgrounds/check_ok.png"
                background_down: "data/backgrounds/check_cancel.png"
                id: check_cancel
                on_release:
                    root.cancel()


<FormatDialog>:
    padding: [30, 20, 20, 20]
    spacing: 25
    orientation: "vertical"
    id: format_dlg
    ScrollView:
        bar_width: 10
        scroll_type: ["bars"]
        GridLayout:
            cols: 1
            orientation: "vertical"
            spacing: 10
            size_hint_y: None
            height: self.minimum_height
            padding: [0, 0, 13, 0]
            Label:
                size_hint_y: None
                height: 15
                text_size: self.size
                halign: "left"
                valign: "bottom"
                text: "All operations"
                font_size: 14
                bold: True
            Hseparator:
                c: app._blue
            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 10
                TGToggleButton:
                    height: 40
                    background_normal: "data/backgrounds/bt_process_off.png"
                    background_down: "data/backgrounds/bt_process.png"
                    id: fasta
                    state: "down"
                    text: "Fasta"
                SettingsBt:
                    disabled: False
                    on_release:
                        app.dialog_fasta_extra()
            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 10
                TGToggleButton:
                    height: 40
                    background_normal: "data/backgrounds/bt_process_off.png"
                    background_down: "data/backgrounds/bt_process.png"
                    id: phylip
                    text: "Phylip"
                SettingsBt:
                    disabled: False
                    on_release:
                        app.dialog_phylip_extra()
            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 10
                TGToggleButton:
                    height: 40
                    background_normal: "data/backgrounds/bt_process_off.png"
                    background_down: "data/backgrounds/bt_process.png"
                    id: nexus
                    text: "Nexus"
                SettingsBt:
                    disabled: False
                    on_release:
                        app.dialog_nexus_extra()

            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 10
                TGToggleButton:
                    height: 40
                    background_normal: "data/backgrounds/bt_process_off.png"
                    background_down: "data/backgrounds/bt_process.png"
                    id: stockholm
                    text: "Stockholm"
                SettingsBt
            Label:
                size_hint_y: None
                height: 20
                text_size: self.size
                halign: "left"
                valign: "bottom"
                text: "Concatenation only"
                font_size: 14
                bold: True
            Hseparator:
                c: app._blue
            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 10
                TGToggleButton:
                    height: 40
                    background_normal: "data/backgrounds/bt_process_off.png"
                    background_down: "data/backgrounds/bt_process.png"
                    id: mcmctree
                    text: "MCMCTree"
                SettingsBt

            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 10
                TGToggleButton:
                    height: 40
                    background_normal: "data/backgrounds/bt_process_off.png"
                    background_down: "data/backgrounds/bt_process.png"
                    id: gphocs
                    text: "GPhoCS"
                SettingsBt
            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 10
                TGToggleButton:
                    height: 40
                    background_disabled_normal: "data/backgrounds/bt_process_disabled.png"
                    id: ima2
                    text: "IMa2"
                SettingsBt:
                    disabled: False
                    on_release:
                        app.dialog_ima2_extra(popup_level=2)
            BoxLayout:
                size_hint_y: None
                height: 40
                spacing: 10
                TGToggleButton:
                    height: 40
                    background_normal: "data/backgrounds/bt_process_off.png"
                    background_down: "data/backgrounds/bt_process.png"
                    id: snapp
                    text: "SNAPP"
                SettingsBt
    BoxLayout:
        orientation: "horizontal"
        size_hint_y: None
        height: 30
        spacing: 10
        padding: (10, 0, 10, 0)
        TFOKButon:
            id: ok_bt
            text: "Ok"
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            on_release: app.save_format(format_dlg)
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release: root.cancel()

<NexusExtra>:
    padding: 10
    spacing: 10
    orientation: "vertical"
    BoxLayout:
        size_hint_y: None
        height: 40
        Label:
            halign: "left"
            valign: "middle"
            text_size: self.size
            text: "Write the partitions block, if any."
        CheckBox:
            id: nexus_check
            size_hint_x: .2

    BoxLayout:
        size_hint_y: None
        height: 40
        Label:
            halign: "left"
            valign: "middle"
            text_size: self.size
            text: "Write the substitution model block, if any."
        CheckBox:
            id: nexus_model_check
            size_hint_x: .2

    BoxLayout:
        size_hint_y: None
        height: 30
        orientation: "horizontal"
        spacing: 20
        TFOKButon:
            id: ok_bt
            text: "Ok"
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            on_release:
                app.use_nexus_partitions = nexus_check.active
                app.dismiss_subpopup()
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release: root.cancel()

<FastaExtra>:
    padding: 10
    spacing: 10
    orientation: "vertical"

    BoxLayout:
        size_hint_y: None
        height: 40

        Label:
            text: "Produce Fasta compliant with LDhat"
            halign:"left"
            valign: "middle"
            text_size: self.size
        CheckBox:
            id: ldhat_check
            size_hint_x: .2

    BoxLayout:
        size_hint_y: None
        height: 30
        orientation: "horizontal"
        spacing: 20
        TFOKButon:
            id: ok_bt
            text: "Ok"
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            on_release:
                app.ld_hat = ldhat_check.active
                app.dismiss_subpopup()
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release: root.cancel()

<PhylipExtra>:
    padding: 10
    spacing: 10
    orientation: "vertical"
    BoxLayout:
        size_hint_y: None
        height: 40
        Label:
            text: "Create partition file when concatenating"
            halign: "left"
            valign: "middle"
            text_size: self.size
        CheckBox:
            id: part_check
            size_hint_x: .2

    Hseparator

    BoxLayout:
        size_hint_y: None
        height: 40
        Label:
            text: "Truncate taxa names at 10 characters"
            halign: "left"
            valign: "middle"
            text_size: self.size
        CheckBox:
            id: trunc_names_check
            size_hint_x: .2

    BoxLayout:
        size_hint_y: None
        height: 30
        orientation: "horizontal"
        spacing: 20
        TFOKButon:
            id: ok_bt
            text: "Ok"
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            on_release:
                app.create_partfile = part_check.active
                app.phylip_truncate_name = trunc_names_check.active
                app.dismiss_subpopup()
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release: root.cancel()

<IMa2Extra>:
    padding: 20
    spacing: 15
    orientation: "vertical"

    # Population file
    BoxLayout:
        size_hint_y: None
        height: 30
        Label:
            text: "Population assignment file"
            halign: "left"
            valign: "middle"
            text_size: self.size
        TFButton:
            id: popfile
            size_hint_x: .6
            text: "Select" if not app.ima2_options[0] else os.path.basename(app.ima2_options[0])
            on_release:
                app.dialog_filechooser("ima2_popfile", popup_level=3)

    # Population tree
    BoxLayout:
        size_hint_y: None
        height: 30
        Label:
            text: "Population tree string"
            halign: "left"
            valign: "middle"
            text_size: self.size
        TFTextInput:
            id: pop_string
            size_hint_x: .6

    # Mutational model
    BoxLayout:
        size_hint_y: None
        height: 30
        Label:
            text: "Set mutational model"
            halign: "left"
            valign: "middle"
            text_size: self.size
        PlotSpinner:
            id: mutation
            size_hint_x: .6
            text: "IS"
            option_cls: Factory.get("PlotOpt")
            values: ("IS", "HKY", "SSM", "Join SSM", "HapSTR")

    # Inheritance
    BoxLayout:
        size_hint_y: None
        height: 30
        Label:
            text: "Set inheritance scalar"
            halign: "left"
            valign: "middle"
            text_size: self.size
        TFTextInput:
            id: inheritance
            size_hint_x: .6
            text: "1"

    BoxLayout:
        size_hint_y: None
        height: 30
        orientation: "horizontal"
        spacing: 20
        TFOKButon:
            id: ok_bt
            text: "Ok"
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            on_release:
                app.save_ima2_opts(pop_string.text, mutation.text, inheritance.text)

        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release:
                root.cancel()
                if None in app.ima2_options and "ima2" in app.output_formats:\
                app.output_formats.remove("ima2")


#===============================================================================
# PROCESS FORMATTING ADDITIONAL OPTIONS
#===============================================================================

<ZorroDialog>:
    orientation: "vertical"
    padding: 10
    spacing: 15
    Switch:
        id: zorro_switch
    BoxLayout:
        spacing: 10
        size_hint_y: None
        height: 30
        Label:
            valign: "middle"
            halign: "left"
            text_size: self.size
            text: "ZORRO files suffix:"
            bold: True
        TFTextInput:
            id: zorro_txt
            multiline: False
            size_hint_x: None
            disabled: True if not zorro_switch.active else False
            width: 150
    BoxLayout:
        size_hint_y: None
        height: 50
        orientation: "vertical"
        spacing: 3
        BoxLayout:
            Label:
                valign: "middle"
                halign: "left"
                text_size: self.size
                text: "ZORRO files directory:"
                bold: True
            TFButton:
                id: zorro_dir
                size_hint_x: None
                width: 150
                text: "Select" if not app.zorro_dir else os.path.basename(app.zorro_dir)
                disabled: True if not zorro_switch.active else False
                on_release:
                    app.dialog_filechooser("zorro_dir", popup_level=2)

        Label:
            size_hint_y: None
            valign: "middle"
            halign: "right"
            bold: True
            text_size: self.size
            height: 15
            font_size: 12
            color: (.7,.7,.7,1)
            text: "By default, the directory is the same of the input alignments" if not app.zorro_dir else ""

    BoxLayout:
        orientation: "horizontal"
        spacing: 10
        TFOKButon:
            id: ok_bt
            text: "Ok"
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            on_release:
                if not zorro_txt.text: app.dialog_floatcheck("A valid suffix string must be provided", t="error"); zorro_txt.focus = True
                else: app.save_zorro_settings(zorro_txt.text)
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release: root.cancel()

#===============================================================================
# PROCESS HAPLOTYPE ADDITIONAL OPTIONS
#===============================================================================

<TextDialog>:
    orientation: "vertical"
    padding: 10
    spacing: 10
    idx: None
    old_name: None
    TFTextInput:
        id: txt_dlg
        focus: True
    BoxLayout:
        size_hint_y: None
        height: 30
        orientation: "horizontal"
        spacing: 10
        TFOKButon:
            id: ok_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Ok"
            on_release:
                if root.text == "new_folder": \
                app.create_folder(txt_dlg.text)
                elif root.text == "files" and txt_dlg.text in app.file_groups: \
                app.check_action(text="The group '{}' already exists. Do you wish to modify it?".format(txt_dlg.text), func=app.save_dataset_group, args=[None, txt_dlg.text, root.text, True], popup_level=2)
                elif root.text == "files" and txt_dlg.text not in app.file_groups: \
                app.save_dataset_group(None, txt_dlg.text, root.text, True)
                elif root.text == "taxa" and txt_dlg.text in app.taxa_groups: \
                app.check_action(text="The group '{}' already exists. Do you wish to modify it?".format(txt_dlg.text), func=app.save_dataset_group, args=[None, txt_dlg.text, root.text, True], popup_level=2)
                elif root.text == "taxa" and txt_dlg.text not in app.taxa_groups: \
                app.save_dataset_group(None, txt_dlg.text, root.text, True)
                elif root.text == "project": \
                app.save_project(txt_dlg.text)
                elif root.text == "change_taxon": \
                app.change_taxa_name(root.old_name, txt_dlg.text)
                else: \
                app.save_text(txt_dlg.text, root.text)
                root.cancel()
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release: root.cancel()

#===============================================================================
# REVERSE CONCATENATION OPTIONS
#===============================================================================

<BtList>:
    orientation: "vertical"
    spacing: 10
    padding: 10
    ScrollView:
        GridLayout:
            spacing: 5
            cols: 1
            id: rev_inlist
            size_hint_y: None
            height: sum([x.height + 5 for x in self.children])

    AnchorLayout:
        size_hint_y: None
        height: 30
        TFOKButon:
            size_hint_x: None
            width: 80
            id: cancel_bt
            text: "Close"
            on_release:
                root.cancel()

<InputList>:
    orientation: "vertical"
    spacing: 10
    padding: 10

    ScrollView:
        id: selection_bx
        size_hint_y: None
        height: 0
        spacing: 5
        BoxLayout:
            orientation: "vertical"
            spacing: 10
            BoxLayout:
                spacing: 5
                size_hint_y: None
                height: 35
                TFButton:
                    text: "Select All"
                    background_normal: "data/backgrounds/bt_process_off.png"
                    background_down: "data/backgrounds/bt_process.png"
                    on_release:
                        for wgt in rev_inlist.children:\
                        wgt.state = "down"
                TFButton:
                    text: "Deselect All"
                    background_normal: "data/backgrounds/bt_process_off.png"
                    background_down: "data/backgrounds/bt_process.png"
                    on_release:
                        for wgt in rev_inlist.children:\
                        wgt.state = "normal"
            Hseparator:
                c: app._blue


    ScrollView:
        GridLayout:
            spacing: 5
            cols: 1
            id: rev_inlist
            size_hint_y: None
            height: sum([x.height + 5 for x in self.children])

    AnchorLayout:
        size_hint_y: None
        height: 30
        BoxLayout:
            id: ok_bx
            size_hint_x: None
            width: 180
            spacing: 10
            TFOKButon:
                size_hint_x: None
                width: 80
                id: ok_bt
                text: "Ok"
                background_normal: "data/backgrounds/bt_process.png"
                background_down: "data/backgrounds/bt_process_off.png"
            TFOKButon:
                size_hint_x: None
                width: 80
                id: cancel_bt
                text: "Cancel"
                on_release:
                    root.cancel()

<RevConcDialog>:
    orientation: "vertical"
    spacing: 30
    padding: 10

    BoxLayout:
        size_hint_y: .8
        #height: 50
        spacing: 10
        orientation: "vertical"

        Switch:
            id: rev_conc
            on_active:
                if self.active == True: app.update_main_operations("reverse_concatenation")
                if self.active == False: app.update_main_operations("concatenation"); use_parts.state = "normal"

        Accordion:
            size_hint_y: None
            height: 165
            AccordionItem:
                title: "Manual selection"
                id: manual
                BoxLayout:
                    spacing: 10
                    padding: 10
                    BoxLayout:
                        orientation: "vertical"
                        spacing: 10
                        TFOKButon:
                            id: part_file
                            background_normal: "data/backgrounds/bt_process_off.png"
                            background_disabled_normal: "data/backgrounds/bt_process_disabled.png"
                            halign: "center"
                            valign: "middle"
                            shorten: True
                            shorten_from: "left"
                            text_size: self.size
                            text: "Select partition file"
                            disabled: False if rev_conc.active else True
                            size_hint_y: None
                            height: 70
                            on_release:
                                app.dialog_load_partfile()
                        TFOKButon:
                            id: rev_infile
                            background_normal: "data/backgrounds/bt_process_off.png"
                            background_disabled_normal: "data/backgrounds/bt_process_disabled.png"
                            text: "Select file to reverse concatenate"
                            halign: "center"
                            valign: "middle"
                            text_size: self.size
                            disabled: False if rev_conc.active else True
                            size_hint_y: None
                            height: 70
                            on_release:
                                app.dialog_reverse_inlist()

            AccordionItem:
                title: "Use defined partitons"
                id: defined
                AnchorLayout:
                    padding: 10
                    TGOKToggleButton:
                        id: use_parts
                        background_normal: "data/backgrounds/bt_process_off.png"
                        background_disabled_normal: "data/backgrounds/bt_process_disabled.png"
                        halign: "center"
                        valign: "middle"
                        shorten: True
                        shorten_from: "left"
                        text_size: self.size
                        text: "Use defined partitions"
                        size_hint_y: None
                        height: 70
                        state: "normal"
                        disabled: False if rev_conc.active else True
                        on_release:
                            app.use_app_partitions = True if self.state == "down" else False
                            part_file.background_normal = "data/backgrounds/bt_process_off.png"; part_file.text = "Select partition file"; app.partitions_file = ""
                            rev_infile.background_normal = "data/backgrounds/bt_process_off.png"; app.rev_infile = ""; rev_infile.text = "Select file to reverse concatenate"

    BoxLayout:
        size_hint_y: None
        height: 30
        spacing: 10
        padding: (30, 0, 30, 0)
        TFOKButon:
            id: ok_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "OK"
            on_release:
                app.save_reverseconc_settings()

        TFOKButon:
            id: cancel_bt
            background_normal: "data/backgrounds/bt_process_off.png"
            background_down: "data/backgrounds/bt_process.png"
            text: "Cancel"
            on_release: root.cancel()

#===============================================================================
# PROCESS FILTER ADDITIONAL OPTIONS
#===============================================================================

<TaxaFilterDialog>:
    orientation: "vertical"
    padding: 20
    spacing: 10

    Switch:
        id: taxa_filter
        size_hint_y: None
        height: 30
        disabled: False if app.file_list else True
        active: True if app.secondary_options["taxa_filter"] else False

    Label:
        text: "Filter mode"
        bold: True
        halign: "left"
        valign: "middle"
        text_size: self.size
        color: (0.216, 0.67, 0.784, 1)
        size_hint_y: None
        height: 20

    PlotSpinner:
        id: filter_mode
        size_hint: 1, None
        border: (16, 16, 16, 16)
        height: 40
        text: app.taxa_filter_settings[0] if app.taxa_filter_settings[0] else "Contain"
        disabled: False if taxa_filter.active else True
        bold: True
        option_cls: Factory.get("PlotOpt")
        values: ("Contain", "Exclude")
        on_text:
            app.taxa_filter_settings[0] = self.text

    BoxLayout:
        orientation: "vertical"
        id: tx_bx
        size_hint_y: None
        height: 140
        padding: 10
        spacing: 15
        StackLayout:
            canvas.after:
                Color:
                    rgb: (0.216, 0.67, 0.784, 1)
                Line:
                    width: 1
                    cap: "round"
                    joint: "round"
                    rectangle: tx_bx.x,tx_bx.y,tx_bx.width,tx_bx.height

        Label:
            text: "Taxa group"
            bold: True
            halign: "left"
            valign: "middle"
            text_size: self.size
            color: (0.216, 0.67, 0.784, 1)
            size_hint_y: None
            height: 20

        AnchorLayout:
            size_hint_y: None
            height: 40
            ProcessBt:
                id: taxa_group_name
                text: app.taxa_filter_settings[1] if app.taxa_filter_settings[1] else "No group selected"
                size_hint_x: None
                width: 200
                disabled: False if taxa_filter.active else True
                background_normal: "data/backgrounds/bt_process.png" if app.taxa_filter_settings else "data/backgrounds/bt_process_off.png"
                background_down: "data/backgrounds/bt_process_off.png" if app.taxa_filter_settings else "data/backgrounds/bt_process.png"

        BoxLayout:
            size_hint_y: None
            height: 30
            spacing: 10
            ProcessBt:
                text: "Set taxa group"
                size_hint: .5, None
                height: 30
                disabled: False if taxa_filter.active else True
                on_release:
                    app.dialog_dataset_creator("taxa", popup_level=2)

            ProcessBt:
                text: "Use taxa group"
                size_hint: .5, None
                height: 30
                disabled: False if taxa_filter.active else True
                on_release:
                    app.dialog_select_taxa_group()

    BoxLayout:
        orientation: "horizontal"
        size_hint_y: None
        height: 30
        spacing: 10
        TFOKButon:
            id: ok_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Ok"
            on_release:
                app.save_taxafilter(taxa_filter.active, filter_mode.text, taxa_group_name.text)
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release:
                root.cancel()


<CodonFilterDialog>:
    orientation: "vertical"
    padding: 20
    spacing: 20

    Switch:
        id: aln_filter
        active: True if app.secondary_options["codon_filter"] else False

    Label:
        size_hint_y: None
        height: 20
        halign: "left"
        valign: "middle"
        text_size: self.size
        bold: True
        text: "Include codon positions:"
        color: (0.216, 0.67, 0.784, 1)

    BoxLayout:
        ToggleButton:
            id: fbt
            text: "1st"
            bold: True
            state: "down" if app.codon_filter_settings[0] else "normal"
            disabled: False if aln_filter.active else True
        ToggleButton:
            id: sbt
            text: "2nd"
            bold: True
            state: "down" if app.codon_filter_settings[1] else "normal"
            disabled: False if aln_filter.active else True
        ToggleButton:
            id: tbt
            text: "3rd"
            bold: True
            state: "down" if app.codon_filter_settings[2] else "normal"
            disabled: False if aln_filter.active else True

    BoxLayout:
        orientation: "horizontal"
        size_hint_y: None
        height: 30
        spacing: 10
        TFOKButon:
            id: ok_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Ok"
            on_release:
                app.save_codonfilter(aln_filter.active, [True if fbt.state == "down" else False, True if sbt.state == "down" else False, True if tbt.state == "down" else False])
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release:
                root.cancel()


<FilterDialog>:
    orientation: "vertical"
    padding: 10
    spacing: 10

    Switch:
        id: gap_filter

    BoxLayout:
        size_hint_y: None
        height: 20
        spacing: 10
        CheckBox:
            id: within_chk
            size_hint_x: None
            width: 20
            disabled: True if not gap_filter.active else False
            active: True
        Label:
            text: "Within alignment"
            bold: True
            halign: "left"
            valign: "middle"
            text_size: self.size
            color: (0.216, 0.67, 0.784, 1)

    BoxLayout:
        size_hint_y: None
        height: 160
        spacing: 5
        padding: 10
        orientation: "vertical"
        id: intra_aln_bx
        StackLayout:
            canvas.after:
                Color:
                    rgb: (0.216, 0.67, 0.784, 1)
                Line:
                    width: 1
                    cap: "round"
                    joint: "round"
                    rectangle: intra_aln_bx.x,intra_aln_bx.y,intra_aln_bx.width,intra_aln_bx.height

        Label:
            text: "Gap percentage allowed"
            bold: True
            size_hint_y: None
            height: 20
            bold: True
            halign: "left"
            valign: "middle"
            text_size: self.size

        BoxLayout:
            orientation: "horizontal"
            size_hint_y: None
            height: 30
            Slider:
                id: gap_sli
                size_hint_x: .85
                min: 0
                max: 100
                step: 1
                value: 25
                disabled: False if gap_filter.active and within_chk.active else True
            Widget:
                size_hint_x: None
                width: 5
            TFTextInput:
                size_hint_x: .15
                id: gap_ti
                text: "{}".format(int(round(gap_sli.value)))
                multiline: False
                disabled: False if gap_filter.active and within_chk.active else True
                on_text_validate: if app.check_filters(gap_ti.text): val = app.check_filters(gap_ti.text)[1]; gap_sli.value = val; self.text = str(val)
            Widget:
                size_hint_x: None
                width: 5
            Label:
                size_hint_x: .04
                text: "%"
                bold: True
                color: (0.216, 0.67, 0.784, 1)

        Label:
            text: "Missing data percentage allowed"
            bold: True
            size_hint_y: None
            height: 20
            bold: True
            halign: "left"
            valign: "middle"
            text_size: self.size

        BoxLayout:
            orientation: "horizontal"
            size_hint_y: None
            height: 30
            Slider:
                id: mis_sli
                size_hint_x: .85
                min: 0
                max: 100
                step: 1
                value: 50
                disabled: False if gap_filter.active and within_chk.active else True
            Widget:
                size_hint_x: None
                width: 5
            TFTextInput:
                size_hint_x: .15
                id: mis_ti
                text: "{}".format(int(round(mis_sli.value)))
                multiline: False
                disabled: False if gap_filter.active and within_chk.active else True
                on_text_validate: if app.check_filters(mis_ti.text): val = app.check_filters(mis_ti.text)[1]; mis_sli.value = val; self.text =str(val)
            Widget:
                size_hint_x: None
                width: 5
            Label:
                size_hint_x: .04
                text: "%"
                bold: True
                color: (0.216, 0.67, 0.784, 1)

        BoxLayout:
            size_hint_y: None
            height: 20
            Label:
                halign: "left"
                valign: "middle"
                text_size: self.size
                bold: True
                text: "<- NO missing data"
                color: app._blue
                font_size: 12
            Label:
                halign: "right"
                valign: "middle"
                text_size: self.size
                bold: True
                text: "ALL missing data ->"
                color: app._blue
                font_size: 12

    BoxLayout:
        size_hint_y: None
        height: 20
        spacing: 10
        CheckBox:
            id: among_chk
            size_hint_x: None
            width: 20
            disabled: True if not gap_filter.active else False
            active: True
        Label:
            text: "Multiple alignments"
            bold: True
            halign: "left"
            valign: "middle"
            text_size: self.size
            color: (0.216, 0.67, 0.784, 1)


    BoxLayout:
        size_hint_y: None
        height: 80
        spacing: 5
        padding: 10
        orientation: "vertical"
        id: intra_aln_bx
        StackLayout:
            canvas.after:
                Color:
                    rgb: (0.216, 0.67, 0.784, 1)
                Line:
                    width: 1
                    cap: "round"
                    joint: "round"
                    rectangle: intra_aln_bx.x,intra_aln_bx.y,intra_aln_bx.width,intra_aln_bx.height

        Label:
            text: "Minimum taxa representation"
            bold: True
            size_hint_y: None
            height: 20
            bold: True
            halign: "left"
            valign: "middle"
            text_size: self.size

        BoxLayout:
            orientation: "horizontal"
            size_hint_y: None
            height: 30
            Slider:
                id: min_taxa
                size_hint_x: .85
                min: 0
                max: 100
                step: 1
                value: 50
                disabled: False if gap_filter.active and among_chk.active else True
            Widget:
                size_hint_x: None
                width: 5
            TFTextInput:
                size_hint_x: .15
                id: min_tx_ti
                text: "{}".format(int(min_taxa.value))
                multiline: False
                disabled: False if gap_filter.active and among_chk.active else True
                on_text_validate: if app.check_filters(self.text): val = app.check_filters(self.text)[1]; min_taxa.value = val; self.text = str(val)
            Widget:
                size_hint_x: None
                width: 5
            Label:
                size_hint_x: .04
                text: "%"
                bold: True
                color: (0.216, 0.67, 0.784, 1)

    BoxLayout:
        orientation: "horizontal"
        size_hint_y: None
        height: 30
        spacing: 10
        TFOKButon:
            id: ok_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Ok"
            on_release: app.save_gapfilter(gap_filter.active, within_chk.active, among_chk.active, gap_sli.value, mis_sli.value, min_taxa.value)
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release: root.cancel()

<VariationFilterDialog>:
    orientation: "vertical"
    padding: 10
    spacing: 15

    Switch:
        id: variation_filter

    Label:
        size_hint_y: None
        height: 30
        text: "Variable sites"
        bold: True
        halign: "left"
        valign: "middle"
        text_size: self.size
        color: (0.216, 0.67, 0.784, 1)
        size_hint_y: None
        height: 20
    BoxLayout:
        size_hint_y: None
        height: 30
        spacing: 10
        CheckBox:
            size_hint_x: .2
            id: var_min
            disabled: True if not variation_filter.active else False
        Label:
            text: "Minimum"
            halign: "left"
            valign: "middle"
            text_size: self.size
            bold: True
            color: (.6,.6,.6,.6) if not variation_filter.active or not var_min.active else (1,1,1,1)
        TextInput:
            id: var_min_val
            disabled: True if not variation_filter.active or not var_min.active else False
            size_hint_x: .7
            multiline: False
            on_text_validate: if app.check_variation_filters(self.text): val = app.check_variation_filters(self.text)[1]; self.text = str(val)
            on_focus: if app.check_variation_filters(self.text): val = app.check_variation_filters(self.text)[1]; self.text = str(val)
    BoxLayout:
        size_hint_y: None
        height: 30
        spacing: 10
        CheckBox:
            size_hint_x: .2
            id: var_max
            disabled: True if not variation_filter.active else False
        Label:
            text: "Maximum"
            halign: "left"
            valign: "middle"
            text_size: self.size
            bold: True
            color: (.6,.6,.6,.6) if not variation_filter.active or not var_max.active else (1,1,1,1)
        TextInput:
            id: var_max_val
            disabled: True if not variation_filter.active or not var_max.active else False
            size_hint_x: .7
            multiline: False
            on_text_validate: if app.check_variation_filters(self.text): val = app.check_variation_filters(self.text)[1]; self.text = str(val)
            on_focus: if app.check_variation_filters(self.text): val = app.check_variation_filters(self.text)[1]; self.text = str(val)

    Label:
        text: "Informative sites"
        bold: True
        halign: "left"
        valign: "middle"
        text_size: self.size
        color: (0.216, 0.67, 0.784, 1)
        size_hint_y: None
        height: 30
    BoxLayout:
        size_hint_y: None
        height: 30
        spacing: 10
        CheckBox:
            size_hint_x: .2
            id: inf_min
            disabled: True if not variation_filter.active else False
        Label:
            text: "Minimum"
            halign: "left"
            valign: "middle"
            text_size: self.size
            bold: True
            color: (.6,.6,.6,.6) if not variation_filter.active or not inf_min.active else (1,1,1,1)

        TextInput:
            id: inf_min_val
            disabled: True if not variation_filter.active or not inf_min.active else False
            size_hint_x: .7
            multiline: False
            on_text_validate: if app.check_variation_filters(self.text): val = app.check_variation_filters(self.text)[1]; self.text = str(val)
            on_focus: if app.check_variation_filters(self.text): val = app.check_variation_filters(self.text)[1]; self.text = str(val)
    BoxLayout:
        size_hint_y: None
        height: 30
        spacing: 10
        CheckBox:
            size_hint_x: .2
            id: inf_max
            disabled: True if not variation_filter.active else False
        Label:
            text: "Maximum"
            halign: "left"
            valign: "middle"
            text_size: self.size
            bold: True
            color: (.6,.6,.6,.6) if not variation_filter.active or not inf_max.active else (1,1,1,1)
        TextInput:
            id: inf_max_val
            disabled: True if not variation_filter.active or not inf_max.active else False
            size_hint_x: .7
            multiline: False
            on_text_validate: if app.check_variation_filters(self.text): val = app.check_variation_filters(self.text)[1]; self.text = str(val)
            on_focus: if app.check_variation_filters(self.text): val = app.check_variation_filters(self.text)[1]; self.text = str(val)

    BoxLayout:
        orientation: "horizontal"
        size_hint_y: None
        height: 30
        spacing: 10
        TFOKButon:
            id: ok_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Ok"
            on_release:
                app.save_variationfilter(variation_filter.active, (var_min.active, var_min_val.text), (var_max.active, var_max_val.text), (inf_min.active, inf_min_val.text), (inf_max.active, inf_max_val.text))
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release: root.cancel()

<FilterGraphicReport>:
    padding: 10
    spacing: 10
    orientation: "vertical"
    bar_color: None
    BoxLayout:
        id: filter_bx
        orientation: "vertical"
        spacing: 5
        BoxLayout:
            size_hint_y: None
            height: 50
            spacing: 5
            orientation: "vertical"
            Label:
                bold: True
                text: "Total alignments"
                halign: "left"
                valign: "middle"
                text_size: self.size
                color: (.7,.7,.7,1)
            BoxLayout:
                canvas.before:
                    Color:
                        rgba: (.7,.7,.7,1)
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Label:
                    bold: True
                    id: total_alns
        Label:
            text: "Filters"
            bold: True
            color: app._blue
            size_hint_y: None
            height: 30


    BoxLayout:
        orientation: "vertical"
        spacing: 5
        size_hint_y: None
        height: 65
        Label:
            text: "Total filtered alignments"
            bold: True
            color: app._blue
            size_hint_y: None
            height: 30
        AnchorLayout:
            id: main
            BoxLayout:
                BoxLayout:
                    id: final_box
                    canvas.before:
                        Color:
                            rgba: root.bar_color if root.bar_color else (.6, .6, .6, 1)
                        Rectangle:
                            pos: self.pos
                            size: self.size

                BoxLayout:
                    size_hint_x: 1 - final_box.size_hint_x
                    canvas.before:
                        Color:
                            rgba: (.4, .4, .4, 1)
                        Rectangle:
                            pos: self.pos
                            size: self.size
                    Label:
                        id: final_txt2
                        bold: True
            Label:
                size_hint_x: None
                width: main.width
                id: final_txt
                bold: True

    Widget:
        size_hint_y: None
        height: 10

    BoxLayout:
        orientation: "horizontal"
        size_hint_y: None
        height: 30
        spacing: 10
        TFOKButon:
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            id: cancel_bt
            text: "Close"
            on_release:
                root.cancel()

<IndividualFilterWgt>:
    size_hint_y: None
    height: 50
    spacing: 5
    orientation: "vertical"
    bar_color: None
    Label:
        id: main_lbl
        bold: True
        halign: "left"
        valign: "middle"
        text_size: self.size
        color: (.7,.7,.7,1)
    AnchorLayout:
        id: main
        BoxLayout:
            BoxLayout:
                id: gf_box
                canvas.before:
                    Color:
                        rgba: root.bar_color if root.bar_color else (.6, .6, .6, 1)
                    Rectangle:
                        pos: self.pos
                        size: self.size

            BoxLayout:
                size_hint_x: 1 - gf_box.size_hint_x
                canvas.before:
                    Color:
                        rgba: (.4, .4, .4, 1)
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Label:
                    id: gf_txt2
                    bold: True
        Label:
            size_hint_x: None
            width: main.width
            id: gf_txt
            bold: True

<Sidebt@ToggleButton>:
    size_hint_y: None
    height: 50
    background_normal: "data/backgrounds/transparent.png"
    background_down: "data/backgrounds/bt_process.png"
    background_disabled_down: "data/backgrounds/bt_process.png"
    disabled_color: (1, 1, 1, 1)
    halign: "center"
    valign: "middle"
    text_size: self.size
    bold: True
    font_size: 18
    padding: (20, 0)
    StackLayout:
        canvas.after:
            Color:
                rgb: (0.216, 0.67, 0.784, 1)
            Line:
                width: 1.1
                cap: "square"
                joint: "miter"
                close: True
                rectangle: root.x,root.y,root.width,root.height

# Vertical light grey separator
<Vseparator@Widget>:
    size_hint_x: None
    width: self.thickness + 2 * self.margin
    thickness: 1
    margin: 1
    offset: [10, 20]
    c: .5, .5, .5, 1
    canvas:
        Color:
            rgba: self.c
        Rectangle:
            pos: self.x + self.margin + 1, self.y + self.offset[0]
            size: self.thickness, self.height - self.offset[1]

<LightBox@BoxLayout>:
    height: 40
    orientation: "horizontal"
    size_hint_y: None
    padding: 10
    canvas.before:
        Color:
            rgba: tm.c_light_box
        Rectangle:
            pos: self.pos
            size: self.size

<DarkBox@BoxLayout>:
    height: 55
    orientation: "horizontal"
    size_hint_y: None
    padding: 5
    canvas.before:
        Color:
            rgba: tm.c_dark_box
        Rectangle:
            pos: self.pos
            size: self.size

<Hseparator@Widget>:
    size_hint_y: None
    height: self.thickness + 2 * self.margin
    thickness: 1
    margin: 1
    c: (.5, .5, .5, .5)
    canvas:
        Color:
            rgb: self.c
        Rectangle:
            pos: self.x + self.margin, self.y + self.margin +1
            size: self.width - 2 * self.margin, self.thickness

<ProcessBt@Button>:
    background_normal: "data/backgrounds/bt_process.png"
    size_hint_x: .2
    bold: True
    shorten: True
    shorten_from: "right"
    text_size: self.size
    halign: "center"
    valign: "middle"
    StackLayout:
        canvas.after:
            Color:
                rgba: (0.216, 0.67, 0.784, .5) if root.disabled else (0.216, 0.67, 0.784, 1)
            Line:
                width: 1.1
                cap: "round"
                joint: "round"
                rectangle: root.x,root.y,root.width,root.height

#===============================================================================
# PROCESS GENERAL OPTIONS
#===============================================================================

<ProcessGeneral>:
    id: main_grid
    process_bt_wdt: 250
    padding: 5
    spacing: 5
    cols: 1
    size_hint_y: None
    height: sum([x.size[1] for x in self.children])
    opacity: 0
    LightBox:
        Label:
            markup: True
            text: "[size=15][b]General[/b][/size]"
            halign: "left"
            valign: "middle"
            color: [.85, .85, .85, 1]
            text_size: self.size

    DarkBox:
        Label:
            #size_hint_x: .74
            markup: True
            text: "[size=18][b]Data set[/b][/size]\n[size=13]Select the active taxa data set to perform operations[/size]"
            halign: "left"
            valign: "middle"
            text_size: self.size
        InfoBt:
            width: 50
            height: 50
            height:
            on_release:
                app.dialog_general_info("process_dataset")

        BoxLayout:
            spacing: 6
            size_hint_x: None
            width: root.process_bt_wdt

            ProcessBt:
                id: active_file_set
                text: "Active files"
                on_release: app.toggle_fancy_dropdown(self, sorted(app.file_groups), orientation="down", add_ds_type="files")

            ProcessBt:
                id: active_taxa_set
                text: "Active taxa"
                on_release: app.toggle_fancy_dropdown(self, sorted(app.taxa_groups), orientation="down", add_ds_type="taxa")

    Hseparator

    DarkBox:
        Label:
            markup: True
            text: "[size=18][b]Output Format[/b][/size]\n[size=13]Choose the format of the output file(s). Multiple formats may be chosen[/size]"
            halign: "left"
            valign: "middle"
            text_size: self.size
        ProcessBt:
            size_hint_x: None
            width: root.process_bt_wdt
            id: conv_formatbt
            text: "%s" % app.output_formats[0].title() if len(app.output_formats) == 1 else "%s selected" % len(app.output_formats)
            on_release: app.dialog_format()
    Hseparator

    DarkBox:
        id: dark_l
        Label:
            id: output_label
            size_hint_x: .8
            markup: True
            text: "[size=18][b]Output file[/b][/size]\n[size=13]Save output file to...[/size]"
            halign: "left"
            valign: "middle"
            text_size: self.size
        ProcessBt:
            size_hint_x: None
            width: root.process_bt_wdt
            id: conv
            text: "Select..."
            on_release: app.dialog_filechooser("main_output")

    BoxLayout:
        size_hint_y: None
        height: 60
        AnchorLayout:
            ToggleButton:
                bold: True
                id: opt_bt
                background_down: "data/backgrounds/toggle_process_opts_down.png"
                background_normal: "data/backgrounds/toggle_process_opts_normal.png"
                text: "Show additional options"
                size_hint: None, None
                width: 300
                height: 40
                on_release:
                    app.toggle_process_options()

#===============================================================================
# PROCESS ADDITIONAL OPTIONS
#===============================================================================

<AdditionalProcessContents>:
    do_default_tab: False
    tab_pos: "top_left"
    process_bt_wdt: 250
    background_color: (0,0,0,0)
    opacity: 0

    TabbedPanelItem:
        id: main_tab
        text: "Formatting"

        GridLayout:
            id: main_grid
            cols: 1
            padding: 5
            spacing: 5
            opacity: 1

            LightBox:
                Label:
                    markup: True
                    text: "[size=15][b]Formatting options[/b][/size]"
                    halign: "left"
                    valign: "middle"
                    color: [.85, .85, .85, 1]
                    text_size: self.size

            DarkBox:
                Label:
                    markup: True
                    text: "[size=18][b]Interleave[/b][/size]\n[size=13]If sequences should be in interleave format or leave"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                Switch:
                    id: interleave
                    size_hint_x: None
                    width: root.process_bt_wdt
                    on_active:
                        app.update_process_switch("interleave", self.active)

            Hseparator

            DarkBox:
                Label:
                    markup: True
                    text: "[size=18][b]Sequence upper case[/b][/size]\n[size=13]Turn on to write sequence data as upper case (default is lower case)"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                Switch:
                    id: interleave
                    size_hint_x: None
                    width: root.process_bt_wdt
                    on_active:
                        app.update_process_switch("upper_case", self.active)

            Hseparator

            DarkBox:
                Label:
                    markup: True
                    text: "[size=18][b]ZORRO weights support[/b][/size]\n[size=13]Concatenation only. Concatenates auxiliary Zorro weight files into a single *_zorro.out file"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                InfoBt:
                    width: 50
                    height: 50
                    on_release:
                        app.dialog_general_info("zorro")
                ProcessBt:
                    id: zorro
                    background_normal: "data/backgrounds/bt_process_off.png"
                    background_disabled_normal: "data/backgrounds/bt_process_disabled.png"
                    size_hint_x: None
                    width: root.process_bt_wdt
                    text: "OFF"
                    disabled: False if app.main_operations["concatenation"] else True
                    on_release:
                        if app.active_file_list: \
                        app.dialog_zorro()
                        else: \
                        app.dialog_floatcheck("No input files have been selected to use this option", t="error")

    TabbedPanelItem:
        id: collapse_tab
        text: "Collapse"

        GridLayout:
            id: collapse_grid
            cols: 1
            padding: 5
            spacing: 5
            opacity: 1

            LightBox:
                Label:
                    markup: True
                    text: "[size=15][b]Sequence collapsing options[/b][/size]"
                    halign: "left"
                    valign: "middle"
                    color: [.85, .85, .85, 1]
                    text_size: self.size
                InfoBt:
                    width: 20
                    height: 20
                    border: 0,0,0,0
                    background_normal: "data/backgrounds/more_info_20px.png"
                    background_down: "data/backgrounds/more_info_down_20px.png"
                    on_release:
                        app.dialog_general_info("collapse")
                Switch:
                    size_hint_x: None
                    width: root.process_bt_wdt
                    id: collapse
                    on_active:
                        app.update_process_switch("collapse", self.active)

            DarkBox:
                height: 70
                Label:
                    markup: True
                    id: test2
                    text: "[size=18][b]Save in new output file[/b][/size]\n[size=13] If checked, the collapsed alignments will be saved in a file with an '_haplotype' suffix in addition to the main output file[/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                CheckBox:
                    id: collapse_file
                    size_hint_x: None
                    width: root.process_bt_wdt
                    disabled: True if not collapse.active else False
                    on_active:
                        app.update_process_switch("collapse_file", self.active)

            Hseparator

            DarkBox:
                height: 70
                Label:
                    markup: True
                    id: test2
                    text: "[size=18][b]Ignore missing data[/b][/size]\n[size=13] Sites containing missing data are removed before collapsing. This is effectively equivalent to setting filters to 0% of gap and missing data allowed. This may not be ideal for alignments with high proportion of missing data[/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                CheckBox:
                    size_hint_x: None
                    width: root.process_bt_wdt
                    id: hap_filt
                    disabled: True if not collapse.active else False
                    on_release:
                        app.update_process_switch("collapse_filter", self.active)

            Hseparator

            DarkBox:
                Label:
                    markup: True
                    id: test2
                    text: "[size=18][b]Haplotype prefix[/b][/size]\n[size=13] Select the prefix name for the haplotypes [/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                ProcessBt:
                    size_hint_x: None
                    width: root.process_bt_wdt
                    id: hapbt
                    disabled: True if not collapse.active else False
                    text: "Hap"
                    background_normal: "data/backgrounds/bt_process.png"
                    background_disabled_normal: "data/backgrounds/bt_process_disabled.png"
                    on_release:
                        app.dialog_text("Haplotype prefix", "haplotype")

    TabbedPanelItem:
        id: collapse_tab
        text: "Consensus"

        GridLayout:
            id: collapse_grid
            cols: 1
            padding: 5
            spacing: 5
            opacity: 1

            LightBox:
                Label:
                    markup: True
                    text: "[size=15][b]Alignment consensus options[/b][/size]"
                    halign: "left"
                    valign: "middle"
                    color: [.85, .85, .85, 1]
                    text_size: self.size
                InfoBt:
                    width: 20
                    height: 20
                    border: 0,0,0,0
                    background_normal: "data/backgrounds/more_info_20px.png"
                    background_down: "data/backgrounds/more_info_down_20px.png"
                    on_release:
                        app.dialog_general_info("consensus")
                Switch:
                    size_hint_x: None
                    width: root.process_bt_wdt
                    id: consensus
                    on_active:
                        app.update_process_switch("consensus", self.active)

            DarkBox:
                height: 70
                Label:
                    markup: True
                    id: test2
                    text: "[size=18][b]Save in new output file[/b][/size]\n[size=13] If checked, the consensus alignments will be saved in a file with an '_consensus' suffix in addition to the main output file[/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                CheckBox:
                    id: consensus_file
                    size_hint_x: None
                    width: root.process_bt_wdt
                    disabled: True if not consensus.active else False
                    on_active:
                        app.update_process_switch("consensus_file", self.active)

            Hseparator

            DarkBox:
                height: 70
                Label:
                    markup: True
                    id: test2
                    text: "[size=18][b]Save consensus sequences in a single file[/b][/size]\n[size=13] If checked, the consensus sequences of multiple files will be saved in a single file with each file name as the sequence name[/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                CheckBox:
                    id: consensus_single
                    size_hint_x: None
                    width: root.process_bt_wdt
                    disabled: True if not consensus.active or app.main_operations["concatenation"] else False
                    active: True if app.main_operations["concatenation"] else False
                    on_active:
                        app.update_process_switch("consensus_single", self.active)

            Hseparator

            DarkBox:
                Label:
                    markup: True
                    id: test2
                    text: "[size=18][b]Consensus variation handling[/b][/size]\n[size=13] Select how variation in alignment columns will be handled to produce a consensus sequence [/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                InfoBt:
                    width: 50
                    height: 50
                    on_release:
                        app.dialog_general_info("consensus_mode")
                ProcessBt:
                    size_hint_x: None
                    width: root.process_bt_wdt
                    id: consensus_mode
                    disabled: True if not consensus.active else False
                    text: "IUPAC" if app.sequence_types != "Protein" else "Soft mask"
                    on_release:
                        app.toggle_fancy_dropdown(self, ("IUPAC", "Soft mask", "Remove", "First sequence") if app.sequence_types != "Protein" else ("Soft mask", "Remove", "First sequence"), orientation="up")


    TabbedPanelItem:
        id: filter_tab
        text: "Filter"

        GridLayout:
            id: filter_grid
            cols: 1
            padding: 5
            spacing: 5
            opacity: 1

            LightBox:
                Label:
                    markup: True
                    text: "[size=15][b]Sequence filter options[/b][/size]"
                    halign: "left"
                    valign: "middle"
                    color: [.85, .85, .85, 1]
                    text_size: self.size
                Switch:
                    id: filter
                    size_hint_x: None
                    width: root.process_bt_wdt
                    on_active:
                        app.update_process_switch("filter", self.active)

            DarkBox:
                height: 70
                Label:
                    markup: True
                    text: "[size=18][b]Save in new output file[/b][/size]\n[size=13] If checked, the filtered alignments will be saved in a file with an '_filtered' suffix in addition to the main output file[/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                CheckBox:
                    id: filter_file
                    size_hint_x: None
                    width: root.process_bt_wdt
                    disabled: False if filter.active else True
                    on_active:
                        app.update_process_switch("filter_file", self.active)

            Hseparator

            DarkBox:
                Label:
                    markup: True
                    id: test2
                    text: "[size=18][b]Taxa filter[/b][/size]\n[size=13] Set advanced filters to excluded/included taxa [/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                InfoBt:
                    width: 50
                    height: 50
                    on_release:
                        app.dialog_general_info("taxa_filter")
                ProcessBt:
                    id: taxa_filter
                    disabled: False if filter.active else True
                    size_hint_x: None
                    width: root.process_bt_wdt
                    text: "Filters ON" if app.secondary_options["taxa_filter"] else "Set filters"
                    background_normal: "data/backgrounds/bt_process.png" if app.secondary_options["taxa_filter"] else "data/backgrounds/bt_process_off.png"
                    background_disabled_normal: "data/backgrounds/bt_process_disabled.png"
                    on_release:
                        app.dialog_taxafilter()

            Hseparator

            DarkBox:
                Label:
                    markup: True
                    id: test2
                    text: "[size=18][b]Codon position filter[/b][/size]\n[size=13] Nucleotide alignments only. Set advanced filters to excluded/included codon positions [/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                InfoBt:
                    width: 50
                    height: 50
                    on_release:
                        app.dialog_general_info("codon_filter")
                ProcessBt:
                    id: taxa_filter
                    disabled: False if filter.active and app.sequence_types == "DNA" else True
                    size_hint_x: None
                    width: root.process_bt_wdt
                    text: "Filters ON" if app.secondary_options["codon_filter"] else "Set filters"
                    background_normal: "data/backgrounds/bt_process.png" if app.secondary_options["codon_filter"] else "data/backgrounds/bt_process_off.png"
                    background_disabled_normal: "data/backgrounds/bt_process_disabled.png"
                    on_release:
                        app.dialog_codonfilter()

            Hseparator

            DarkBox:
                Label:
                    markup: True
                    id: test2
                    text: "[size=18][b]Gap/Missing data filter[/b][/size]\n[size=13] Set filters to remove alignment columns with excessive gap and/or missing data [/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                InfoBt:
                    width: 50
                    height: 50
                    on_release:
                        app.dialog_general_info("filter")
                ProcessBt:
                    id: cv_filterbt
                    disabled: False if filter.active else True
                    text: "Filters ON" if app.secondary_options["gap_filter"] else "Set filters"
                    size_hint_x: None
                    width: root.process_bt_wdt
                    background_normal: "data/backgrounds/bt_process.png" if app.secondary_options["gap_filter"] else "data/backgrounds/bt_process_off.png"
                    background_disabled_normal: "data/backgrounds/bt_process_disabled.png"
                    on_release: app.dialog_filter();

            Hseparator

            DarkBox:
                Label:
                    markup: True
                    id: test2
                    text: "[size=18][b]Sequence variation filter[/b][/size]\n[size=13] Set filters to remove/include alignments inside the specified sequence variation range [/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                InfoBt:
                    width: 50
                    height: 50
                    on_release:
                        app.dialog_general_info("variation_filter")
                ProcessBt:
                    id: variation_filterbt
                    disabled: False if filter.active else True
                    text: "Filters ON" if app.secondary_options["variation_filter"] else "Set filters"
                    size_hint_x: None
                    width: root.process_bt_wdt
                    background_normal: "data/backgrounds/bt_process.png" if app.secondary_options["variation_filter"] else "data/backgrounds/bt_process_off.png"
                    background_disabled_normal: "data/backgrounds/bt_process_disabled.png"
                    on_release:
                        app.dialog_variationfilter()

    TabbedPanelItem:
        id: gcoder_tab
        text: "Gcoder"

        GridLayout:
            id: gcoder_grid
            cols: 1
            padding: 5
            spacing: 5
            opacity: 1

            LightBox:
                Label:
                    markup: True
                    text: "[size=15][b]Gap coding options[/b][/size]"
                    halign: "left"
                    valign: "middle"
                    color: [.85, .85, .85, 1]
                    text_size: self.size
                InfoBt:
                    width: 20
                    height: 20
                    border: 0,0,0,0
                    background_normal: "data/backgrounds/more_info_20px.png"
                    background_down: "data/backgrounds/more_info_down_20px.png"
                    on_release:
                        app.dialog_general_info("gcoder")
                Switch:
                    id: gcoder
                    size_hint_x: None
                    width: root.process_bt_wdt
                    disabled: True if app.output_formats != ["nexus"] else False
                    on_active:
                        if self.active == True: root.ids.gcoder_file.disabled = False
                        if self.active == False: root.ids.gcoder_file.disabled = True
                        app.update_process_switch("gcoder", self.active)

            DarkBox:
                height: 70
                Label:
                    markup: True
                    text: "[size=18][b]Save in new output file[/b][/size]\n[size=13] If checked, the coded alignments will be saved in a file with an '_coded' suffix in addition to the main output file[/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                CheckBox:
                    id: gcoder_file
                    size_hint_x: None
                    width: root.process_bt_wdt
                    disabled: True
                    on_active:
                        app.update_process_switch("gcoder_file", self.active)

            Hseparator

            DarkBox:
                Label:
                    markup: True
                    text: "[size=18][b]Gap coding method[/b][/size]\n[size=13] Choose the coding method [/size]"
                    halign: "left"
                    valign: "middle"
                    text_size: self.size
                ProcessBt:
                    id: gcode_bt
                    disabled: True
                    size_hint_x: None
                    width: root.process_bt_wdt
                    background_disabled_normal: "data/backgrounds/bt_process_disabled.png"
                    background_normal: "data/backgrounds/bt_process_off.png"
                    text: "Choose..."

#===============================================================================
# STATISTICS SCREEN
#===============================================================================

<OptsGrid>:
    cols: 1
    padding: 5
    spacing: 10
    size_hint_y: None
    active_grid: False
    #height: sum([x.height + 10 for x in self.children]) + 5
    height: 5
##
## STATS Options Buttons
##

<AdjustWindowDialog>:
    orientation: "vertical"
    spacing: 10
    padding: 10
    gene_name: None
    gene_len: None
    plt_idx: None
    Label:
        markup: True
        halign: "justify"
        valign: "middle"
        text_size: self.size
        id: msg
    BoxLayout:
        size_hint_y: None
        height: 35
        id: sliding_window
        BoxLayout:
            orientation: "vertical"
            Label:
                size_hint_y: .7
                text: "Sliding window size"
                bold: True
                halign: "left"
                valign: "middle"
                text_size: self.size
            Label:
                size_hint_y: .3
                text: "Use a decimal number to indicate proportion"
                font_size: 12
                bold: True
                halign: "left"
                valign: "middle"
                text_size: self.size
                color: app._blue
        TFTextInput:
            size_hint_x: .15
            text: "10"
            input_filter: "float"
            id: window

    Widget:
        size_hint_y: None
        height: 20
    BoxLayout:
        orientation: "horizontal"
        size_hint_y: None
        height: 30
        spacing: 10
        TFOKButon:
            id: ok_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Continue"
            on_release:
                app.stats_show_plot(root.plt_idx, {"gene_name": root.gene_name, "window_size": float(window.text)});

        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release: root.cancel()

<SelectGeneDialog>:
    orientation: "vertical"
    spacing: 10
    padding: 10
    plt_idx: None
    gene_counter: 0

    BoxLayout:
        size_hint_y: None
        height: 35
        id: sliding_window
        BoxLayout:
            orientation: "vertical"
            Label:
                size_hint_y: .7
                text: "Sliding window size"
                bold: True
                halign: "left"
                valign: "middle"
                text_size: self.size
            Label:
                size_hint_y: .3
                text: "Use a decimal number to indicate proportion"
                font_size: 12
                bold: True
                halign: "left"
                valign: "middle"
                text_size: self.size
                color: app._blue
        TFTextInput:
            size_hint_x: .15
            text: "10"
            id: window
            input_filter: "float"

    Hseparator

    BoxLayout:
        size_hint_y: None
        height: 30
        canvas.before:
            Color:
                rgba: 0.8, 0.8, 0.8, 1
            Rectangle:
                pos: self.pos
                size: self.size
        Button:
            size_hint_x: None
            width: 30
            border: 0,0,0,0
            background_normal: "data/backgrounds/search_bt.png"
            background_down: "data/backgrounds/search_bt.png"
            on_release:
                app.stats_search_genes(gn_txt.text)
        TFTextInput:
            background_color: (1, 1, 1, 0)
            foreground_color: (.1, .1, .1, .51)
            hint_text: "Search files..."
            multiline: False
            id: gn_txt
            on_text_validate:
                app.stats_search_genes(gn_txt.text)
        Button:
            size_hint_x: None
            width: 30
            border: 0,0,0,0
            background_normal: "data/backgrounds/clear_bt.png"
            background_down: "data/backgrounds/clear_bt.png"
            on_release:
                app.stats_clear_search()

    Hseparator

    BoxLayout:
        size_hint_y: None
        height: 35
        orientation: "vertical"
        Label:
            size_hint_y: .3
            text: "Previous gene:"
            bold: True
            halign: "left"
            valign: "middle"
            text_size: self.size
            font_size: 11
        Label:
            size_hint_y: .7
            text: "None"
            id: previous_gene
            halign: "left"
            valign: "middle"
            text_size: self.size
            bold: True
            color: app._blue
            shorten: True
            shorten_from: "right"

    Hseparator

    ScrollView:
        bar_width: 8
        scroll_type: ["bars"]
        GridLayout:
            size_hint_y: None
            height: sum([x.height + 5 for x in self.children]) + 20
            id: gn_grid
            cols: 1
            spacing: 5
            padding: 10

    BoxLayout:
        orientation: "horizontal"
        size_hint_y: None
        height: 30
        spacing: 10
        TFOKButon:
            id: ok_bt
            background_normal: "data/backgrounds/bt_process.png"
            background_down: "data/backgrounds/bt_process_off.png"
            text: "Select"
            on_release:
                act_bt = [x.text for x in gn_grid.children if isinstance(x, ToggleButton) and x.state == "down"];
                if act_bt and sliding_window in root.children: \
                app.gene_sliding_window_check(act_bt[0], window.text, root.plt_idx)
                elif act_bt and sliding_window not in root.children: \
                app.stats_show_plot(root.plt_idx, {"gene_name": app.filename_map[[x.text for x in gn_grid.children if isinstance(x, ToggleButton) and x.state == "down"][0]]})

                else: \
                app.dialog_floatcheck("Please select a gene.", t="error")
        TFOKButon:
            id: cancel_bt
            text: "Cancel"
            on_release: root.cancel()

<HseparatorFooter>:
    plt_file: ""
    spacing: 15
    Label:
        size_hint_x: None
        width: 150
        bold: True
        text: "Horizontal threshold:"
    MySlider:
        id: slider
        on_release:
            app.stats_sethline(self.value, root.plt_file, inverted.active)
    Label:
        size_hint_x: None
        width: 130
        bold: True
        text: "Inverse threshold?"
    CheckBox:
        id: inverted
        size_hint_x: None
        width: 40
        on_active:
            app.stats_sethline(slider.value, root.plt_file, self.active)

<PropSwitcher>:
    kwargs: None
    padding: 5
    BoxLayout:
        size_hint_x: None
        width: 330
        Label:
            text: "Absolute values"
            bold: True
        CheckBox:
            size_hint_x: .2
            group: "prop_switcher"
            plt_idx: ""
            id: abs
            on_release:
                if root.kwargs:\
                root.kwargs.update({"proportions": False}); app.stats_show_plot(self.plt_idx, root.kwargs)
                else:\
                app.stats_show_plot(self.plt_idx)
        Label:
            text: "Percentage"
            bold: True
        CheckBox:
            size_hint_x: .2
            group: "prop_switcher"
            plt_idx: ""
            id: proportion
            on_release:
                if root.kwargs:\
                root.kwargs.update({"proportions": True}); app.stats_show_plot(self.plt_idx, root.kwargs)
                else: \
                app.stats_show_plot(self.plt_idx, {"proportions": True})
    Widget


<OutlierFooter>:
    padding: 5
    ds_type: ""
    BoxLayout:
        size_hint_x: None
        width: 450
        spacing:10
        Label:
            id: outlier_number
            bold: True
            color: app._red
        TFButton:
            id: o_rm
            size_hint: None, 1
            width: 100
            text: "Remove"
            on_release:
                app.stats_handle_outliers("remove", root.ds_type)
        TFButton:
            id: o_exp
            size_hint: None, 1
            width: 100
            text: "Export"
            on_release:
                app.stats_handle_outliers("export", root.ds_type)
        TFButton:
            id: o_view
            size_hint: None, 1
            width: 100
            text: "View"
            on_release:
                app.stats_handle_outliers("view", root.ds_type)
    Widget


<ManualStatsAnchor>:
    anchor_x: "center"
    anchor_y: "center"
    BoxLayout:
        size_hint_y: None
        height: 100
        orientation: "vertical"
        padding: 20, 0, 20, 0
        Label:
            valign: "middle"
            halign: "center"
            text_size: self.size
            markup: True
            bold: True
            color: .7, .7, .7, .7
            text: "TriFusion detected a large number of taxa in the active data set and automatic computation of summary statistics has been turned off."
        BoxLayout:
            Widget
            TFButton:
                size_hint: None,None
                size: 200, 30
                text: "Trigger statistics"
                on_release:
                    app.statistics_show_summary(force=True)
            Widget


<StatsMoreBt>:
    anchor_x: "left"
    size_hint_y: None
    height: 30
    TFOKButon:
        text: "Load next 20"
        on_release:
            app.stats_load_more_genes()

<StatsToggleWgt>:
    size_hint: None, None
    size: 350, 50
    pos: app.root.width - 370, app.root.height - 120
    opacity: .2
    padding: 5
    spacing: 5
    args1: None
    args2: None
    gene_args: None
    canvas.before:
        Color:
            rgba: (.2,.2,.2,1)
        Rectangle:
            pos: self.pos
            size: self.size
    StackLayout:
        size_hint_x: None
        width: 0
        canvas.after:
            Color:
                rgb: (0.216, 0.67, 0.784, 1)
            Line:
                width: 1.1
                rectangle: root.x,root.y,root.width,root.height
    Button:
        background_normal: "data/backgrounds/bt_process_off.png"
        background_down: "data/backgrounds/bt_process.png"
        background_disabled_down: "data/backgrounds/bt_process.png"
        disabled_color: (1,1,1,1)
        bold: True
        text: "Single gene"
        id: gene
        on_release:
            app.dialog_select_gene(**root.gene_args)
    Vseparator:
        id: gene_sep
    ToggleButton
        background_normal: "data/backgrounds/bt_process_off.png"
        background_down: "data/backgrounds/bt_process.png"
        background_disabled_down: "data/backgrounds/bt_process.png"
        disabled_color: (1,1,1,1)
        state: "down"
        disabled: True
        text: "Per species"
        bold: True
        id: sp
        on_release:
            app.toggle_groups(self)
            app.stats_show_plot(**root.args1)
    Vseparator
    ToggleButton:
        background_normal: "data/backgrounds/bt_process_off.png"
        background_down: "data/backgrounds/bt_process.png"
        background_disabled_down: "data/backgrounds/bt_process.png"
        disabled_color: (1,1,1,1)
        bold: True
        text: "Average"
        id: avg
        on_release:
            app.toggle_groups(self)
            app.stats_show_plot(**root.args2)

<PlotTriageDialog>:
    orientation: "vertical"
    spacing: 10
    padding: 10
    BoxLayout:
        padding: 5
        spacing: 10
        TFButton:
            id: gene
            plt_idx: ""
            text: "Single gene"
            on_release:
                root.cancel()
                app.dialog_select_gene(self.plt_idx)
        TFButton:
            id: sp
            plt_idx: ""
            text: "Per species"
            on_release:
                root.cancel()
                app.stats_show_plot(self.plt_idx)
        TFButton:
            id: avg
            plt_idx: ""
            text: "Average"
            on_release:
                root.cancel()
                app.stats_show_plot(self.plt_idx)
    BoxLayout:
        size_hint_y: None
        height: 30
        AnchorLayout:
            TFOKButon:
                size_hint_x: None
                width: 100
                id: cancel_bt
                text: "Cancel"
                on_release:
                    root.cancel()

<StatsLoading>:
    orientation: "vertical"
    Widget
    BoxLayout:
        BoxLayout:
            orientation: "vertical"
            spacing: 10
            AnchorLayout:
                anchor_x: "center"
                anchor_y: "center"
                ScatterLayout:
                    do_translation: False
                    do_scale: False
                    do_rotation: False
                    id: img
                    size_hint: None, None
                    size: 100, 100
                    Image:
                        source: "data/backgrounds/spinner2.png"
            Label:
                text: "Summoning summary statistics"
                bold: True
                halign: "center"
                valign: "bottom"
                text_size: self.size
                font_size: 20
                size_hint_y: None
                height: 30
                color: (0.216, 0.67, 0.784, 1)

            Label:
                id: msg
                text: ""
                bold: True
                font_size: 13
                size_hint_y: None
                halign: "center"
                valign: "top"
                text_size: self.size
                height: 20
                color: (0.216, 0.67, 0.784, 1)

            AnchorLayout:
                anchor_x: "center"
                anchor_y: "center"
                size_hint_y: None
                height: 30
                TFButton:
                    text: "Cancel"
                    bold: True
                    size_hint_x: None
                    width: 150
                    on_release:
                        app.terminate_stats = True

    Widget:

<TableCellTop@BoxLayout>:
    lbl: ""
    size_hint_x: 0.083
    Label:
        bold: True
        color: (0.216, 0.67, 0.784, 1) if (sort_up.state == "down" or sort_down.state == "down") else (.7, .7, .7, 1)
        background_color: (0, 0, 0, 0)
        text: root.lbl
    BoxLayout:
        size_hint_x: None
        width: 20
        spacing: 2
        orientation: "vertical"
        padding: [0, 0, 7.5, 0]
        AnchorLayout:
            size_hint_y: None
            height: 18
            ToggleButton:
                size_hint: None, None
                size: 12, 12
                group: "gene_table_sort"
                id: sort_up
                background_normal: "data/backgrounds/sort_up.png"
                background_down: "data/backgrounds/sort_up_act.png"
                background_disabled_down: "data/backgrounds/sort_up_act.png"
                disabled: True if self.state == "down" else False
                border: 0,0,0,0
                on_release:
                    app.search_sort_gene_table(sortby=root.lbl, ascending=True)
        AnchorLayout:
            size_hint_y: None
            height: 18
            ToggleButton:
                size_hint: None, None
                size: 12, 12
                group: "gene_table_sort"
                id: sort_down
                background_normal: "data/backgrounds/sort_down.png"
                background_down: "data/backgrounds/sort_down_act.png"
                background_disabled_down: "data/backgrounds/sort_down_act.png"
                disabled: True if self.state == "down" else False
                border: 0,0,0,0
                on_release:
                    app.search_sort_gene_table(sortby=root.lbl, ascending=False)


<TableCell>:
    size_hint_x: 0.083
    halign: "center"
    valign: "middle"
    text_size: self.size
    multiline: False
    readonly: True
    background_color: (0, 0, 0, 0)
    foreground_color: (1, 1, 1, 1)

<TableCellGrey@TableCell>:
    canvas.after:
        Color:
            rgba: (.6, .6, .6, .3)
        Rectangle:
            pos: self.pos
            size: self.size

<TableCellGreen@TableCell>:
    canvas.after:
        Color:
            rgba: .78, .91, .69, .3
        Rectangle:
            pos: self.pos
            size: self.size

<TableCellOrange@TableCell>:
    canvas.after:
        Color:
            rgba: 1, .8, .67, .3
        Rectangle:
            pos: self.pos
            size: self.size

<MoreTableBt>:
    size_hint_y: None
    height: 40
    AnchorLayout:
        anchor_x: "center"
        anchor_y: "center"
        TFButton:
            size_hint: None, None
            size: 150, 30
            text: "Show more 25"
            on_release:
                app.more_stats_table_bts()

<TableLine>:
    size_hint_y: None
    height: 40
    Label:
        id: gn_name
        halign: "left"
        valign: "middle"
        text_size: self.width, self.height
        shorten: True
        shorten_from: "right"
    Widget:
        size_hint_x: None
        width: 3
    TableCellGrey:
        id: nsites
    Widget:
        size_hint_x: None
        width: 3
    TableCellGrey:
        id: taxa
    Widget:
        size_hint_x: None
        width: 3
    TableCellGreen:
        id: var
    Widget:
        size_hint_x: None
        width: 3
    TableCellGreen:
        id: inf
    Widget:
        size_hint_x: None
        width: 3
    TableCellOrange:
        id: gap
    Widget:
        size_hint_x: None
        width: 3
    TableCellOrange:
        id: missing

<GeneTable>:
    padding: 20
    orientation: "vertical"
    Label:
        text: "Summary statistics gene table view"
        bold: True
        halign: "center"
        valign: "middle"
        text_size: self.size
        font_size: 20
        size_hint_y: None
        height: 30
        color: (0.216, 0.67, 0.784, 1)
    Widget:
        size_hint_y: None
        height: 10

    Label:
        size_hint_y: None
        height: 60
        text: "[b][color=37abc8ff][size=18]Legend:[/size][/b][/color] [b][color=37abc8ff]N[/b][/color], number of sites; [b][color=37abc8ff]Taxa[/b][/color], number of taxa; [b][color=37abc8ff]V[/b][/color], number of variable sites; [b][color=37abc8ff]P[/b][/color], number of informative sites; [b][color=37abc8ff][/b][/color] number of gaps ('-'), [b][color=37abc8ff]M[/b][/color], number of missing data ('n')"
        markup: True
        halign: "left"
        valign: "middle"
        text_size: self.size

    BoxLayout:
        size_hint_y: None
        height: 30
        canvas.before:
            Color:
                rgba: 0.8, 0.8, 0.8, 1
            Rectangle:
                pos: self.pos
                size: self.size
        Button:
            size_hint_x: None
            width: 30
            border: 0,0,0,0
            background_normal: "data/backgrounds/search_bt.png"
            background_down: "data/backgrounds/search_bt.png"
            on_release:
                app.search_statistics_gene_table(gn_txt.text)
        TFTextInput:
            background_color: (1, 1, 1, 0)
            foreground_color: (.1, .1, .1, .51)
            hint_text: "Search alignments..."
            multiline: False
            id: gn_txt
            on_text_validate:
                app.search_statistics_gene_table(gn_txt.text)
        Button:
            size_hint_x: None
            width: 30
            border: 0,0,0,0
            background_normal: "data/backgrounds/clear_bt.png"
            background_down: "data/backgrounds/clear_bt.png"
            on_release:
                app.search_statistics_clear()

    Hseparator
    BoxLayout:
        size_hint_y: None
        height: 40
        TableCellTop:
            lbl: "Gene name"
            size_hint_x: .5
        Vseparator:
            thickness: 1.5
        TableCellTop:
            lbl: "N"
        Vseparator:
            thickness: 1.5
        TableCellTop:
            lbl: "Taxa"
        Vseparator:
            thickness: 1.5
        TableCellTop:
            lbl: "V"
        Vseparator:
            thickness: 1.5
        TableCellTop:
            lbl: "P"
        Vseparator:
            thickness: 1.5
        TableCellTop:
            lbl: "Gap"
        Vseparator:
            thickness: 1.5
        TableCellTop:
            lbl: "M"
    Hseparator

    ScrollView:
        bar_width: 10
        scroll_type: ["bars"]
        id: grid_sv
        GridLayout:
            cols: 1
            id: table_grid
            size_hint_y: None
            height: self.minimum_height

    Hseparator

    AnchorLayout:
        anchor_x: "center"
        anchor_y: "center"
        size_hint_y: None
        height: 40
        BoxLayout:
            size_hint: None, None
            size: 360, 40
            spacing: 20
            TFButton:
                size_hint: None, None
                size: 170, 30
                text: "Display overall table"
                bold: True
                on_release:
                    app.statistics_show_summary(True, "stats")
            TFButton:
                size_hint: None, None
                size: 170, 30
                text: "Export as table"
                bold: True
                on_release:
                    app.dialog_filechooser("export_table")

<StatsSummary>:
    orientation: "vertical"
    spacing: 10
    padding: 15
    Label:
        text: "Summary statistics overview"
        bold: True
        halign: "center"
        valign: "middle"
        text_size: self.size
        font_size: 20
        size_hint_y: None
        height: 30
        color: (0.216, 0.67, 0.784, 1)
    BoxLayout:
        orientation: "vertical"
        size_hint_y: None
        height: 110
        padding: 10
        id: bx1
        canvas.before:
            Color:
                rgba: (0.1, 0.1, 0.1, .5)
            Rectangle:
                pos: self.pos
                size: self.size
        StackLayout:
            canvas.after:
                Color:
                    rgb: (0.216, 0.67, 0.784, 1)
                Line:
                    width: 0.8
                    cap: "round"
                    joint: "round"
                    rectangle: bx1.x,bx1.y,bx1.width,bx1.height
        BoxLayout:
            size_hint_y: None
            height: 30
            Label:
                text: "General information"
                halign: "left"
                valign: "middle"
                text_size: self.size
                bold: True

        BoxLayout:
            size_hint_y: None
            height: 60
            BoxLayout:
                spacing: 10
                Vseparator:
                    thickness: 2
                BoxLayout:
                    orientation: "vertical"
                    DescriptionLabelLarge:
                        id: genes
                    DescriptionLabelSmall:
                        font_size: 14
                        text: "Genes"
            BoxLayout:
                spacing: 10
                Vseparator:
                    thickness: 2
                BoxLayout:
                    orientation: "vertical"
                    DescriptionLabelLarge:
                        id: taxa
                    DescriptionLabelSmall:
                        font_size: 14
                        text: "Taxa"
            BoxLayout:
                spacing: 10
                Vseparator:
                    thickness: 2
                BoxLayout:
                    orientation: "vertical"
                    DescriptionLabelLarge:
                        id: seq_len
                    DescriptionLabelSmall:
                        font_size: 14
                        text: "Total alignment length"

    BoxLayout:
        orientation: "vertical"
        size_hint_y: None
        height: 170
        padding: 10
        id: bx2
        canvas.before:
            Color:
                rgba: (0.1, 0.1, 0.1, .5)
            Rectangle:
                pos: self.pos
                size: self.size
        StackLayout:
            canvas.after:
                Color:
                    rgb: (0.216, 0.67, 0.784, 1)
                Line:
                    width: 0.8
                    cap: "round"
                    joint: "round"
                    rectangle: bx2.x,bx2.y,bx2.width,bx2.height
        BoxLayout:
            size_hint_y: None
            height: 30
            Label:
                text: "Missing data information"
                halign: "left"
                valign: "middle"
                text_size: self.size
                bold: True

        BoxLayout:
            size_hint_y: None
            spacing: 10
            height: 120
            orientation: "vertical"
            BoxLayout:
                BoxLayout:
                    spacing: 10
                    Vseparator:
                        thickness: 2
                    BoxLayout:
                        orientation: "vertical"
                        DescriptionLabelLarge:
                            id: gaps
                        DescriptionLabelSmall:
                            font_size: 14
                            text: "Gaps"
                BoxLayout:
                    spacing: 10
                    Vseparator:
                        thickness: 2
                    BoxLayout:
                        orientation: "vertical"
                        DescriptionLabelLarge:
                            id: missing
                        DescriptionLabelSmall:
                            font_size: 14
                            text: "Missing data"
            BoxLayout:
                BoxLayout:
                    spacing: 10
                    Vseparator:
                        thickness: 2
                    BoxLayout:
                        orientation: "vertical"
                        DescriptionLabelLarge:
                            id: avg_gaps
                        DescriptionLabelSmall:
                            font_size: 14
                            text: "Gaps per gene"
                BoxLayout:
                    spacing: 10
                    Vseparator:
                        thickness: 2
                    BoxLayout:
                        orientation: "vertical"
                        DescriptionLabelLarge:
                            id: avg_missing
                        DescriptionLabelSmall:
                            font_size: 14
                            text: "Missing data per gene"

    BoxLayout:
        orientation: "vertical"
        size_hint_y: None
        height: 170
        padding: 10
        id: bx3
        canvas.before:
            Color:
                rgba: (0.1, 0.1, 0.1, .5)
            Rectangle:
                pos: self.pos
                size: self.size
        StackLayout:
            canvas.after:
                Color:
                    rgb: (0.216, 0.67, 0.784, 1)
                Line:
                    width: 0.8
                    cap: "round"
                    joint: "round"
                    rectangle: bx3.x,bx3.y,bx3.width,bx3.height
        BoxLayout:
            size_hint_y: None
            height: 30
            Label:
                text: "Sequence variation information"
                halign: "left"
                valign: "middle"
                text_size: self.size
                bold: True

        BoxLayout:
            size_hint_y: None
            spacing: 10
            height: 120
            orientation: "vertical"
            BoxLayout:
                BoxLayout:
                    spacing: 10
                    Vseparator:
                        thickness: 2
                    BoxLayout:
                        orientation: "vertical"
                        DescriptionLabelLarge:
                            id: variable
                        DescriptionLabelSmall:
                            font_size: 14
                            text: "Variable sites"
                BoxLayout:
                    spacing: 10
                    Vseparator:
                        thickness: 2
                    BoxLayout:
                        orientation: "vertical"
                        DescriptionLabelLarge:
                            id: informative
                        DescriptionLabelSmall:
                            font_size: 14
                            text: "Informative sites"
            BoxLayout:
                BoxLayout:
                    spacing: 10
                    Vseparator:
                        thickness: 2
                    BoxLayout:
                        orientation: "vertical"
                        DescriptionLabelLarge:
                            id: avg_var
                        DescriptionLabelSmall:
                            font_size: 14
                            text: "Variable sites per gene"
                BoxLayout:
                    spacing: 10
                    Vseparator:
                        thickness: 2
                    BoxLayout:
                        orientation: "vertical"
                        DescriptionLabelLarge:
                            id: avg_inf
                        DescriptionLabelSmall:
                            font_size: 14
                            text: "Informative sites per gene"

    AnchorLayout:
        anchor_x: "center"
        anchor_y: "center"
        size_hint_y: None
        height: 60
        BoxLayout:
            size_hint: None, None
            size: 360, 60
            spacing: 20
            TFButton:
                size_hint: None, None
                size: 170, 30
                text: "Display gene table"
                bold: True
                on_release:
                    app.statistics_show_summary(True, "table")
            TFButton:
                size_hint: None, None
                size: 170, 30
                text: "Export as table"
                bold: True
                on_release:
                    app.dialog_filechooser("export_table")

    Widget


<NoDataLabel>:
    valign: "middle"
    halign: "center"
    text_size: self.size
    markup: True
    bold: True
    color: .7, .7, .7, .7
    text: "[size=34]No data to display[/size]\nPlease select an analysis from the left panel"


<StatsPlotToolbar>
    orientation: "vertical"
    size_hint: None, None
    pos: app.root.width - 50, (app.root.height / 2) - (self.height / 2)
    size: 50, 230
    opacity: .2
    canvas.before:
        Color:
            rgba: (.2,.2,.2,1)
        Rectangle:
            pos: self.pos
            size: self.size

    AnchorLayout:
        anchor_x: "center"
        anchor_y: "center"
        BoxLayout:
            orientation: "vertical"
            size_hint: None, None
            size: 40, 220
            spacing: 5
            id: content
            Button
                size_hint: None, None
                size: 40, 40
                border: 0,0,0,0
                background_normal: "data/backgrounds/zoom_in.png"
                background_down: "data/backgrounds/zoom_in_down.png"
                on_release:
                    app.screen.ids.plot_content.scale += .1
            Button
                size_hint: None, None
                size: 40, 40
                border: 0,0,0,0
                background_normal: "data/backgrounds/zoom_out.png"
                background_down: "data/backgrounds/zoom_out_down.png"
                on_release:
                    app.screen.ids.plot_content.scale -= .1 if app.screen.ids.plot_content.scale > 0.5 else 0
            Button:
                size_hint: None, None
                size: 40, 40
                border: 0,0,0,0
                background_normal: "data/backgrounds/fit_plot.png"
                background_down: "data/backgrounds/fit_plot_down.png"
                on_release:
                    app.screen.ids.plot_content.scale = 1
                    app.screen.ids.plot_content.pos = (0, 0)
            Button:
                size_hint: None, None
                size: 40, 40
                id: export_fig
                border: 0,0,0,0
                background_normal: "data/backgrounds/export_fig.png"
                background_down: "data/backgrounds/export_fig_down.png"
                background_disabled_normal: "data/backgrounds/export_fig_disabled.png"
                disabled: False if app.current_plot else True
                on_release:
                    app.dialog_filechooser("export_graphic")
            Button:
                size_hint: None, None
                size: 40, 40
                border: 0,0,0,0
                id: export_table
                background_normal: "data/backgrounds/export_table.png"
                background_down: "data/backgrounds/export_table_down.png"
                background_disabled_normal: "data/backgrounds/export_table_disabled.png"
                disabled: True if not app.current_table else False
                on_release:
                    app.dialog_filechooser("export_table")

<HelpButton@Button>:
    size_hint: None, None
    size: 30, 30
    border: 0,0,0,0
    id: info_seq_size
    background_normal: "data/backgrounds/info_bt_down.png"
    background_down: "data/backgrounds/info_bt.png"

<StatsBox>:
    size_hint_y: None
    height: 30
    spacing: 10

## General information
<SizeDistribution>:
    TFButtonOff:
        text: "Distribution of sequence size"
        on_release:
            app.stats_select_plot(None, "Distribution of sequence size", "Distribution of sequence size all")
    HelpButton:
        on_release:
            app.dialog_general_info("info_sequence_size")

<NucAAProportions>:
    TFButtonOff:
        text: "Proportion of nucleotides or residues"
        on_release:
            app.stats_select_plot("Proportion of nucleotides or residues gn", "Proportion of nucleotides or residues sp", "Proportion of nucleotides or residues")
    HelpButton:
        on_release:
            app.dialog_general_info("info_nucleotide_proportion")

## Polymorphism and Variation
<SequenceConservation>:
    TFButtonOff:
        text: "Sequence conservation"
        on_release:
            app.stats_select_plot("Sequence conservation gn", None, None)
    HelpButton:
        on_release:
            app.dialog_general_info("gene_conservation")

<SequenceSimilarity>:
    TFButtonOff:
        text: "Pairwise sequence similarity"
        on_release:
            app.stats_select_plot("Pairwise sequence similarity gn", "Pairwise sequence similarity sp", "Pairwise sequence similarity")
    HelpButton:
        on_release:
            app.dialog_general_info("pairwise_seq_similarity")

<SegregatingSites>:
    TFButtonOff:
        text: "Segregating sites"
        on_release:
            app.stats_select_plot("Segregating sites gn", "Segregating sites sp", "Segregating sites")
    HelpButton:
        on_release:
            app.dialog_general_info("segregating_sites")

<LVCorrelation>:
    TFButtonOff:
        text: "Alignment length/Polymorphism correlation"
        on_release:
            app.stats_show_plot(self.text)
    HelpButton:
        on_release:
            app.dialog_general_info("len_pol_correlation")

<TaxaDistribution>:
    TFButtonOff:
        text: "Distribution of taxa frequency"
        on_release:
            app.stats_show_plot(self.text)
    HelpButton:
        on_release:
            app.dialog_general_info("info_taxa_frequency")

<AFS>:
    TFButtonOff:
        text: "Allele Frequency Spectrum"
        on_release:
            if app.sequence_types == "DNA":\
            app.stats_select_plot("Allele Frequency Spectrum gn", None, "Allele Frequency Spectrum")
            else:\
            app.dialog_floatcheck("This option is only available for nucleotide sequences", t="error")
    HelpButton:
        on_release:
            app.dialog_general_info("afs")

## Missing data

<GeneOccupancy>:
    TFButtonOff:
        text: "Gene occupancy"
        on_release:
            app.stats_show_plot(self.text)
    HelpButton:
        on_release:
            app.dialog_general_info("gene_occupancy")


<MissingOrto>:
    TFButtonOff:
        text: "Distribution of missing taxa"
        on_release:
            app.stats_select_plot(None, "Distribution of missing orthologs", "Distribution of missing orthologs avg")
    HelpButton:
        on_release:
            app.dialog_general_info("missing_taxa")


<MissingData>:
    TFButtonOff:
        text: "Distribution of missing data"
        on_release:
            app.stats_select_plot(None, "Distribution of missing data sp", "Distribution of missing data")
    HelpButton:
        on_release:
            app.dialog_general_info("missing_data")

<CumulativeMissingOrto>:
    TFButtonOff:
        text: "Cumulative distribution of missing genes"
        on_release:
            app.stats_show_plot(self.text)
    HelpButton:
        on_release:
            app.dialog_general_info("cumulative_missing")

## Outlier detection

<OutlierMissing>:
    TFButtonOff:
        text: "Missing data outliers"
        on_release:
            app.stats_select_plot(None, "Missing data outliers sp", "Missing data outliers")
    HelpButton:
        on_release:
            app.dialog_general_info("outliers_missing")

<OutlierSegregating>:
    TFButtonOff:
        text: "Segregating sites outliers"
        on_release:
            app.stats_select_plot(None, "Segregating sites outliers sp", "Segregating sites outliers")
    HelpButton:
        on_release:
            app.dialog_general_info("outliers_segregating")

<OutlierSize>:
    TFButtonOff:
        text: "Sequence size outliers"
        on_release:
            app.stats_select_plot(None, "Sequence size outliers sp", "Sequence size outliers")
    HelpButton:
        on_release:
            app.dialog_general_info("outliers_size")

#===============================================================================
# ROOT SCREEN
#===============================================================================

FloatLayout:
    #__safe_id: [file_dd.__self__, taxa_dd.__self__]
    BoxLayout:
        orientation: "vertical"

        ActionBar:
            pos_hint: {'top':1}
            size_hint_y: None
            height: 50

            ActionView:
                id: av
                ActionPrevious:
                    size_hint: None, None
                    width: 0
                    with_previous: False
                    app_icon:"data/backgrounds/transparent.png"


                ActionButton:
                    id: ap
                    size_hint_x: None
                    width: 120
                    background_normal: "data/backgrounds/menu_bt.png"
                    background_down: "data/backgrounds/menu_bt.png"

                    on_release:
                        app.toggle_sidepanel()

                MainHeader:
                    id: h_ortho
                    text: "Orthology"
                    background_down: "data/backgrounds/orthology_down.png"
                    background_disabled_down: "data/backgrounds/orthology_down.png"
                    canvas.before:
                        Color:
                            rgba: [255, .200, .200, .3]
                        Rectangle:
                            pos: self.pos
                            size: self.size
                    on_release:
                        idx = app.screen_names.index("Orthology")
                        app.go_screen(idx)
                        app.toggle_groups(self)

                MainHeader:
                    id: h_process
                    text: "Process"
                    background_down: "data/backgrounds/process_down.png"
                    background_disabled_down: "data/backgrounds/process_down.png"
                    canvas.before:
                        Color:
                            rgba: (0.200, 0.200, 255, .3)
                        Rectangle:
                            pos: self.pos
                            size: self.size
                    on_release:
                        idx = app.screen_names.index("Process")
                        app.go_screen(idx)
                        app.toggle_groups(self)

                MainHeader:
                    id: h_stat
                    text: "Statistics"
                    background_down: "data/backgrounds/statistics_down.png"
                    background_disabled_down: "data/backgrounds/statistics_down.png"
                    canvas.before:
                        Color:
                            rgba: (0.200, 255, 0.200, .3)
                        Rectangle:
                            pos: self.pos
                            size: self.size
                    on_release:
                        idx = app.screen_names.index("Statistics")
                        app.go_screen(idx)
                        app.toggle_groups(self)

        BoxLayout:
            id: bx1
            orientation: "horizontal"

            # This BoxLayout will two ScrollView layouts.
            # The first will be the side column with several buttons that will
            # switch the content in the second scrollview layout
            # The second will be the main panel containing the important content
            FloatLayout:
                id: panel_float
                size_hint_x: None
                width: 0
                BoxLayout:
                    orientation: "horizontal"
                    id: main_box
                    size_hint_x: None
                    width: 0

                    # Both these ScrollView layouts are here because it is the only way
                    # that the children layouts' width will be truly 0. If a
                    # BoxLayout, Floatlayout, etc would be used, the contents would
                    # still appear.
                    ScrollView:
                        id: sp_bts
                        size_hint_x: None
                        width: 0
                        canvas.before:
                            Color:
                                rgba: tm.c_iner_side_panel_background
                            Rectangle:
                                pos: self.pos
                                size: self.size

                        BoxLayout:
                            id: side_bt
                            orientation: "vertical"
                            SideButton:
                                size_hint: (None, None)
                                height: 60
                                width: 60
                                text: " "
                                background_down: "data/backgrounds/side_bt_home_down.png"
                                background_normal: "data/backgrounds/side_bt_home.png"
                                background_disabled_down: "data/backgrounds/side_bt_home_down.png"
                                att: "Open/View Data"
                                state: "down"
                                disabled: True
                                on_release:
                                    carousel.load_slide(carousel.slides[0])
                                    app.toggle_groups(self)
                            SideButton:
                                size_hint: (None, None)
                                height: 60
                                width: 60
                                text: " "
                                background_down: "data/backgrounds/side_bt_group_down.png"
                                background_normal: "data/backgrounds/side_bt_group.png"
                                background_disabled_down: "data/backgrounds/side_bt_group_down.png"
                                att: "Dataset Groups"
                                on_release:
                                    carousel.load_slide(carousel.slides[1])
                                    app.toggle_groups(self)
                            SideButton:
                                size_hint: (None, None)
                                height: 60
                                width: 60
                                text: " "
                                background_down: "data/backgrounds/side_bt_project_down.png"
                                background_normal: "data/backgrounds/side_bt_project.png"
                                background_disabled_down: "data/backgrounds/side_bt_project_down.png"
                                att: "Project Management"
                                on_release:
                                    carousel.load_slide(carousel.slides[2])
                                    app.toggle_groups(self)
                            SideButton:
                                size_hint: (None, None)
                                height: 60
                                width: 60
                                text: " "
                                background_down: "data/backgrounds/side_bt_queue_down.png"
                                background_normal: "data/backgrounds/side_bt_queue.png"
                                background_disabled_down: "data/backgrounds/side_bt_queue_down.png"
                                id: queue
                                att: "Operations Queue"
                                on_release:
                                    app.save_operation_queue()
                                    carousel.load_slide(carousel.slides[3])
                                    app.toggle_groups(self)
                            Widget:
                            BoxLayout:
                                padding: 10
                                orientation: "vertical"
                                spacing: 10
                                Button:
                                    size_hint: None, None
                                    size: 40, 40
                                    border: 0,0,0,0
                                    background_down: "data/backgrounds/about_bt.png"
                                    background_normal: "data/backgrounds/about_bt.png"
                                    on_release:
                                        app.dialog_about()
                                Button:
                                    size_hint: None, None
                                    size: 40, 40
                                    border: 0,0,0,0
                                    background_down: "data/backgrounds/quit.png"
                                    background_normal: "data/backgrounds/quit.png"
                                    id: quit_bt_bar_file
                                    on_release:
                                        app.check_action(text="Are you sure you want to quit?", func=app._exit_clean)
                                        #app.stop()

                    BoxLayout:
                        id: sp
                        canvas:
                            Color:
                                rgba: tm.c_outer_side_panel_background
                            Rectangle:
                                pos: self.pos
                                size: self.size

                        Carousel:
                            id: carousel
                            direction: "bottom"
                            scroll_timeout: 0
                            BoxLayout:
                                orientation: "vertical"
                                padding: 10
                                spacing: 10
                                id: main_slide

                                BoxLayout:
                                    size_hint_y: None
                                    height: 50
                                    padding: (15,0,15, 0)
                                    Button:
                                        id: sv_but
                                        background_normal: "data/backgrounds/process_exec.png"
                                        background_down: "data/backgrounds/process_exec_down.png"
                                        text: "Open file(s)"
                                        bold: True
                                        border: 0,0,0,0
                                        font_size: 18
                                        on_release:
                                            idx = app.screen_names.index("fc")
                                            app.go_screen(idx)
                                            app.toggle_sidepanel()

                                TabbedPanel:
                                    id: main_tp
                                    do_default_tab: False
                                    background_color: (0,0,0,0)
                                    tab_pos: "top_mid"
                                    tab_width: 90

                                    TabbedPanelItem:
                                        id: file_tp
                                        text: "Files"

                                        BoxLayout:
                                            orientation: "vertical"
                                            spacing: 10
                                            Widget:
                                                size_hint_y: None
                                                height: 0
                                            BoxLayout:
                                                size_hint_y: None
                                                height: 30
                                                AnchorLayout:
                                                    BoxLayout:
                                                        size_hint_x: None
                                                        width: 200
                                                        canvas.before:
                                                            Color:
                                                                rgba: 0.8, 0.8, 0.8, 1
                                                            Rectangle:
                                                                pos: self.pos
                                                                size: self.size
                                                        Button:
                                                            size_hint_x: None
                                                            width: 30
                                                            border: 0,0,0,0
                                                            background_normal: "data/backgrounds/search_bt.png"
                                                            background_down: "data/backgrounds/search_bt.png"
                                                            on_release:
                                                                if file_search.text == "": \
                                                                app.sidepanel_clear_search("files")
                                                                else: \
                                                                app.sidepanel_search_bts(file_search.text, "files")
                                                        TFTextInput:
                                                            size_hint_x: None
                                                            width: 140
                                                            id: file_search
                                                            background_color: (1, 1, 1, 0)
                                                            foreground_color: (.1, .1, .1, .51)
                                                            hint_text: "Search files..."
                                                            multiline: False
                                                            on_text_validate:
                                                                if self.text == "": \
                                                                app.sidepanel_clear_search("files")
                                                                else: \
                                                                app.sidepanel_search_bts(self.text, "files")
                                                        Button:
                                                            size_hint_x: None
                                                            width: 30
                                                            border: 0,0,0,0
                                                            background_normal: "data/backgrounds/clear_bt.png"
                                                            background_down: "data/backgrounds/clear_bt.png"
                                                            on_release:
                                                                app.sidepanel_clear_search("files")
                                                                file_search.text = ""
                                            ScrollView:
                                                id: sv_file
                                                bar_width: 8
                                                scroll_type: ["bars"]
                                                GridLayout:
                                                    cols: 3
                                                    size_hint_y: None
                                                    id: file_sl
                                                    padding: (10, 0, 10, 0)
                                                    spacing: [10, 5]
                                                    height: sum([x.height + 5 for x in self.children if isinstance(x, ToggleButton) or isinstance(x, AnchorLayout)])

                                                    Button:
                                                        id: file_temp
                                                        height: 40
                                                        disabled: True
                                                        size_hint_y: None
                                                        #size_hint_x: None
                                                        text: "No files loaded"
                                            Label:
                                                id: file_lab
                                                size_hint_y: None
                                                height: 10
                                                color: (.6, .6, .6, 1)
                                            BoxLayout:
                                                id: bt_bar_file
                                                spacing: 5
                                                size_hint_y: None
                                                height: 35
                                                BoxLayout:
                                                    id: sb_file
                                                    spacing: 5
                                                    TFButton:
                                                        text: "Select All"
                                                        disabled: True if not app.filename_map and not app.proteome_files else False
                                                        background_normal: "data/backgrounds/bt_process_off.png"
                                                        background_down: "data/backgrounds/bt_process.png"
                                                        background_disabled_normal: "data/backgrounds/bt_process_off.png"
                                                        on_release:
                                                            app.select_bt(self)
                                                    TFButton:
                                                        text: "Deselect All"
                                                        disabled: True if not app.filename_map and not app.proteome_files else False
                                                        background_normal: "data/backgrounds/bt_process_off.png"
                                                        background_down: "data/backgrounds/bt_process.png"
                                                        background_disabled_normal: "data/backgrounds/bt_process_off.png"
                                                        on_release:
                                                            app.select_bt(self)
                                                TFButton:
                                                    id: file_opt
                                                    text: "+"
                                                    font_size: 30
                                                    bold: True
                                                    size_hint_x: None
                                                    width: 35
                                                    disabled: True if not app.filename_map and not app.proteome_files else False
                                                    background_normal: "data/backgrounds/bt_process_off.png"
                                                    background_down: "data/backgrounds/bt_process.png"
                                                    background_disabled_normal: "data/backgrounds/bt_process_disabled.png"
                                                    on_release:
                                                        app.sidepanel_moreopts_dialog(self)
                                                TFButton:
                                                    id: rm_all_File
                                                    size_hint_x: None
                                                    width: 35
                                                    line_clr: app._red
                                                    border: 0,0,0,0
                                                    disabled: True if not app.filename_map and not app.proteome_files else False
                                                    background_normal: "data/backgrounds/remove_all.png"
                                                    background_down: "data/backgrounds/remove_all_down.png"
                                                    background_disabled_normal: "data/backgrounds/remove_all_disabled.png"
                                                    on_release:
                                                        app.check_action(text="Are you sure you want to remove all files and taxa?", func=app.remove_all)

                                    TabbedPanelItem:
                                        id: taxa_tp
                                        text: "Taxa"
                                        BoxLayout:
                                            orientation: "vertical"
                                            spacing: 10
                                            Widget:
                                                size_hint_y: None
                                                height: 0
                                            BoxLayout:
                                                size_hint_y: None
                                                height: 30
                                                AnchorLayout:
                                                    BoxLayout:
                                                        size_hint_x: None
                                                        width: 200
                                                        canvas.before:
                                                            Color:
                                                                rgba: 0.8, 0.8, 0.8, 1
                                                            Rectangle:
                                                                pos: self.pos
                                                                size: self.size
                                                        Button:
                                                            size_hint_x: None
                                                            width: 30
                                                            border: 0,0,0,0
                                                            background_normal: "data/backgrounds/search_bt.png"
                                                            background_down: "data/backgrounds/search_bt.png"
                                                            on_release:
                                                                if taxa_search.text == "": \
                                                                app.sidepanel_clear_search("taxa")
                                                                else: \
                                                                app.sidepanel_search_bts(taxa_search.text, "taxa")
                                                        TFTextInput:
                                                            size_hint_x: None
                                                            width: 140
                                                            id: taxa_search
                                                            background_color: (1, 1, 1, 0)
                                                            foreground_color: (.1, .1, .1, .51)
                                                            hint_text: "Search taxa..."
                                                            multiline: False
                                                            on_text_validate:
                                                                if self.text == "": \
                                                                app.sidepanel_clear_search("taxa")
                                                                else: \
                                                                app.sidepanel_search_bts(self.text, "taxa")
                                                        Button:
                                                            size_hint_x: None
                                                            width: 30
                                                            border: 0,0,0,0
                                                            background_normal: "data/backgrounds/clear_bt.png"
                                                            background_down: "data/backgrounds/clear_bt.png"
                                                            on_release:
                                                                app.sidepanel_clear_search("taxa")
                                                                taxa_search.text = ""
                                            ScrollView:
                                                id: sv_sp
                                                bar_width: 8
                                                scroll_type: ["bars"]
                                                GridLayout:
                                                    cols: 3
                                                    size_hint_y: None
                                                    id: taxa_sl
                                                    padding: (10, 0, 10, 0)
                                                    spacing: [10, 5]
                                                    height: sum([x.height + 5 for x in self.children if isinstance(x, ToggleButton) or isinstance(x, AnchorLayout)])
                                                    Button:
                                                        id: species_temp
                                                        height: 40
                                                        disabled: True
                                                        size_hint_y: None
                                                        text: "No files loaded"
                                            Label:
                                                id: sp_lab
                                                size_hint_y: None
                                                height: 10
                                                color: (.6, .6, .6, 1)
                                            BoxLayout:
                                                spacing: 5
                                                size_hint_y: None
                                                height: 35
                                                BoxLayout:
                                                    id: sb_taxa
                                                    spacing: 5
                                                    TFButton:
                                                        text: "Select All"
                                                        disabled: True if not app.filename_map else False
                                                        background_normal: "data/backgrounds/bt_process_off.png"
                                                        background_down: "data/backgrounds/bt_process.png"
                                                        background_disabled_normal: "data/backgrounds/bt_process_off.png"
                                                        on_release:
                                                            app.select_bt(self)
                                                    TFButton:
                                                        text: "Deselect All"
                                                        disabled: True if not app.filename_map else False
                                                        background_normal: "data/backgrounds/bt_process_off.png"
                                                        background_down: "data/backgrounds/bt_process.png"
                                                        background_disabled_normal: "data/backgrounds/bt_process_off.png"
                                                        on_release:
                                                            app.select_bt(self)
                                                TFButton:
                                                    id: taxa_opt
                                                    text: "+"
                                                    font_size: 30
                                                    bold: True
                                                    size_hint_x: None
                                                    width: 35
                                                    disabled: True if not app.filename_map else False
                                                    background_normal: "data/backgrounds/bt_process_off.png"
                                                    background_down: "data/backgrounds/bt_process.png"
                                                    background_disabled_normal: "data/backgrounds/bt_process_off.png"
                                                    on_release:
                                                        app.sidepanel_moreopts_dialog(self)
                                                TFButton:
                                                    id: rm_all_Taxa
                                                    size_hint_x: None
                                                    width: 35
                                                    line_clr: app._red
                                                    border: 0, 0, 0, 0
                                                    disabled: True if not app.filename_map else False
                                                    background_normal: "data/backgrounds/remove_all.png"
                                                    background_down: "data/backgrounds/remove_all_down.png"
                                                    background_disabled_normal: "data/backgrounds/remove_all_disabled.png"
                                                    on_release:
                                                        app.check_action("Are you sure you want to remove all files and taxa?", app.remove_all)

                                    TabbedPanelItem:
                                        id: partitions_tp
                                        text: "Partitions"

                                        BoxLayout:
                                            orientation: "vertical"
                                            spacing: 10
                                            Widget:
                                                size_hint_y: None
                                                height: 0
                                            BoxLayout:
                                                size_hint_y: None
                                                height: 30
                                                AnchorLayout:
                                                    BoxLayout:
                                                        size_hint_x: None
                                                        width: 200
                                                        canvas.before:
                                                            Color:
                                                                rgba: 0.8, 0.8, 0.8, 1
                                                            Rectangle:
                                                                pos: self.pos
                                                                size: self.size
                                                        Button:
                                                            size_hint_x: None
                                                            width: 30
                                                            border: 0,0,0,0
                                                            background_normal: "data/backgrounds/search_bt.png"
                                                            background_down: "data/backgrounds/search_bt.png"
                                                            on_release:
                                                                if partition_search.text == "": \
                                                                app.sidepanel_clear_search("partitions")
                                                                else: \
                                                                app.sidepanel_search_bts(partition_search.text, "partitions")

                                                        TFTextInput:
                                                            size_hint_x: None
                                                            width: 140
                                                            id: partition_search
                                                            background_color: (1, 1, 1, 0)
                                                            foreground_color: (.1, .1, .1, .51)
                                                            hint_text: "Search partitions..."
                                                            multiline: False
                                                            on_text_validate:
                                                                if self.text == "": \
                                                                app.sidepanel_clear_search("partitions")
                                                                else: \
                                                                app.sidepanel_search_bts(self.text, "partitions")

                                                        Button:
                                                            size_hint_x: None
                                                            width: 30
                                                            border: 0,0,0,0
                                                            background_normal: "data/backgrounds/clear_bt.png"
                                                            background_down: "data/backgrounds/clear_bt.png"
                                                            on_release:
                                                            on_release:
                                                                app.sidepanel_clear_search("partitions")
                                                                partition_search.text = ""

                                            ScrollView:
                                                id: sv_partition
                                                bar_width: 8
                                                scroll_type: ["bars"]
                                                GridLayout:
                                                    cols: 3
                                                    size_hint_y: None
                                                    id: partition_sl
                                                    padding: (10, 0, 10, 0)
                                                    spacing: [10, 5]
                                                    height: sum([x.height + 5 for x in self.children if isinstance(x, ToggleButton) or isinstance(x, AnchorLayout)])

                                                    Button:
                                                        id: partition_temp
                                                        height: 40
                                                        disabled: True
                                                        size_hint_y: None
                                                        text: "No partitions loaded"
                                            Label:
                                                id: partition_lab
                                                size_hint_y: None
                                                height: 10
                                                color: (.6, .6, .6, 1)
                                            BoxLayout:
                                                id: bt_bar_partition
                                                spacing: 5
                                                size_hint_y: None
                                                height: 35
                                                BoxLayout:
                                                    id: sb_partition
                                                    spacing: 5
                                                    TFButton:
                                                        text: "Select All"
                                                        #font_size: 13
                                                        disabled: True if not app.filename_map else False
                                                        background_normal: "data/backgrounds/bt_process_off.png"
                                                        background_down: "data/backgrounds/bt_process.png"
                                                        background_disabled_normal: "data/backgrounds/bt_process_off.png"
                                                        on_release:
                                                            app.select_bt(self)
                                                    TFButton:
                                                        text: "Deselect All"
                                                        #font_size: 13
                                                        disabled: True if not app.filename_map else False
                                                        background_normal: "data/backgrounds/bt_process_off.png"
                                                        background_down: "data/backgrounds/bt_process.png"
                                                        background_disabled_normal: "data/backgrounds/bt_process_off.png"
                                                        on_release:
                                                            app.select_bt(self)
                                                    TFButton:
                                                        id: merge_part
                                                        disabled: True if len(app.active_partitions) <= 1 else False
                                                        size_hint_x: None
                                                        width: 35
                                                        border: 0,0,0,0
                                                        background_normal: "data/backgrounds/group_bt.png"
                                                        background_down: "data/backgrounds/group_bt_down.png"
                                                        background_disabled_normal: "data/backgrounds/group_bt_disabled.png"
                                                        on_release:
                                                            app.partitions_merge_dialog()
                                                    TFButton:
                                                        disabled: False if len(app.active_partitions) == 1 else True
                                                        id: split_part
                                                        size_hint_x: None
                                                        width: 35
                                                        border: 0,0,0,0
                                                        background_normal: "data/backgrounds/split_bt.png"
                                                        background_down: "data/backgrounds/split_bt_down.png"
                                                        background_disabled_normal: "data/backgrounds/split_bt_disabled.png"
                                                        on_release:
                                                            app.dialog_partitions_split()
                                                    TFButton:
                                                        disabled: True if not app.filename_map else False
                                                        id: add_part
                                                        size_hint_x: None
                                                        width: 35
                                                        border: 0,0,0,0
                                                        background_normal: "data/backgrounds/add_bt35.png"
                                                        background_down: "data/backgrounds/add_bt35_down.png"
                                                        background_disabled_normal: "data/backgrounds/add_bt35_disabled.png"
                                                        on_release:
                                                            app.dialog_import_partitions()

                            BoxLayout:
                                orientation: "vertical"
                                padding: 10
                                spacing: 5
                                Label:
                                    size_hint_y: None
                                    height: 50
                                    text: "Dataset groups"
                                    font_size: 18
                                    halign: "center"
                                    valign: "middle"
                                    text_size: self.size
                                    bold: True
                                    canvas.before:
                                        Color:
                                            rgba: tm.c_side_panel_headers
                                        Rectangle:
                                            pos: self.pos
                                            size: self.size

                                Hseparator:
                                    c: tm.c_side_panel_headers

                                TabbedPanel:
                                    id: dataset_tp
                                    do_default_tab: False
                                    background_color: (0,0,0,0)
                                    tab_pos: "top_mid"

                                    TabbedPanelItem:
                                        id: file_ds_tp
                                        text: "Files"
                                        BoxLayout:
                                            orientation: "vertical"
                                            spacing: 20
                                            ScrollView:
                                                size_hint_y: .8
                                                bar_width: 10
                                                scroll_type: ["bars"]
                                                GridLayout:
                                                    id: file_group_grid
                                                    ds: "files"
                                                    size_hint_y: None
                                                    height: self.minimum_height
                                                    padding: [5, 5, 12, 5]
                                                    spacing: 5
                                                    cols: 2

                                            BoxLayout:
                                                size_hint_y: None
                                                height: 40
                                                padding: (50, 0, 50, 0)
                                                Button:
                                                    bold: True
                                                    text: "Set new file group"
                                                    id: file_group_bt
                                                    disabled: True if not app.filename_map else False
                                                    background_normal: "data/backgrounds/bt_process.png"
                                                    background_down: "data/backgrounds/bt_process_off.png"
                                                    on_release:
                                                        app.dialog_dataset_creator("files")

                                    TabbedPanelItem:
                                        id: taxa_ds_tp
                                        text: "Taxa"

                                        BoxLayout:
                                            orientation: "vertical"
                                            spacing: 20
                                            ScrollView:
                                                size_hint_y: .8
                                                bar_width: 10
                                                scroll_type: ["bars"]
                                                GridLayout:
                                                    id: taxa_group_grid
                                                    ds: "taxa"
                                                    size_hint_y: None
                                                    height: self.minimum_height
                                                    padding: [5, 5, 12, 5]
                                                    spacing: 5
                                                    cols: 2

                                            BoxLayout:
                                                size_hint_y: None
                                                height: 40
                                                padding: (50, 0, 50, 0)
                                                Button:
                                                    bold: True
                                                    text: "Set new taxa group"
                                                    id: tx_group_bt
                                                    disabled: True if not app.filename_map else False
                                                    background_normal: "data/backgrounds/bt_process.png"
                                                    background_down: "data/backgrounds/bt_process_off.png"
                                                    on_release:
                                                        app.dialog_dataset_creator("taxa")

                            BoxLayout:
                                orientation: "vertical"
                                padding: 10
                                spacing: 5
                                Label:
                                    size_hint_y: None
                                    height: 50
                                    text: "Project Management"
                                    font_size: 18
                                    halign: "center"
                                    valign: "middle"
                                    text_size: self.size
                                    bold: True
                                    canvas.before:
                                        Color:
                                            rgba: tm.c_side_panel_headers
                                        Rectangle:
                                            pos: self.pos
                                            size: self.size
                                Hseparator:
                                    c: tm.c_side_panel_headers

                                BoxLayout:
                                    size_hint_y: None
                                    height: 45
                                    padding: 5

                                    ProjectOrtoBt

                                    Label:
                                        bold: True
                                        font_size: 12
                                        text: "Orthology project"

                                    ProjectProcBt

                                    Label:
                                        bold: True
                                        font_size: 12
                                        text: "Process project"

                                Hseparator:
                                    c: tm.c_side_panel_headers

                                ScrollView:
                                    bar_width: 10
                                    scroll_type: ["bars"]
                                    GridLayout:
                                        cols: 3
                                        padding: [5, 5, 12, 5]
                                        spacing: 5, 5
                                        id: project_grid
                                        size_hint_y: None
                                        height: self.minimum_height
                                        Button:
                                            text: "No Saved Projects"
                                            bold: True
                                            disabled: True
                                            size_hint_y: None
                                            height: 35

                                Button:
                                    size_hint_y: None
                                    height: 40
                                    text: "Save current project"
                                    bold: True
                                    disabled: True if not app.filename_map else False
                                    background_normal: "data/backgrounds/bt_process.png"
                                    background_down: "data/backgrounds/bt_process_off.png"
                                    on_release:
                                        app.dialog_text("Project name", "project")

                            BoxLayout:
                                orientation: "vertical"
                                padding: 10
                                spacing: 5
                                Label:
                                    size_hint_y: None
                                    height: 50
                                    text: "Operations queue"
                                    font_size: 18
                                    halign: "center"
                                    valign: "middle"
                                    text_size: self.size
                                    bold: True
                                    canvas.before:
                                        Color:
                                            rgba: tm.c_side_panel_headers
                                        Rectangle:
                                            pos: self.pos
                                            size: self.size
                                Hseparator:
                                    c: tm.c_side_panel_headers
                                ScrollView:
                                    size_hint_y: .8
                                    id: op_sv
                                Widget:
                                    size_hint_y: .1

                    Vseparator:
                        margin: -1
                        offset: [0,0]
                        thickness: 2
                        c: app._blue
                        opacity: 1 if app.show_side_panel else 0

            ScreenManager:
                id: sm
